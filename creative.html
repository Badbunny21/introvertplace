<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Creative - Introvert Place</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-black: #000000;
      --bg-gray-900: #111827;
      --bg-gray-800: #1f2937;
      --text-white: #ffffff;
      --text-gray-400: #9ca3af;
      --text-gray-500: #6b7280;
      --border-white-10: rgba(255,255,255,0.1);
      --border-white-20: rgba(255,255,255,0.2);
      --border-white-40: rgba(255,255,255,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

    body {
      font-family: 'Inter', sans-serif;
      font-weight: 300;
      background: linear-gradient(135deg, var(--bg-black) 0%, var(--bg-gray-900) 100%);
      color: var(--text-white);
      min-height: 100vh;
      letter-spacing: 0.025em;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    h1, h2, h3, h4 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      letter-spacing: 0.05em;
    }

    /* Glass Card */
    .glass-card {
      background: rgba(31,41,55,0.4);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-white-10);
      border-radius: 16px;
      transition: all 0.5s ease;
    }

    .glass-card:hover { border-color: var(--border-white-20); }

    /* ==================== */
    /* PAGES - Only one visible at a time */
    /* ==================== */
    .page {
      display: none !important;
      min-height: 100vh;
    }
    .page.active {
      display: block !important;
    }
    .wizard-page.active {
      display: flex !important;
    }

    /* ==================== */
    /* WIZARD PAGE */
    /* ==================== */
    .wizard-page {
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .wizard-container {
      width: 100%;
      max-width: 800px;
      text-align: center;
    }

    .wizard-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .wizard-header h1 {
      font-size: 42px;
      margin-bottom: 16px;
    }

    .wizard-header p {
      font-size: 18px;
      color: var(--text-gray-400);
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.7;
    }

    /* Progress Dots */
    .progress-dots {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 48px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.5s ease;
    }

    .dot.active {
      background: var(--text-white);
      box-shadow: 0 0 20px rgba(255,255,255,0.6);
    }

    .dot.done { background: var(--text-white); }

    /* Steps */
    .step { display: none; animation: fadeIn 0.5s ease; width: 100%; }
    .step.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
      text-align: center;
      font-size: 32px;
      margin-bottom: 12px;
    }

    .step-subtitle {
      text-align: center;
      font-size: 16px;
      color: var(--text-gray-500);
      margin-bottom: 48px;
    }

    /* Mode Cards */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      width: 100%;
    }

    .mode-card {
      padding: 36px;
      cursor: pointer;
      position: relative;
      text-align: center;
    }

    .mode-card.selected {
      border-color: var(--border-white-40);
      background: rgba(255,255,255,0.05);
    }

    .mode-card.selected::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: white;
      box-shadow: 0 0 20px rgba(255,255,255,0.8);
    }

    .mode-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 16px;
    }

    .mode-card h3 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .mode-card p {
      font-size: 14px;
      color: var(--text-gray-500);
      line-height: 1.6;
    }

    /* Options */
    .options-group {
      margin-bottom: 32px;
      text-align: center;
    }

    .options-label {
      font-size: 16px;
      color: var(--text-gray-400);
      margin-bottom: 16px;
      text-align: center;
    }

    .options-list {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .option {
      padding: 14px 24px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-gray-400);
    }

    .option:hover { color: var(--text-white); }

    .option.selected {
      border-color: var(--border-white-40);
      color: var(--text-white);
      background: rgba(255,255,255,0.05);
    }

    /* Preview Card */
    .preview-card {
      padding: 60px;
      text-align: center;
    }

    .preview-icon {
      font-size: 72px;
      display: block;
      margin-bottom: 24px;
    }

    .preview-card h3 {
      font-size: 32px;
      margin-bottom: 16px;
    }

    .preview-card p {
      font-size: 16px;
      color: var(--text-gray-500);
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.7;
    }

    /* Navigation */
    .wizard-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 48px;
      padding-top: 32px;
      border-top: 1px solid var(--border-white-10);
    }

    .skip-btn {
      background: none;
      border: none;
      color: var(--text-gray-500);
      font-size: 14px;
      cursor: pointer;
    }

    .skip-btn:hover { color: var(--text-gray-400); }

    .nav-btns { display: flex; gap: 16px; }

    .btn {
      padding: 16px 36px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border-white-20);
      color: var(--text-gray-400);
    }

    .btn-secondary:hover {
      border-color: var(--border-white-40);
      color: var(--text-white);
    }

    .btn-primary {
      background: var(--text-white);
      border: none;
      color: var(--bg-black);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 0 30px rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(0,0,0,0.4);
      cursor: not-allowed;
    }

    /* ==================== */
    /* CREATIVE SPACE PAGE */
    /* ==================== */
    .creative-page { position: relative; }
    .creative-page.interior-open .header { display: none; }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .mode-tabs {
      display: flex;
      gap: 8px;
    }

    .mode-tab {
      padding: 10px 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-white-10);
      border-radius: 8px;
      color: var(--text-gray-400);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-tab:hover { color: var(--text-white); }
    .mode-tab.active {
      background: rgba(255,255,255,0.1);
      border-color: var(--border-white-40);
      color: var(--text-white);
    }

    .create-btn {
      padding: 12px 24px;
      background: white;
      border: none;
      border-radius: 8px;
      color: black;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .create-btn:hover {
      box-shadow: 0 0 30px rgba(255,255,255,0.3);
    }

    .settings-btn {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-white-10);
      border-radius: 10px;
      color: var(--text-gray-400);
      font-size: 18px;
      cursor: pointer;
    }

    .settings-btn:hover { color: white; }

    /* Constellation View */
    .constellation {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 40%, #080c1a 0%, #030508 60%, #000 100%);
      display: none;
      overflow: hidden;
    }
    .creative-page.active .constellation.active {
      display: block;
      position: fixed;
      z-index: 10;
    }
    /* Nebula clouds */
    .const-nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(90px);
      pointer-events: none;
      z-index: 0;
    }
    /* SVG lines */
    .const-lines-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }
    /* Parallax layer */
    .const-parallax {
      position: absolute;
      inset: -5%;
      width: 110%;
      height: 110%;
      pointer-events: none;
      z-index: 1;
      transition: transform 0.15s ease-out;
    }
    /* Background stars */
    .star {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.7);
      animation: twinkle var(--td,4s) ease-in-out infinite;
      animation-delay: var(--dl,0s);
    }
    .star.sm { width: 1px; height: 1px; }
    .star.md { width: 2px; height: 2px; background: rgba(255,255,255,0.9); }
    .star.lg { width: 3px; height: 3px; background: white; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
    @keyframes twinkle {
      0%,100% { opacity:0.5; transform:scale(1); }
      50% { opacity:1; transform:scale(1.5); }
    }
    /* Constellation Empty State */
    .constellation-empty-state {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 48px;
      background: rgba(8,12,26,0.85);
      border: 2px dashed rgba(255,255,255,0.12);
      border-radius: 24px;
      backdrop-filter: blur(12px);
      z-index: 20;
    }
    .constellation-empty-state .constellation-empty-icon { font-size: 64px; margin-bottom: 20px; }
    .constellation-empty-state h3 { font-size: 24px; margin-bottom: 12px; color: #f0eeeb; }
    .constellation-empty-state p { font-size: 15px; color: #9ca3af; max-width: 350px; margin: 0 auto 24px; line-height: 1.6; }
    .constellation-empty-btn {
      padding: 14px 28px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      color: #f0eeeb;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .constellation-empty-btn:hover { background: rgba(255,255,255,0.14); transform: translateY(-2px); }
    /* User center star */
    .user-center-star {
      position: absolute;
      z-index: 10;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }
    .user-star-core {
      width: 52px; height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,240,160,0.95) 0%, rgba(255,200,60,0.5) 55%, transparent 100%);
      box-shadow: 0 0 18px rgba(255,220,80,0.9), 0 0 50px rgba(255,200,40,0.35);
      margin: 0 auto 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      animation: user-pulse 3.5s ease-in-out infinite;
      position: relative;
    }
    .user-star-ring {
      position: absolute; inset: -10px; border-radius: 50%;
      border: 1px solid rgba(255,220,80,0.25);
      animation: ring-pulse 3.5s ease-in-out infinite;
    }
    .user-star-ring-2 {
      position: absolute; inset: -22px; border-radius: 50%;
      border: 1px solid rgba(255,220,80,0.12);
      animation: ring-pulse 3.5s ease-in-out infinite 0.6s;
    }
    @keyframes user-pulse {
      0%,100% { box-shadow: 0 0 18px rgba(255,220,80,0.9), 0 0 50px rgba(255,200,40,0.35); }
      50% { box-shadow: 0 0 28px rgba(255,220,80,1), 0 0 70px rgba(255,200,40,0.55); }
    }
    @keyframes ring-pulse {
      0%,100% { opacity:0.4; transform:scale(1); }
      50% { opacity:0.7; transform:scale(1.06); }
    }
    .user-star-label {
      font-size: 11px; color: rgba(255,240,160,0.65); letter-spacing: 0.08em;
    }
    /* Cluster labels */
    .cluster-label {
      position: absolute;
      font-size: 9px;
      color: rgba(255,255,255,0.18);
      text-transform: uppercase;
      letter-spacing: 0.18em;
      pointer-events: none;
      z-index: 3;
      transform: translate(-50%, -50%);
    }
    /* Creation node */
    .creation-node {
      position: absolute;
      cursor: pointer;
      text-align: center;
      z-index: 5;
      transform: translate(-50%, -50%);
      transition: transform 0.25s ease;
    }
    .creation-node:hover { transform: translate(-50%, -50%) scale(1.18); }
    .node-orb {
      width: 44px; height: 44px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      margin: 0 auto 6px;
      border: 1px solid transparent;
      transition: all 0.3s;
      position: relative;
    }
    .node-orb::after {
      content:'';
      position:absolute; inset:-5px; border-radius:50%;
      border:1px solid currentColor;
      opacity:0; transition:opacity 0.3s;
    }
    .creation-node:hover .node-orb::after { opacity:0.25; }
    .node-orb.type-writing { background:rgba(196,161,255,0.12); border-color:rgba(196,161,255,0.3); color:#c4a1ff; box-shadow:0 0 10px rgba(196,161,255,0.18); }
    .node-orb.type-visual  { background:rgba(124,184,232,0.12); border-color:rgba(124,184,232,0.3); color:#7cb8e8; box-shadow:0 0 10px rgba(124,184,232,0.18); }
    .node-orb.type-music   { background:rgba(124,232,168,0.12); border-color:rgba(124,232,168,0.3); color:#7ce8a8; box-shadow:0 0 10px rgba(124,232,168,0.18); }
    .node-orb.type-idea    { background:rgba(232,200,124,0.12); border-color:rgba(232,200,124,0.3); color:#e8c87c; box-shadow:0 0 10px rgba(232,200,124,0.18); }
    .creation-node:hover .node-orb.type-writing { box-shadow:0 0 22px rgba(196,161,255,0.5); }
    .creation-node:hover .node-orb.type-visual  { box-shadow:0 0 22px rgba(124,184,232,0.5); }
    .creation-node:hover .node-orb.type-music   { box-shadow:0 0 22px rgba(124,232,168,0.5); }
    .creation-node:hover .node-orb.type-idea    { box-shadow:0 0 22px rgba(232,200,124,0.5); }
    .node-label {
      font-size: 10px; color: rgba(255,255,255,0.35);
      max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      transition: color 0.2s;
    }
    .creation-node:hover .node-label { color: rgba(255,255,255,0.75); }
    /* Star info card */
    .star-info-card {
      position: fixed;
      z-index: 300;
      background: rgba(6,9,20,0.95);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 16px;
      padding: 16px;
      width: 210px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      transform: translateY(8px) scale(0.97);
    }
    .star-info-card.visible {
      opacity: 1; pointer-events: all;
      transform: translateY(0) scale(1);
    }
    .star-info-type { font-size: 9px; color: rgba(255,255,255,0.28); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 5px; }
    .star-info-title { font-size: 14px; color: #f0eeeb; font-weight: 600; margin-bottom: 5px; line-height: 1.3; }
    .star-info-snippet { font-size: 12px; color: rgba(255,255,255,0.38); line-height: 1.5; margin-bottom: 12px; max-height: 40px; overflow: hidden; }
    .star-info-actions { display: flex; gap: 7px; }
    .star-info-btn {
      flex:1; padding: 7px 8px; border-radius: 8px; font-size: 11px;
      cursor: pointer; border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.5);
      transition: all 0.2s;
    }
    .star-info-btn:hover { background: rgba(255,255,255,0.09); color: #f0eeeb; }
    .star-info-btn.danger:hover { background: rgba(255,70,70,0.08); border-color: rgba(255,70,70,0.25); color: #ff7070; }
    .star-info-close { position:absolute; top:9px; right:9px; background:none; border:none; color:rgba(255,255,255,0.25); cursor:pointer; font-size:15px; line-height:1; padding:2px; }
    /* Distant galaxy (other users) */
    .distant-galaxy {
      position: absolute;
      cursor: pointer;
      z-index: 6;
      transform: translate(-50%, -50%);
      text-align: center;
      transition: transform 0.3s ease;
    }
    .distant-galaxy:hover { transform: translate(-50%, -50%) scale(1.12); }
    .distant-galaxy-core {
      position: relative;
      width: 52px; height: 52px;
      margin: 0 auto 6px;
    }
    .distant-galaxy-ring {
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      border: 1px dashed rgba(196,161,255,0.18);
      animation: galaxyRingSpin 18s linear infinite;
    }
    @keyframes galaxyRingSpin { to { transform: rotate(360deg); } }
    .distant-galaxy-mini-star {
      position: absolute;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: miniStarTwinkle 3s ease-in-out infinite alternate;
    }
    @keyframes miniStarTwinkle {
      from { opacity: 0.5; transform: translate(-50%,-50%) scale(1); }
      to   { opacity: 1;   transform: translate(-50%,-50%) scale(1.2); }
    }
    .distant-galaxy-center {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      width: 12px; height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(196,161,255,0.9), rgba(124,184,232,0.5));
      box-shadow: 0 0 14px rgba(196,161,255,0.5), 0 0 28px rgba(196,161,255,0.18);
    }
    .distant-galaxy-label {
      font-size: 10px;
      color: rgba(255,255,255,0.42);
      letter-spacing: 0.07em;
      white-space: nowrap;
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .distant-galaxy-count {
      font-size: 9px;
      color: rgba(196,161,255,0.45);
      margin-top: 2px;
    }
    /* User galaxy modal */
    .user-galaxy-modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 600;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .user-galaxy-modal-overlay.visible { opacity: 1; pointer-events: all; }
    .user-galaxy-modal {
      position: relative;
      width: min(90vw, 520px);
      max-height: 70vh;
      background: rgba(6,9,20,0.97);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 22px;
      padding: 26px 22px 22px;
      backdrop-filter: blur(30px);
      box-shadow: 0 20px 80px rgba(0,0,0,0.8);
      overflow-y: auto;
      transform: translateY(16px) scale(0.97);
      transition: transform 0.25s;
    }
    .user-galaxy-modal-overlay.visible .user-galaxy-modal { transform: translateY(0) scale(1); }
    .user-galaxy-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .user-galaxy-modal-title {
      font-size: 15px; color: #f0eeeb; font-weight: 600;
    }
    .user-galaxy-modal-subtitle {
      font-size: 11px; color: rgba(196,161,255,0.6); margin-top: 2px;
    }
    .user-galaxy-modal-close {
      background: none; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px; color: rgba(255,255,255,0.35);
      cursor: pointer; font-size: 14px; width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .user-galaxy-modal-close:hover { background: rgba(255,255,255,0.06); color: #f0eeeb; }
    .user-galaxy-creation-list { display: flex; flex-direction: column; gap: 10px; }
    .user-galaxy-creation-item {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      transition: background 0.2s;
    }
    .user-galaxy-creation-item:hover { background: rgba(255,255,255,0.05); }
    .ugci-icon {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; flex-shrink: 0;
    }
    .ugci-icon.type-writing { background: rgba(196,161,255,0.14); }
    .ugci-icon.type-visual  { background: rgba(124,184,232,0.14); }
    .ugci-icon.type-music   { background: rgba(124,232,168,0.14); }
    .ugci-icon.type-idea    { background: rgba(232,200,124,0.14); }
    .ugci-title { font-size: 13px; color: rgba(255,255,255,0.82); font-weight: 500; line-height: 1.3; }
    .ugci-snippet { font-size: 11px; color: rgba(255,255,255,0.32); margin-top: 3px; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .ugci-type { font-size: 9px; color: rgba(255,255,255,0.22); text-transform: uppercase; letter-spacing: 0.12em; margin-top: 4px; }
    /* Constellation controls */
    .const-controls {
      position: fixed;
      bottom: 110px; right: 16px;
      z-index: 50;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    .const-controls.visible { display: flex; }
    .const-control-btn {
      width: 38px; height: 38px;
      border-radius: 11px;
      background: rgba(6,9,20,0.82);
      border: 1px solid rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.38);
      font-size: 15px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    .const-control-btn:hover, .const-control-btn.active {
      background: rgba(196,161,255,0.1); border-color: rgba(196,161,255,0.3); color: #c4a1ff;
    }

    .hint {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: rgba(31,41,55,0.6);
      border: 1px solid var(--border-white-10);
      border-radius: 24px;
      font-size: 13px;
      color: var(--text-gray-500);
      backdrop-filter: blur(8px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .mode-grid { grid-template-columns: 1fr; }
      .wizard-header h1 { font-size: 32px; }
      .options-list { flex-direction: column; }
      .mode-tabs { display: none; }
      .rooms-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .wizard-page { padding: 24px 16px; }
    }
    @media (max-width: 380px) {
      .wizard-header h1 { font-size: 26px; }
      .wizard-page { padding: 20px 12px; }
    }

    /* ==================== */
    /* INFINITE CANVAS VIEW */
    /* ==================== */
    .canvas-view {
      display: none;
      position: absolute;
      inset: 0;
      background: var(--bg-black);
    }

    /* Only show canvas view when BOTH creative page AND canvas view are active */
    .creative-page.active .canvas-view.active {
      display: block;
      position: fixed;
      z-index: 10;
    }

    body.canvas-dragging {
      cursor: grabbing !important;
    }

    body.canvas-placing {
      cursor: crosshair !important;
    }

    /* Canvas Container */
    .canvas-container {
      position: absolute;
      inset: 0;
      overflow: hidden;
      cursor: grab;
      background: #030305;
    }

    .infinite-canvas {
      position: absolute;
      width: 8000px;
      height: 8000px;
      left: 50%;
      top: 50%;
      transform-origin: center center;
    }

    /* Grid background */
    .canvas-grid {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px),
        radial-gradient(circle, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 100px 100px, 20px 20px;
      pointer-events: none;
    }

    /* Center marker */
    .center-marker {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      pointer-events: none;
    }

    .center-marker::before,
    .center-marker::after {
      content: '';
      position: absolute;
      background: rgba(255,255,255,0.1);
    }

    .center-marker::before {
      width: 1px;
      height: 40px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .center-marker::after {
      width: 40px;
      height: 1px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* Canvas Empty State */
    .canvas-empty-state {
      position: absolute;
      text-align: center;
      padding: 48px;
      background: rgba(26,26,36,0.9);
      border: 2px dashed rgba(255,255,255,0.15);
      border-radius: 24px;
      backdrop-filter: blur(12px);
      z-index: 10;
    }
    .canvas-empty-state .canvas-empty-icon { font-size: 56px; margin-bottom: 20px; }
    .canvas-empty-state h3 { font-size: 22px; margin-bottom: 12px; color: var(--text-white); }
    .canvas-empty-state p { font-size: 14px; color: var(--text-gray-400); max-width: 300px; margin: 0 auto 20px; line-height: 1.5; }
    .canvas-empty-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: var(--text-white);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .canvas-empty-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }

    /* Creation cards on canvas */
    .canvas-creation {
      position: absolute;
      width: 280px;
      background: rgba(26,26,36,0.95);
      border: 1px solid var(--border-white-10);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      transform-origin: center center;
    }

    .canvas-creation:hover {
      border-color: var(--border-white-20);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 40px rgba(196,161,255,0.1);
      transform: scale(1.05);
      z-index: 50;
    }

    .canvas-creation.selected {
      border-color: #c4a1ff;
      box-shadow: 0 0 0 3px rgba(196,161,255,0.3), 0 20px 60px rgba(0,0,0,0.6);
    }

    .creation-image {
      height: 160px;
      background: var(--bg-gray-800);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      position: relative;
    }

    .creation-image::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(26,26,36,0.95) 0%, transparent 40%);
    }

    .creation-type-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 5px 12px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      border-radius: 100px;
      font-size: 11px;
      color: var(--text-gray-400);
      z-index: 2;
    }

    .creation-info {
      padding: 16px;
    }

    .creation-title {
      font-size: 16px;
      font-family: 'Cormorant Garamond', serif;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .creation-author {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-gray-500);
    }

    .author-avatar {
      width: 20px;
      height: 20px;
      background: var(--bg-gray-800);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .creation-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-white-10);
    }

    .mood-tag {
      padding: 4px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 100px;
      font-size: 11px;
      color: var(--text-gray-400);
    }

    .creation-reactions {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-gray-500);
    }

    /* Cluster labels */
    .cluster-label {
      position: absolute;
      padding: 8px 16px;
      background: rgba(255,255,255,0.03);
      border: 1px dashed var(--border-white-10);
      border-radius: 100px;
      font-size: 13px;
      color: var(--text-gray-500);
      white-space: nowrap;
      pointer-events: none;
    }

    /* Canvas Toolbar */
    .canvas-toolbar {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: rgba(31,41,55,0.9);
      border: 1px solid var(--border-white-10);
      border-radius: 12px;
      backdrop-filter: blur(12px);
      z-index: 101;
    }

    .tool-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-gray-500);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tool-btn:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text-white);
    }

    .tool-btn.active {
      background: rgba(255,255,255,0.1);
      color: var(--text-white);
    }

    .tool-separator {
      width: 1px;
      height: 24px;
      background: var(--border-white-10);
      margin: 0 4px;
    }

    /* Minimap */
    .minimap {
      position: fixed;
      bottom: 24px;
      left: 24px;
      width: 200px;
      height: 140px;
      background: rgba(17,24,39,0.95);
      border: 1px solid var(--border-white-10);
      border-radius: 12px;
      overflow: hidden;
      z-index: 101;
    }

    .minimap-header {
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border-white-10);
      font-size: 11px;
      color: var(--text-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .minimap-canvas {
      position: relative;
      height: calc(100% - 30px);
      cursor: pointer;
    }

    .minimap-dot {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #c4a1ff;
      border-radius: 50%;
      opacity: 0.7;
    }

    .minimap-viewport {
      position: absolute;
      border: 2px solid var(--text-white);
      border-radius: 3px;
      background: rgba(255,255,255,0.05);
      transition: all 0.1s ease;
    }

    /* Zoom controls */
    .zoom-controls {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 101;
    }

    .zoom-btn {
      width: 44px;
      height: 44px;
      background: rgba(17,24,39,0.95);
      border: 1px solid var(--border-white-10);
      border-radius: 12px;
      color: var(--text-gray-400);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .zoom-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-white);
    }

    .zoom-level {
      text-align: center;
      font-size: 12px;
      color: var(--text-gray-500);
      padding: 8px;
      background: rgba(17,24,39,0.95);
      border: 1px solid var(--border-white-10);
      border-radius: 8px;
    }

    /* Canvas hint */
    .canvas-hint-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: rgba(17,24,39,0.95);
      border: 1px solid var(--border-white-10);
      border-radius: 100px;
      font-size: 13px;
      color: var(--text-gray-500);
      z-index: 101;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .hint-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .hint-key {
      padding: 3px 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Placement mode */
    .placement-mode {
      position: fixed;
      top: 140px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      background: #c4a1ff;
      border-radius: 100px;
      color: var(--bg-black);
      font-size: 14px;
      font-weight: 500;
      z-index: 102;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .placement-mode.active {
      display: flex;
    }

    .cancel-placement {
      padding: 6px 14px;
      background: rgba(0,0,0,0.2);
      border: none;
      border-radius: 100px;
      color: inherit;
      font-size: 13px;
      cursor: pointer;
    }

    .cancel-placement:hover {
      background: rgba(0,0,0,0.3);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 28px;
      background: rgba(255,255,255,0.95);
      color: var(--bg-black);
      border-radius: 100px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.4s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ==================== */
    /* CREATE MODAL */
    /* ==================== */
    .create-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(12px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .create-modal-overlay.active {
      display: flex;
    }

    .create-modal {
      background: #0c0c14;
      border: 1px solid var(--border-white-10);
      border-radius: 24px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      animation: createModalIn 0.3s ease;
    }

    @keyframes createModalIn {
      from { opacity: 0; transform: scale(0.95) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .create-modal-header {
      padding: 28px 28px 0;
      text-align: center;
    }

    .create-modal-title {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .create-modal-subtitle {
      font-size: 15px;
      color: var(--text-gray-500);
    }

    .create-modal-body {
      padding: 28px;
      max-height: calc(90vh - 200px);
      overflow-y: auto;
    }

    .create-type-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .create-type-card {
      padding: 24px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-white-10);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .create-type-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: var(--border-white-20);
      transform: translateY(-4px);
    }

    .create-type-card.selected {
      border-color: var(--border-white-40);
      background: rgba(255,255,255,0.08);
    }

    .create-type-icon {
      font-size: 40px;
      display: block;
      margin-bottom: 12px;
    }

    .create-type-name {
      font-size: 16px;
      font-family: 'Cormorant Garamond', serif;
      margin-bottom: 4px;
    }

    .create-type-desc {
      font-size: 12px;
      color: var(--text-gray-500);
    }

    .create-input-group {
      margin-bottom: 20px;
    }

    .create-input-label {
      display: block;
      font-size: 13px;
      color: var(--text-gray-400);
      margin-bottom: 8px;
    }

    .create-input {
      width: 100%;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-white-10);
      border-radius: 12px;
      color: var(--text-white);
      font-family: inherit;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .create-input:focus {
      outline: none;
      border-color: var(--border-white-40);
      background: rgba(255,255,255,0.05);
    }

    .create-input::placeholder {
      color: var(--text-gray-500);
    }

    .create-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .create-modal-footer {
      display: flex;
      gap: 12px;
      padding: 0 28px 28px;
    }

    .create-modal-btn {
      flex: 1;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .create-modal-btn.cancel {
      background: transparent;
      border: 1px solid var(--border-white-20);
      color: var(--text-gray-400);
    }

    .create-modal-btn.cancel:hover {
      border-color: var(--border-white-40);
      color: var(--text-white);
    }

    .create-modal-btn.submit {
      background: var(--text-white);
      border: none;
      color: var(--bg-black);
    }

    .create-modal-btn.submit:hover {
      box-shadow: 0 0 30px rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }

    .create-modal-btn.submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .create-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: var(--text-gray-400);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    .create-modal-close:hover {
      background: rgba(255,255,255,0.2);
      color: var(--text-white);
    }

    /* Create Steps */
    .create-step {
      display: none;
    }
    .create-step.active {
      display: block;
    }

    .create-back-btn {
      background: none;
      border: none;
      color: var(--text-gray-400);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 16px;
      transition: color 0.2s;
    }
    .create-back-btn:hover {
      color: var(--text-white);
    }

    .required {
      color: #f87171;
    }

    /* Content Areas */
    .create-content-area {
      margin-bottom: 20px;
    }

    .create-content-editor {
      min-height: 200px;
      font-family: 'Georgia', serif;
      font-size: 16px;
      line-height: 1.8;
    }

    /* Writing Toolbar */
    .writing-toolbar {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-white-10);
      border-bottom: none;
      border-radius: 12px 12px 0 0;
    }
    .writing-toolbar button {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-gray-400);
      cursor: pointer;
      transition: all 0.2s;
    }
    .writing-toolbar button:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-white);
    }
    .toolbar-divider {
      width: 1px;
      background: var(--border-white-10);
      margin: 0 8px;
    }

    .writing-toolbar + .create-content-editor {
      border-radius: 0 0 12px 12px;
    }

    .content-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-gray-500);
    }

    .upload-alt {
      cursor: pointer;
      color: var(--text-gray-400);
      transition: color 0.2s;
    }
    .upload-alt:hover {
      color: var(--text-white);
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border-white-20);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .upload-zone:hover {
      border-color: var(--border-white-40);
      background: rgba(255,255,255,0.03);
    }
    .upload-zone.dragover {
      border-color: #a78bfa;
      background: rgba(167, 139, 250, 0.1);
    }

    .upload-zone-content {
      pointer-events: none;
    }
    .upload-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 16px;
    }
    .upload-text {
      font-size: 16px;
      color: var(--text-gray-300);
      margin-bottom: 8px;
    }
    .upload-hint {
      font-size: 13px;
      color: var(--text-gray-500);
    }

    .upload-preview {
      position: relative;
    }
    .upload-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 12px;
      object-fit: contain;
    }
    .remove-upload {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .remove-upload:hover {
      background: rgba(239, 68, 68, 0.8);
    }

    .audio-preview {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }
    .audio-icon {
      font-size: 32px;
    }
    .audio-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-gray-300);
    }
    .audio-preview .remove-upload {
      position: relative;
      top: auto;
      right: auto;
    }

    /* Music Options */
    .music-options {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .music-option-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-white-10);
      border-radius: 10px;
      color: var(--text-gray-400);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .music-option-btn:hover {
      border-color: var(--border-white-20);
    }
    .music-option-btn.active {
      background: rgba(255,255,255,0.1);
      border-color: var(--border-white-40);
      color: var(--text-white);
    }

    .input-hint {
      font-size: 12px;
      color: var(--text-gray-500);
      margin-top: 8px;
    }

    /* Mood Options */
    .mood-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .mood-option {
      padding: 10px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-white-10);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-gray-400);
      cursor: pointer;
      transition: all 0.2s;
    }
    .mood-option:hover {
      border-color: var(--border-white-20);
      color: var(--text-gray-300);
    }
    .mood-option.selected {
      background: rgba(167, 139, 250, 0.2);
      border-color: #a78bfa;
      color: var(--text-white);
    }

    /* Visibility Options */
    .visibility-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .visibility-option {
      cursor: pointer;
    }
    .visibility-option input {
      display: none;
    }
    .visibility-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-white-10);
      border-radius: 12px;
      transition: all 0.2s;
    }
    .visibility-option input:checked + .visibility-card {
      background: rgba(255,255,255,0.08);
      border-color: var(--border-white-40);
    }
    .visibility-card:hover {
      border-color: var(--border-white-20);
    }
    .visibility-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .visibility-name {
      font-size: 14px;
      color: var(--text-white);
      margin-bottom: 4px;
    }
    .visibility-desc {
      font-size: 11px;
      color: var(--text-gray-500);
    }

    /* Canvas responsive */
    @media (max-width: 768px) {
      .canvas-toolbar { display: none; }
      .minimap { width: 140px; height: 100px; }
      .canvas-hint-bar { display: none; }
    }

    /* ==================== */
    /* GARDEN VIEW - FULL */
    /* ==================== */
    .garden-view {
      display: none;
      position: absolute;
      inset: 0;
      background: #060806;
      overflow-y: auto;
    }

    .creative-page.active .garden-view.active {
      display: block;
      position: fixed;
      z-index: 10;
    }

    /* Garden ambient background */
    .garden-ambient-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .garden-ambient-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.3;
      animation: garden-float-orb 20s ease-in-out infinite;
    }

    .garden-ambient-orb:nth-child(1) {
      width: 400px;
      height: 400px;
      background: rgba(124,232,168,0.15);
      top: -100px;
      left: -100px;
      animation-delay: 0s;
    }

    .garden-ambient-orb:nth-child(2) {
      width: 300px;
      height: 300px;
      background: rgba(196,161,255,0.1);
      bottom: -50px;
      right: -50px;
      animation-delay: -10s;
    }

    .garden-ambient-orb:nth-child(3) {
      width: 250px;
      height: 250px;
      background: rgba(232,200,124,0.1);
      top: 50%;
      left: 50%;
      animation-delay: -5s;
    }

    @keyframes garden-float-orb {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(50px, 30px) scale(1.1); }
    }

    .garden-main {
      position: relative;
      z-index: 1;
      padding: 120px 48px 80px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .garden-page-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .garden-page-header h1 {
      font-size: 52px;
      font-weight: 400;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .garden-page-header p {
      font-size: 18px;
      color: #9ca89c;
      max-width: 600px;
      margin: 0 auto 32px;
    }

    /* View toggle */
    .garden-view-toggle {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 48px;
    }

    .garden-view-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 100px;
      color: #6b7a6b;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .garden-view-btn:hover {
      background: rgba(255,255,255,0.06);
      color: #f0eeeb;
    }

    .garden-view-btn.active {
      background: rgba(124,232,168,0.1);
      border-color: rgba(124,232,168,0.3);
      color: #7ce8a8;
    }

    /* Stats bar */
    .garden-stats-bar {
      display: flex;
      justify-content: center;
      gap: 48px;
      margin-bottom: 48px;
      padding: 20px 0;
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .garden-stat-item {
      text-align: center;
    }

    .garden-stat-value {
      font-size: 28px;
      font-family: 'Cormorant Garamond', serif;
      color: #f0eeeb;
    }

    .garden-stat-label {
      font-size: 13px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Section dividers */
    .garden-section-divider {
      display: flex;
      align-items: center;
      gap: 20px;
      margin: 48px 0 32px;
    }

    .garden-section-divider::before,
    .garden-section-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.04);
    }

    .garden-section-title {
      font-size: 14px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    /* Room grid */
    .garden-rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 28px;
    }

    /* Room card */
    .garden-room-card {
      background: #1a241a;
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 24px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s ease;
      position: relative;
    }

    .garden-room-card:hover {
      border-color: rgba(255,255,255,0.15);
      transform: translateY(-8px);
      box-shadow: 0 24px 60px rgba(0,0,0,0.4);
    }

    .garden-room-card.your-room {
      border-style: dashed;
      border-color: rgba(255,255,255,0.15);
      background: linear-gradient(135deg, #1a241a 0%, rgba(124,232,168,0.05) 100%);
    }

    .garden-room-card.your-room:hover {
      border-color: #7ce8a8;
      box-shadow: 0 24px 60px rgba(124,232,168,0.15);
    }

    /* Room preview */
    .garden-room-preview {
      height: 200px;
      background: #141c14;
      position: relative;
      overflow: hidden;
    }

    .garden-room-preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 4px;
      padding: 4px;
      height: 100%;
    }

    .garden-preview-item {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      transition: all 0.3s ease;
    }

    .garden-room-card:hover .garden-preview-item {
      background: rgba(255,255,255,0.05);
    }

    .garden-preview-item.featured {
      grid-column: span 2;
      grid-row: span 2;
      font-size: 56px;
    }

    .garden-room-preview.empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .garden-empty-icon {
      width: 80px;
      height: 80px;
      background: rgba(124,232,168,0.1);
      border: 2px dashed rgba(124,232,168,0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      transition: all 0.3s ease;
    }

    .garden-room-card:hover .garden-empty-icon {
      background: rgba(124,232,168,0.15);
      border-color: rgba(124,232,168,0.5);
      transform: scale(1.05);
    }

    .garden-empty-text {
      font-size: 16px;
      color: #6b7a6b;
    }

    /* Create Room Modal */
    .create-room-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .create-room-overlay.active { opacity: 1; pointer-events: all; }
    .create-room-modal {
      background: #151c15;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
      width: 100%;
      max-width: 480px;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }
    .create-room-overlay.active .create-room-modal { transform: translateY(0); }
    .create-room-header {
      padding: 24px 24px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .create-room-title { font-size: 20px; font-weight: 600; color: #f0eeeb; }
    .create-room-close {
      background: rgba(255,255,255,0.06);
      border: none;
      color: rgba(255,255,255,0.5);
      width: 32px; height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex; align-items: center; justify-content: center;
    }
    .create-room-cover-area {
      margin: 20px 24px 0;
      height: 130px;
      background: linear-gradient(135deg, rgba(124,232,168,0.15), rgba(196,161,255,0.1));
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 6px;
      color: rgba(255,255,255,0.35);
      font-size: 13px;
      transition: border-color 0.2s, background 0.2s;
    }
    .create-room-cover-area:hover { border-color: rgba(124,232,168,0.3); background: rgba(124,232,168,0.08); color: rgba(255,255,255,0.6); }
    .create-room-cover-area img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
    .create-room-cover-icon { font-size: 26px; }
    .create-room-body { padding: 20px 24px 24px; display: flex; flex-direction: column; gap: 16px; }
    .create-room-mood-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .create-room-mood-option {
      padding: 10px 6px;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    .create-room-mood-option .mood-icon { font-size: 22px; display: block; margin-bottom: 4px; }
    .create-room-mood-option:hover { border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
    .create-room-mood-option.selected { border-color: #7ce8a8; background: rgba(124,232,168,0.1); color: #7ce8a8; }

    /* Room Edit Modal */
    .room-edit-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .room-edit-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    .room-edit-modal {
      background: #151c15;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
      width: 100%;
      max-width: 480px;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .room-edit-overlay.active .room-edit-modal {
      transform: translateY(0);
    }
    .room-edit-cover-area {
      height: 160px;
      background: linear-gradient(135deg, rgba(124,232,168,0.2), rgba(196,161,255,0.15));
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .room-edit-cover-area img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .room-edit-cover-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: rgba(255,255,255,0.4);
      font-size: 13px;
      transition: background 0.2s;
    }
    .room-edit-cover-area:hover .room-edit-cover-placeholder {
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.7);
    }
    .room-edit-cover-placeholder span { font-size: 28px; }
    .room-edit-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    .room-edit-field { display: flex; flex-direction: column; gap: 6px; }
    .room-edit-label { font-size: 12px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.08em; }
    .room-edit-input, .room-edit-textarea {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px 14px;
      color: #f0eeeb;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .room-edit-input:focus, .room-edit-textarea:focus { border-color: rgba(124,232,168,0.4); }
    .room-edit-textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
    .room-edit-actions { display: flex; gap: 10px; margin-top: 4px; }
    .room-edit-cancel {
      flex: 1;
      padding: 13px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      cursor: pointer;
    }
    .room-edit-save {
      flex: 2;
      padding: 13px;
      background: rgba(124,232,168,0.15);
      border: 1px solid rgba(124,232,168,0.3);
      border-radius: 12px;
      color: #7ce8a8;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .room-edit-save:hover { background: rgba(124,232,168,0.25); }

    /* Garden Empty State */
    .garden-empty-state {
      text-align: center;
      padding: 60px 40px;
      background: rgba(124,232,168,0.03);
      border: 2px dashed rgba(124,232,168,0.2);
      border-radius: 24px;
      margin-bottom: 24px;
    }
    .garden-empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .garden-empty-state h3 {
      font-size: 22px;
      color: var(--text-white);
      margin-bottom: 12px;
    }
    .garden-empty-state p {
      font-size: 15px;
      color: var(--text-gray-400);
      max-width: 400px;
      margin: 0 auto 24px;
      line-height: 1.6;
    }
    .garden-empty-state-btn {
      padding: 14px 28px;
      background: rgba(124,232,168,0.15);
      border: 1px solid rgba(124,232,168,0.3);
      border-radius: 12px;
      color: #7ce8a8;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .garden-empty-state-btn:hover {
      background: rgba(124,232,168,0.25);
      transform: translateY(-2px);
    }

    /* Room status badge */
    .garden-room-status {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 14px;
      border-radius: 100px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(8px);
    }

    .garden-room-status.open {
      background: rgba(124,232,168,0.2);
      color: #7ce8a8;
    }

    .garden-room-status.quiet {
      background: rgba(196,161,255,0.2);
      color: #c4a1ff;
    }

    .garden-room-status.closed {
      background: rgba(255,255,255,0.1);
      color: #6b7a6b;
    }

    .garden-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Owner badge */
    .garden-owner-badge {
      position: absolute;
      top: 16px;
      left: 16px;
      padding: 6px 14px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      border-radius: 100px;
      font-size: 12px;
      color: #9ca89c;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .garden-owner-avatar {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: #141c14;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    /* Room info */
    .garden-room-info {
      padding: 24px;
    }

    .garden-room-title {
      font-size: 22px;
      font-family: 'Cormorant Garamond', serif;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .garden-room-description {
      font-size: 14px;
      color: #6b7a6b;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .garden-room-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: #6b7a6b;
      margin-bottom: 20px;
    }

    .garden-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Room tags */
    .garden-room-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .garden-room-tag {
      padding: 5px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 100px;
      font-size: 12px;
      color: #9ca89c;
    }

    /* Room actions */
    .garden-room-actions {
      display: flex;
      gap: 12px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.04);
    }

    .garden-knock-btn {
      flex: 1;
      padding: 14px 24px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      color: #f0eeeb;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .garden-knock-btn:hover {
      background: #f0eeeb;
      color: #060806;
    }

    .garden-peek-btn {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      color: #6b7a6b;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .garden-peek-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #f0eeeb;
    }

    .garden-enter-btn {
      flex: 1;
      padding: 14px 24px;
      background: #7ce8a8;
      border: none;
      border-radius: 14px;
      color: #060806;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .garden-enter-btn:hover {
      box-shadow: 0 0 30px rgba(124,232,168,0.4);
    }

    /* Visitor activity */
    .garden-visitor-activity {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin-top: 16px;
    }

    .garden-visitor-avatars {
      display: flex;
    }

    .garden-visitor-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #141c14;
      border: 2px solid #1a241a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: -8px;
    }

    .garden-visitor-avatar:first-child {
      margin-left: 0;
    }

    .garden-visitor-text {
      font-size: 12px;
      color: #6b7a6b;
      margin-left: 4px;
    }

    /* Knock modal */
    .garden-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .garden-modal-overlay.active {
      display: flex;
    }

    .garden-modal {
      background: #0c120c;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
      width: 100%;
      max-width: 480px;
      overflow: hidden;
      animation: gardenModalIn 0.3s ease;
    }

    @keyframes gardenModalIn {
      from { opacity: 0; transform: scale(0.95) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .garden-modal-header {
      padding: 28px 28px 0;
      text-align: center;
    }

    .garden-modal-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .garden-modal-title {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .garden-modal-subtitle {
      font-size: 15px;
      color: #6b7a6b;
    }

    .garden-modal-body {
      padding: 28px;
    }

    .garden-knock-message-label {
      font-size: 13px;
      color: #9ca89c;
      margin-bottom: 10px;
      display: block;
    }

    .garden-knock-message {
      width: 100%;
      padding: 16px;
      background: #141c14;
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 14px;
      color: #f0eeeb;
      font-size: 15px;
      font-family: inherit;
      resize: none;
      height: 100px;
    }

    .garden-knock-message:focus {
      outline: none;
      border-color: rgba(255,255,255,0.15);
    }

    .garden-knock-message::placeholder {
      color: #6b7a6b;
    }

    .garden-knock-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .garden-knock-suggestion {
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 100px;
      color: #9ca89c;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .garden-knock-suggestion:hover {
      background: rgba(255,255,255,0.1);
      color: #f0eeeb;
    }

    .garden-modal-actions {
      display: flex;
      gap: 12px;
      padding: 0 28px 28px;
    }

    .garden-modal-cancel {
      flex: 1;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      color: #9ca89c;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .garden-modal-cancel:hover {
      background: rgba(255,255,255,0.1);
      color: #f0eeeb;
    }

    .garden-modal-submit {
      flex: 1;
      padding: 16px;
      background: #7ce8a8;
      border: none;
      border-radius: 14px;
      color: #060806;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .garden-modal-submit:hover {
      box-shadow: 0 0 30px rgba(124,232,168,0.4);
    }

    /* Fireflies */
    .garden-firefly {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      animation: firefly-drift linear infinite;
    }
    @keyframes firefly-drift {
      0%   { transform: translate(0, 0) scale(1);   opacity: 0; }
      10%  { opacity: 1; }
      50%  { transform: translate(calc(var(--dx) * 0.5), calc(var(--dy) * 0.5)) scale(1.2); opacity: 0.8; }
      90%  { opacity: 0.6; }
      100% { transform: translate(var(--dx), var(--dy)) scale(0.8); opacity: 0; }
    }

    /* Growth bar */
    .garden-growth-bar-wrap {
      padding: 0 24px 14px;
    }
    .garden-growth-label {
      font-size: 11px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }
    .garden-growth-bar-track {
      height: 3px;
      background: rgba(255,255,255,0.05);
      border-radius: 2px;
      overflow: hidden;
    }
    .garden-growth-bar-fill {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, #7ce8a8, #c4a1ff);
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Featured label */
    .garden-featured-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #c4a1ff;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 4px 10px;
      background: rgba(196,161,255,0.1);
      border-radius: 100px;
      margin-bottom: 12px;
    }

    /* Room preview big emoji */
    .garden-room-preview-emoji {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 72px;
      opacity: 0.6;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }
    .garden-room-card:hover .garden-room-preview-emoji {
      transform: scale(1.1);
      opacity: 0.8;
    }

    /* Ghost placeholder rooms */
    .garden-ghost-rooms {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 28px;
      margin-bottom: 32px;
      opacity: 0;
      animation: ghost-fade-in 2s ease forwards;
    }
    @keyframes ghost-fade-in {
      to { opacity: 1; }
    }
    .garden-ghost-room {
      background: rgba(255,255,255,0.01);
      border: 1px dashed rgba(255,255,255,0.05);
      border-radius: 24px;
      height: 300px;
      position: relative;
      overflow: hidden;
    }
    .garden-ghost-room::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(124,232,168,0.02) 100%);
      animation: ghost-pulse 4s ease-in-out infinite;
    }
    @keyframes ghost-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    .garden-ghost-seed {
      position: absolute;
      font-size: 20px;
      opacity: 0.12;
      animation: seed-drift 8s ease-in-out infinite;
    }
    @keyframes seed-drift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50%       { transform: translate(12px, -18px) rotate(25deg); }
    }

    /* Ambient glow on rooms */
    .garden-room-calm-glow    { box-shadow: 0 0 40px rgba(124,232,168,0.1); border-color: rgba(124,232,168,0.15) !important; }
    .garden-room-dreamy-glow  { box-shadow: 0 0 40px rgba(196,161,255,0.1); border-color: rgba(196,161,255,0.15) !important; }
    .garden-room-warm-glow    { box-shadow: 0 0 40px rgba(232,168,124,0.1); border-color: rgba(232,168,124,0.15) !important; }

    /* Onboarding modal */
    .garden-onboarding-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      backdrop-filter: blur(14px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .garden-onboarding-overlay.active { display: flex; }
    .garden-onboarding-modal {
      background: #0c120c;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 28px;
      width: 100%;
      max-width: 520px;
      overflow: hidden;
      animation: gardenModalIn 0.35s ease;
    }
    .garden-onboarding-header {
      padding: 36px 36px 0;
      text-align: center;
    }
    .garden-onboarding-icon { font-size: 52px; margin-bottom: 14px; }
    .garden-onboarding-step {
      font-size: 11px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 8px;
    }
    .garden-onboarding-title {
      font-size: 26px;
      font-family: 'Cormorant Garamond', serif;
      color: #f0eeeb;
      margin-bottom: 8px;
    }
    .garden-onboarding-subtitle {
      font-size: 14px;
      color: #6b7a6b;
      line-height: 1.6;
      padding-bottom: 4px;
    }
    .garden-onboarding-body { padding: 28px 36px; }
    .garden-mood-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    .garden-mood-option {
      padding: 20px 16px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    .garden-mood-option:hover {
      border-color: rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
    }
    .garden-mood-option.selected {
      border-color: #7ce8a8;
      background: rgba(124,232,168,0.08);
    }
    .garden-mood-option-emoji { font-size: 30px; margin-bottom: 8px; }
    .garden-mood-option-name  { font-size: 15px; color: #f0eeeb; margin-bottom: 4px; }
    .garden-mood-option-desc  { font-size: 12px; color: #6b7a6b; line-height: 1.4; }
    .garden-onboarding-actions {
      display: flex;
      gap: 12px;
      padding: 0 36px 36px;
    }
    .garden-onboarding-skip {
      padding: 16px 20px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      color: #6b7a6b;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .garden-onboarding-skip:hover { color: #9ca89c; border-color: rgba(255,255,255,0.15); }
    .garden-onboarding-next {
      flex: 1;
      padding: 16px;
      background: #7ce8a8;
      border: none;
      border-radius: 14px;
      color: #060806;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .garden-onboarding-next:hover:not(:disabled) { box-shadow: 0 0 30px rgba(124,232,168,0.4); }
    .garden-onboarding-next:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ==================== */
    /* ROOM INTERIOR        */
    /* ==================== */
    .garden-room-interior {
      position: fixed;
      inset: 0;
      z-index: 200;
      display: none;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: #060806;
      animation: interior-slide-in 0.45s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .garden-room-interior.active { display: flex; }

    @keyframes interior-card-bloom {
      from { transform: scale(0.7); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    @keyframes interior-slide-in {
      from { transform: translateY(40px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }

    /* Interior hero */
    .interior-hero {
      position: relative;
      min-height: 240px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 0px 48px 40px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .interior-hero-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    .interior-hero-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(70px);
    }
    .interior-topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 16px 32px;
      background: linear-gradient(to bottom, rgba(6,8,6,0.95) 0%, transparent 100%);
      flex-shrink: 0;
    }
    .interior-hero-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 100px;
      color: #9ca89c;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .interior-hero-back:hover { color: #f0eeeb; border-color: rgba(255,255,255,0.2); }

    .interior-hero-content {
      position: relative;
      z-index: 2;
    }
    .interior-mood-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 10px;
      border-radius: 100px;
      margin-bottom: 16px;
      opacity: 0.85;
    }
    .interior-room-emoji {
      display: none;
    }
    .interior-room-name {
      font-size: 42px;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 400;
      color: #f0eeeb;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      line-height: 1.1;
    }
    .interior-room-desc {
      font-size: 16px;
      color: rgba(240,238,235,0.6);
      max-width: 520px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .interior-hero-meta {
      display: flex;
      align-items: center;
      gap: 24px;
      font-size: 13px;
      color: rgba(240,238,235,0.5);
    }
    .interior-hero-meta span { display: flex; align-items: center; gap: 6px; }

    /* Interior growth bar in hero */
    .interior-growth-section {
      margin-top: 20px;
      max-width: 360px;
    }
    .interior-growth-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(240,238,235,0.4);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }
    .interior-growth-track {
      height: 4px;
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
      overflow: hidden;
    }
    .interior-growth-fill {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, #7ce8a8, #c4a1ff);
      transition: width 1.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Interior body */
    .interior-body {
      flex: 1;
      padding: 48px 48px 80px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .interior-section-label {
      font-size: 12px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .interior-section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.04);
    }

    /* Creation grid */
    .interior-creations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 56px;
    }

    /* Plant first creation slot */
    .interior-plant-slot {
      aspect-ratio: 1;
      background: rgba(255,255,255,0.02);
      border: 2px dashed rgba(255,255,255,0.08);
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .interior-plant-slot:hover {
      border-color: rgba(124,232,168,0.4);
      background: rgba(124,232,168,0.04);
    }
    .interior-plant-slot:hover .interior-plant-icon {
      transform: scale(1.1);
    }
    .interior-plant-icon {
      font-size: 32px;
      transition: transform 0.3s ease;
    }
    .interior-plant-text {
      font-size: 13px;
      color: #6b7a6b;
      text-align: center;
      line-height: 1.4;
    }

    /* Ghost creation slots */
    .interior-ghost-slot {
      aspect-ratio: 1;
      background: rgba(255,255,255,0.015);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 18px;
      animation: ghost-slot-pulse 3.5s ease-in-out infinite;
    }
    .interior-ghost-slot:nth-child(2) { animation-delay: -0.8s; }
    .interior-ghost-slot:nth-child(3) { animation-delay: -1.6s; }
    .interior-ghost-slot:nth-child(4) { animation-delay: -2.4s; }
    .interior-ghost-slot:nth-child(5) { animation-delay: -3.2s; }
    @keyframes ghost-slot-pulse {
      0%, 100% { opacity: 0.4; }
      50%       { opacity: 0.7; }
    }

    /* Visitor log */
    .interior-visitor-log {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 20px;
      padding: 24px;
    }
    .interior-visitor-empty {
      text-align: center;
      padding: 20px 0;
    }
    .interior-visitor-empty-icon { font-size: 32px; margin-bottom: 10px; opacity: 0.4; }
    .interior-visitor-empty-text { font-size: 14px; color: #6b7a6b; }

    /* Interior responsive */
    @media (max-width: 768px) {
      .interior-hero { min-height: 240px; padding: 24px 24px 32px; }
      .interior-room-name { font-size: 30px; }
      .interior-body { padding: 32px 24px 60px; }
      .interior-creations-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ==================== */
    /* CREATION DETAIL      */
    /* ==================== */
    .creation-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      backdrop-filter: blur(16px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .creation-detail-overlay.active { display: flex; }

    .creation-detail-modal {
      background: #0c120c;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
      width: 100%;
      max-width: 620px;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: gardenModalIn 0.3s ease;
    }

    .creation-detail-header {
      padding: 28px 28px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }
    .creation-detail-emoji { font-size: 36px; flex-shrink: 0; }
    .creation-detail-meta { flex: 1; min-width: 0; }
    .creation-detail-title {
      font-size: 24px;
      font-family: 'Cormorant Garamond', serif;
      color: #f0eeeb;
      margin-bottom: 6px;
      line-height: 1.2;
    }
    .creation-detail-tags {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .creation-detail-tag {
      font-size: 11px;
      color: #6b7a6b;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 3px 8px;
      background: rgba(255,255,255,0.04);
      border-radius: 100px;
    }
    .creation-detail-tag.mood {
      color: #7ce8a8;
      background: rgba(124,232,168,0.08);
    }
    .creation-detail-close {
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.06);
      border: none;
      border-radius: 50%;
      color: #6b7a6b;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .creation-detail-close:hover { background: rgba(255,255,255,0.12); color: #f0eeeb; }

    .creation-detail-body {
      padding: 28px;
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }
    .creation-detail-content {
      font-size: 16px;
      color: #c8d4c8;
      line-height: 1.8;
      white-space: pre-wrap;
      font-family: 'Cormorant Garamond', serif;
    }
    .creation-detail-image {
      width: 100%;
      border-radius: 14px;
      object-fit: cover;
      max-height: 360px;
    }
    .creation-detail-music-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      color: #9ca89c;
      font-size: 14px;
      text-decoration: none;
      transition: all 0.2s;
    }
    .creation-detail-music-link:hover { border-color: rgba(255,255,255,0.2); color: #f0eeeb; }

    .creation-detail-footer {
      padding: 16px 28px 24px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .creation-detail-date { font-size: 12px; color: #4a5a4a; }
    .creation-detail-delete {
      padding: 10px 18px;
      background: rgba(255,80,80,0.08);
      border: 1px solid rgba(255,80,80,0.2);
      border-radius: 10px;
      color: rgba(255,120,120,0.8);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .creation-detail-delete:hover {
      background: rgba(255,80,80,0.15);
      color: #ff8080;
      border-color: rgba(255,80,80,0.4);
    }

    /* Card delete badge on hover */
    .interior-creation-card .card-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 26px;
      height: 26px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      color: rgba(255,120,120,0.7);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 2;
    }
    .interior-creation-card:hover .card-delete-btn { opacity: 1; }
    .interior-creation-card { position: relative; }

    /* Garden responsive */
    @media (max-width: 900px) {
      .garden-main { padding: 100px 24px 60px; }
      .garden-page-header h1 { font-size: 36px; }
      .garden-rooms-grid { grid-template-columns: 1fr; }
      .garden-ghost-rooms { grid-template-columns: 1fr; }
      .garden-stats-bar { gap: 24px; flex-wrap: wrap; }
      .garden-mood-grid { grid-template-columns: 1fr 1fr; }
      .garden-onboarding-header, .garden-onboarding-body, .garden-onboarding-actions { padding-left: 24px; padding-right: 24px; }
    }

    @media (max-width: 600px) {
      .garden-view-toggle { flex-wrap: wrap; }
      .garden-room-actions { flex-direction: column; }
      .garden-peek-btn { width: 100%; }
    }

    /* ==================== */
    /* SEASONAL FLOW VIEW */
    /* ==================== */
    .seasonal-view {
      display: none;
      position: absolute;
      inset: 0;
      background: #0a0c10;
      overflow-y: auto;
    }

    .creative-page.active .seasonal-view.active {
      display: block;
      position: fixed;
      z-index: 10;
    }

    /* Season background variations */
    .seasonal-view.winter { background: linear-gradient(180deg, #0a0c14 0%, #0f1420 100%); }
    .seasonal-view.spring { background: linear-gradient(180deg, #0a100a 0%, #0f1a0f 100%); }
    .seasonal-view.summer { background: linear-gradient(180deg, #14120a 0%, #1a180f 100%); }
    .seasonal-view.autumn { background: linear-gradient(180deg, #140c0a 0%, #1a100f 100%); }

    /* Season colors */
    .seasonal-view {
      --winter-primary: #a1c4e8;
      --winter-glow: rgba(161,196,232,0.3);
      --spring-primary: #c4e8c4;
      --spring-glow: rgba(196,232,196,0.3);
      --summer-primary: #f0e87c;
      --summer-glow: rgba(240,232,124,0.3);
      --autumn-primary: #e8a87c;
      --autumn-glow: rgba(232,168,124,0.3);
    }

    /* Seasonal particles */
    .seasonal-particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .seasonal-particle {
      position: absolute;
      border-radius: 50%;
      animation: seasonal-float-particle 20s ease-in-out infinite;
    }

    .seasonal-view.winter .seasonal-particle { background: rgba(161,196,232,0.3); }
    .seasonal-view.spring .seasonal-particle { background: rgba(196,232,196,0.3); }
    .seasonal-view.summer .seasonal-particle { background: rgba(240,232,124,0.3); }
    .seasonal-view.autumn .seasonal-particle { background: rgba(232,168,124,0.3); }

    @keyframes seasonal-float-particle {
      0%, 100% { transform: translateY(0) translateX(0); opacity: 0.2; }
      50% { transform: translateY(-100px) translateX(50px); opacity: 0.5; }
    }

    .seasonal-main {
      position: relative;
      z-index: 1;
      padding: 120px 48px 80px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .seasonal-page-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .seasonal-page-header h1 {
      font-size: 48px;
      font-weight: 300;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .seasonal-page-header p {
      font-size: 18px;
      color: #9ca3af;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Season selector */
    .season-selector {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .season-btn {
      padding: 16px 32px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      color: #9ca3af;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.4s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .season-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--season-color);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .season-btn:hover {
      background: rgba(255,255,255,0.06);
      color: #f0eeeb;
      border-color: rgba(255,255,255,0.2);
    }

    .season-btn.active {
      background: rgba(255,255,255,0.08);
      border-color: var(--season-color);
      color: #f0eeeb;
      box-shadow: 0 0 30px var(--season-glow);
    }

    .season-btn.active::before {
      opacity: 1;
    }

    .season-btn[data-season="winter"] { --season-color: var(--winter-primary); --season-glow: var(--winter-glow); }
    .season-btn[data-season="spring"] { --season-color: var(--spring-primary); --season-glow: var(--spring-glow); }
    .season-btn[data-season="summer"] { --season-color: var(--summer-primary); --season-glow: var(--summer-glow); }
    .season-btn[data-season="autumn"] { --season-color: var(--autumn-primary); --season-glow: var(--autumn-glow); }

    .season-emoji { font-size: 24px; }
    .season-name { font-weight: 400; }

    /* Mood filters */
    .seasonal-mood-section {
      margin-bottom: 48px;
    }

    .seasonal-mood-label {
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 16px;
    }

    .seasonal-mood-filters {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .seasonal-mood-filter {
      padding: 10px 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 100px;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .seasonal-mood-filter:hover {
      background: rgba(255,255,255,0.06);
      color: #f0eeeb;
      border-color: rgba(255,255,255,0.1);
    }

    .seasonal-mood-filter.active {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
      color: #f0eeeb;
    }

    /* Exhibition sections */
    .seasonal-exhibition {
      margin-bottom: 64px;
    }

    .seasonal-exhibition-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .seasonal-exhibition-info {
      flex: 1;
    }

    .seasonal-exhibition-title {
      font-size: 28px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .seasonal-exhibition-meta {
      font-size: 14px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .seasonal-exhibition-meta .separator {
      width: 4px;
      height: 4px;
      background: #6b7280;
      border-radius: 50%;
    }

    .seasonal-exhibition-timer {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: rgba(232,168,124,0.1);
      border-radius: 100px;
      font-size: 13px;
      color: #e8a87c;
    }

    .seasonal-view-all-btn {
      padding: 10px 24px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 100px;
      color: #9ca3af;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .seasonal-view-all-btn:hover {
      background: rgba(255,255,255,0.05);
      color: #f0eeeb;
    }

    /* Seasonal creation grid */
    .seasonal-creation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 24px;
    }

    .seasonal-creation-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s ease;
      position: relative;
    }

    .seasonal-creation-card:hover {
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-8px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .seasonal-creation-image {
      height: 200px;
      background: #1a1e28;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      position: relative;
      overflow: hidden;
    }

    .seasonal-creation-image::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 60%);
    }

    /* Season-tinted images */
    .seasonal-view.winter .seasonal-creation-image { background: linear-gradient(135deg, #1a2030 0%, #0f1520 100%); }
    .seasonal-view.spring .seasonal-creation-image { background: linear-gradient(135deg, #1a2a1a 0%, #0f1a0f 100%); }
    .seasonal-view.summer .seasonal-creation-image { background: linear-gradient(135deg, #2a281a 0%, #1a180f 100%); }
    .seasonal-view.autumn .seasonal-creation-image { background: linear-gradient(135deg, #2a1a1a 0%, #1a0f0f 100%); }

    .seasonal-creation-type {
      position: absolute;
      top: 16px;
      left: 16px;
      padding: 6px 14px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      border-radius: 100px;
      font-size: 12px;
      color: #9ca3af;
      z-index: 2;
    }

    .seasonal-creation-info {
      padding: 20px;
    }

    .seasonal-creation-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-family: 'Cormorant Garamond', serif;
    }

    .seasonal-creation-author {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .seasonal-creation-author-avatar {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: #1a1e28;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .seasonal-creation-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .seasonal-mood-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 100px;
      font-size: 12px;
      color: #9ca3af;
    }

    .seasonal-appreciation-btn {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 50%;
      color: #6b7280;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .seasonal-appreciation-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #f0eeeb;
      transform: scale(1.1);
    }

    .seasonal-appreciation-btn.appreciated {
      background: rgba(196,161,255,0.2);
      border-color: rgba(196,161,255,0.4);
      color: #c4a1ff;
    }

    /* Featured/Large card */
    .seasonal-creation-card.featured {
      grid-column: span 2;
    }

    .seasonal-creation-card.featured .seasonal-creation-image {
      height: 280px;
    }

    .seasonal-creation-card.featured .seasonal-creation-title {
      font-size: 24px;
    }

    /* Ephemeral badge */
    .seasonal-ephemeral-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 14px;
      background: rgba(232,168,124,0.2);
      border: 1px solid rgba(232,168,124,0.3);
      border-radius: 100px;
      font-size: 11px;
      color: #e8a87c;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Empty state */
    .seasonal-empty-state {
      text-align: center;
      padding: 80px 40px;
      background: rgba(255,255,255,0.02);
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: 24px;
    }

    .seasonal-empty-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    .seasonal-empty-state h3 { font-size: 24px; margin-bottom: 12px; }
    .seasonal-empty-state p { font-size: 15px; color: #6b7280; max-width: 400px; margin: 0 auto; }

    .seasonal-empty-state-main {
      text-align: center;
      padding: 80px 40px;
      background: rgba(255,255,255,0.02);
      border: 2px dashed rgba(255,255,255,0.1);
      border-radius: 24px;
      margin-top: 32px;
    }
    .seasonal-empty-state-main .seasonal-empty-state-icon { font-size: 72px; margin-bottom: 24px; }
    .seasonal-empty-state-main h3 { font-size: 24px; margin-bottom: 12px; color: var(--text-white); }
    .seasonal-empty-state-main p { font-size: 15px; color: var(--text-gray-400); max-width: 450px; margin: 0 auto 24px; line-height: 1.6; }
    .seasonal-empty-state-btn {
      padding: 14px 28px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: var(--text-white);
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .seasonal-empty-state-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }

    /* Seasonal responsive */
    @media (max-width: 900px) {
      .seasonal-main { padding: 100px 24px 60px; }
      .seasonal-page-header h1 { font-size: 36px; }
      .season-selector { flex-wrap: wrap; }
      .season-btn { padding: 12px 20px; }
      .seasonal-creation-card.featured { grid-column: span 1; }
      .seasonal-creation-card.featured .seasonal-creation-image { height: 200px; }
      .seasonal-exhibition-header { flex-direction: column; align-items: flex-start; gap: 16px; }
    }

    @media (max-width: 600px) {
      .seasonal-creation-grid { grid-template-columns: 1fr; }
      .seasonal-mood-filters { gap: 8px; }
      .seasonal-mood-filter { padding: 8px 14px; font-size: 13px; }
    }
  </style>
</head>
<body>

  <!-- PAGE 1: WIZARD -->
  <div class="page wizard-page active" id="wizardPage">
    <div class="wizard-container">

      <div class="wizard-header">
        <h1>Creative Space</h1>
        <p>Choose how you want to explore and share</p>
      </div>

      <!-- Progress Dots -->
      <div class="progress-dots">
        <div class="dot active" data-step="1"></div>
        <div class="dot" data-step="2"></div>
        <div class="dot" data-step="3"></div>
        <div class="dot" data-step="4"></div>
        <div class="dot" data-step="5"></div>
      </div>

      <!-- Step 1: Mode Selection -->
      <div class="step active" data-step="1">
        <h2 class="step-title">Choose Your Space</h2>
        <p class="step-subtitle">How do you want your creations to live?</p>
        <div class="mode-grid">
          <div class="glass-card mode-card" data-mode="constellation">
            <span class="mode-icon"></span>
            <h3>Constellation</h3>
            <p>Creations float like stars in space. Drift and explore.</p>
          </div>
          <div class="glass-card mode-card" data-mode="garden">
            <span class="mode-icon"></span>
            <h3>Garden</h3>
            <p>Design your own room. Visitors knock before entering.</p>
          </div>
          <div class="glass-card mode-card" data-mode="canvas">
            <span class="mode-icon"></span>
            <h3>Infinite Canvas</h3>
            <p>One shared space. Place your work anywhere.</p>
          </div>
          <div class="glass-card mode-card" data-mode="seasonal">
            <span class="mode-icon"></span>
            <h3>Seasonal Flow</h3>
            <p>Content by moods and themes. Curated exhibitions.</p>
          </div>
        </div>
      </div>

      <!-- Step 2: Set Boundaries -->
      <div class="step" data-step="2">
        <h2 class="step-title">Set Your Boundaries</h2>
        <p class="step-subtitle">Control how others interact with your space</p>

        <div class="options-group">
          <p class="options-label">Who can see your creations?</p>
          <div class="options-list">
            <div class="glass-card option selected" data-value="everyone"> Everyone</div>
            <div class="glass-card option" data-value="connections"> Connections only</div>
            <div class="glass-card option" data-value="private"> Just me</div>
          </div>
        </div>

        <div class="options-group">
          <p class="options-label">Allow comments?</p>
          <div class="options-list">
            <div class="glass-card option selected" data-value="yes"> Yes, I'd love feedback</div>
            <div class="glass-card option" data-value="connections"> From connections only</div>
            <div class="glass-card option" data-value="no"> No, just reactions</div>
          </div>
        </div>
      </div>

      <!-- Step 3: Creative Preferences -->
      <div class="step" data-step="3">
        <h2 class="step-title">Creative Preferences</h2>
        <p class="step-subtitle">Customize your creative experience</p>

        <div class="options-group">
          <p class="options-label">What do you like to create?</p>
          <div class="options-list">
            <div class="glass-card option" data-value="writing"> Writing</div>
            <div class="glass-card option" data-value="art"> Visual Art</div>
            <div class="glass-card option" data-value="music"> Music</div>
            <div class="glass-card option" data-value="photos"> Photography</div>
            <div class="glass-card option" data-value="ideas"> Ideas & Thoughts</div>
          </div>
        </div>

        <div class="options-group">
          <p class="options-label">When are you most creative?</p>
          <div class="options-list">
            <div class="glass-card option" data-value="morning"> Morning</div>
            <div class="glass-card option selected" data-value="night"> Late night</div>
            <div class="glass-card option" data-value="anytime"> Whenever inspiration strikes</div>
          </div>
        </div>
      </div>

      <!-- Step 4: Discovery Settings -->
      <div class="step" data-step="4">
        <h2 class="step-title">Discovery Settings</h2>
        <p class="step-subtitle">How do you want to find inspiration?</p>

        <div class="options-group">
          <p class="options-label">Show me creations that are...</p>
          <div class="options-list">
            <div class="glass-card option selected" data-value="similar"> Similar to mine</div>
            <div class="glass-card option" data-value="different"> Different & surprising</div>
            <div class="glass-card option" data-value="popular"> Popular in community</div>
          </div>
        </div>

        <div class="options-group">
          <p class="options-label">Notification preference</p>
          <div class="options-list">
            <div class="glass-card option" data-value="all"> All activity</div>
            <div class="glass-card option selected" data-value="minimal"> Minimal & gentle</div>
            <div class="glass-card option" data-value="none"> None, I'll check in</div>
          </div>
        </div>
      </div>

      <!-- Step 5: Preview -->
      <div class="step" data-step="5">
        <h2 class="step-title">Your Creative Space Awaits</h2>
        <p class="step-subtitle">Here's what you've chosen</p>

        <div class="glass-card preview-card">
          <span class="preview-icon" id="previewIcon"></span>
          <h3 id="previewTitle">Constellation Mode</h3>
          <p id="previewDescription">Creations float like stars in space. Drift and explore. Similar ideas cluster together like galaxies.</p>
        </div>
      </div>

      <!-- Wizard Navigation -->
      <div class="wizard-nav">
        <button class="skip-btn" onclick="skipWizard()">Skip setup</button>
        <div class="nav-btns">
          <button class="btn btn-secondary" id="backBtn" onclick="prevStep()" style="display: none;">Back</button>
          <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Continue</button>
        </div>
      </div>

    </div>
  </div>

  <!-- PAGE 2: CREATIVE SPACE (Hidden until wizard done) -->
  <div class="page creative-page" id="creativePage">
    
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span></span>
      </div>
      <div class="header-right">
        <button class="create-btn" onclick="openCreateModal()">+ Create</button>
        <button class="settings-btn" onclick="openSettings()"></button>
      </div>
    </header>

    <!-- Constellation View -->
    <div class="constellation active" id="constellationView">
      <!-- Empty State -->
      <div class="constellation-empty-state">
        <div class="constellation-empty-icon"></div>
        <h3>Your Creative Constellation</h3>
        <p>Your creations will appear as stars in your personal constellation. Each piece you create adds a new point of light.</p>
        <button class="constellation-empty-btn" onclick="openCreateModal()">
          <span></span> Create Your First Star
        </button>
      </div>
      <!-- User creations will be dynamically added here as creation-node elements -->
    </div>

    <!-- Garden View -->
    <div class="garden-view" id="gardenView">
      <!-- Ambient Background -->
      <div class="garden-ambient-bg">
        <div class="garden-ambient-orb"></div>
        <div class="garden-ambient-orb"></div>
        <div class="garden-ambient-orb"></div>
        <div id="gardenFireflies"></div>
      </div>

      <main class="garden-main">
        <!-- Page Header -->
        <div class="garden-page-header">
          <h1><span></span> Garden Rooms</h1>
          <p>Personal gallery spaces where visitors knock before entering. Each room is a curated sanctuary.</p>
        </div>

        <!-- Your Room Section -->
        <div class="garden-section-divider">
          <span class="garden-section-title" id="userRoomsSectionTitle">Your Rooms</span>
        </div>

        <div class="garden-rooms-grid" id="userRoomsGrid" style="margin-bottom: 32px;">
          <!-- Your Room Card -->
          <div class="garden-room-card your-room" onclick="openGardenOnboarding()">
            <div class="garden-room-preview empty">
              <div class="garden-empty-icon"></div>
              <div class="garden-empty-text">Your garden begins here</div>
            </div>
            <div class="garden-room-info">
              <div class="garden-room-title"> Your Garden Room</div>
              <div class="garden-room-description">Every garden begins with a single seed. Yours starts here  a sanctuary others can visit, a world only you design.</div>
              <div class="garden-room-actions">
                <button class="garden-enter-btn" onclick="event.stopPropagation(); openGardenOnboarding()">
                  <span></span>
                  Plant Your First Seed
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Explore Rooms Section -->
        <div class="garden-section-divider">
          <span class="garden-section-title">Explore Rooms</span>
        </div>

        <!-- Ghost structures shown while rooms load -->
        <div class="garden-ghost-rooms" id="gardenGhostRooms">
          <div class="garden-ghost-room">
            <div class="garden-ghost-seed" style="top:30%;left:20%;animation-delay:-2s;"></div>
            <div class="garden-ghost-seed" style="top:60%;left:65%;animation-delay:-5s;"></div>
          </div>
          <div class="garden-ghost-room">
            <div class="garden-ghost-seed" style="top:40%;left:50%;animation-delay:-1s;"></div>
            <div class="garden-ghost-seed" style="top:70%;left:25%;animation-delay:-6s;"></div>
          </div>
          <div class="garden-ghost-room">
            <div class="garden-ghost-seed" style="top:25%;left:40%;animation-delay:-3s;"></div>
            <div class="garden-ghost-seed" style="top:65%;left:70%;animation-delay:-4s;"></div>
          </div>
        </div>

        <!-- Featured rooms grid (populated by JS) -->
        <div class="garden-rooms-grid" id="gardenRoomsGrid">
          <!-- Featured gardens load here -->
        </div>
      </main>

      <!-- Create Room Modal -->
      <div class="create-room-overlay" id="createRoomModal" onclick="closeCreateRoomModal()">
        <div class="create-room-modal" onclick="event.stopPropagation()">
          <div class="create-room-header">
            <div class="create-room-title"> New Room</div>
            <button class="create-room-close" onclick="closeCreateRoomModal()"></button>
          </div>
          <div class="create-room-cover-area" id="createRoomCoverArea" onclick="document.getElementById('createRoomCoverInput').click()">
            <img id="createRoomCoverPreview" alt="Cover">
            <span class="create-room-cover-icon"></span>
            <span>Add a cover image</span>
          </div>
          <input type="file" id="createRoomCoverInput" accept="image/*" style="display:none" onchange="previewCreateRoomCover(this)">
          <div class="create-room-body">
            <div class="room-edit-field">
              <div class="room-edit-label">Room Name</div>
              <input class="room-edit-input" id="createRoomName" type="text" placeholder="e.g. Chemistry Notes, Dream Journal..." maxlength="50">
            </div>
            <div class="room-edit-field">
              <div class="room-edit-label">About this room</div>
              <textarea class="room-edit-textarea" id="createRoomDesc" placeholder="What kind of creations live here?" maxlength="200"></textarea>
            </div>
            <div class="room-edit-field">
              <div class="room-edit-label">Mood</div>
              <div class="create-room-mood-grid">
                <div class="create-room-mood-option selected" onclick="selectCreateRoomMood(this,'calm')">
                  <span class="mood-icon"></span>Calm
                </div>
                <div class="create-room-mood-option" onclick="selectCreateRoomMood(this,'dreamy')">
                  <span class="mood-icon"></span>Dreamy
                </div>
                <div class="create-room-mood-option" onclick="selectCreateRoomMood(this,'energetic')">
                  <span class="mood-icon"></span>Energetic
                </div>
                <div class="create-room-mood-option" onclick="selectCreateRoomMood(this,'reflective')">
                  <span class="mood-icon"></span>Reflective
                </div>
              </div>
            </div>
            <div class="room-edit-actions">
              <button class="room-edit-cancel" onclick="closeCreateRoomModal()">Cancel</button>
              <button class="room-edit-save" onclick="saveNewRoom()"> Create Room</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Room Edit Modal -->
      <div class="room-edit-overlay" id="roomEditModal" onclick="closeRoomEditModal()">
        <div class="room-edit-modal" onclick="event.stopPropagation()">
          <div class="room-edit-cover-area" id="roomEditCoverArea" onclick="document.getElementById('roomCoverInput').click()">
            <img id="roomCoverPreview" alt="Cover">
            <div class="room-edit-cover-placeholder" id="roomCoverPlaceholder">
              <span></span>
              Tap to add a cover image
            </div>
          </div>
          <input type="file" id="roomCoverInput" accept="image/*" style="display:none" onchange="previewRoomCover(this)">
          <div class="room-edit-body">
            <div class="room-edit-field">
              <div class="room-edit-label">Room Name</div>
              <input class="room-edit-input" id="roomEditName" type="text" placeholder="Give your room a name..." maxlength="50">
            </div>
            <div class="room-edit-field">
              <div class="room-edit-label">About this room</div>
              <textarea class="room-edit-textarea" id="roomEditDesc" placeholder="What is this room about? What kind of creations live here?" maxlength="200"></textarea>
            </div>
            <div class="room-edit-actions">
              <button class="room-edit-cancel" onclick="closeRoomEditModal()">Cancel</button>
              <button class="room-edit-save" onclick="saveRoomSettings()"> Save Room</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Garden Onboarding Modal -->
      <div class="garden-onboarding-overlay" id="gardenOnboardingModal" onclick="closeGardenOnboarding()">
        <div class="garden-onboarding-modal" onclick="event.stopPropagation()">
          <div class="garden-onboarding-header">
            <div class="garden-onboarding-icon"></div>
            <div class="garden-onboarding-step">Step 1 of 2 &nbsp;&nbsp; Your Sanctuary</div>
            <div class="garden-onboarding-title">Choose your garden's mood</div>
            <div class="garden-onboarding-subtitle">This shapes how your space feels to visitors  the light, the atmosphere, the quiet.</div>
          </div>
          <div class="garden-onboarding-body">
            <div class="garden-mood-grid">
              <div class="garden-mood-option" onclick="selectOnboardingMood(this, 'calm')">
                <div class="garden-mood-option-emoji"></div>
                <div class="garden-mood-option-name">Calm</div>
                <div class="garden-mood-option-desc">Still waters. Soft light. Room to breathe.</div>
              </div>
              <div class="garden-mood-option" onclick="selectOnboardingMood(this, 'dreamy')">
                <div class="garden-mood-option-emoji"></div>
                <div class="garden-mood-option-name">Dreamy</div>
                <div class="garden-mood-option-desc">Moonlit corners. Soft haze. Half-remembered things.</div>
              </div>
              <div class="garden-mood-option" onclick="selectOnboardingMood(this, 'energetic')">
                <div class="garden-mood-option-emoji"></div>
                <div class="garden-mood-option-name">Energetic</div>
                <div class="garden-mood-option-desc">Warm tones. Early light. Creative momentum.</div>
              </div>
              <div class="garden-mood-option" onclick="selectOnboardingMood(this, 'reflective')">
                <div class="garden-mood-option-emoji"></div>
                <div class="garden-mood-option-name">Reflective</div>
                <div class="garden-mood-option-desc">Deep thoughts. Slow time. Words that surface.</div>
              </div>
            </div>
          </div>
          <div class="garden-onboarding-actions">
            <button class="garden-onboarding-skip" onclick="closeGardenOnboarding()">Maybe later</button>
            <button class="garden-onboarding-next" id="gardenOnboardingNext" disabled onclick="completeGardenOnboarding()">
              <span></span> Plant My Seed
            </button>
          </div>
        </div>
      </div>

      <!-- Knock Modal -->
      <div class="garden-modal-overlay" id="gardenKnockModal" onclick="closeGardenKnockModal(event)">
        <div class="garden-modal" onclick="event.stopPropagation()">
          <div class="garden-modal-header">
            <div class="garden-modal-icon"></div>
            <h2 class="garden-modal-title">Knock to Enter</h2>
            <p class="garden-modal-subtitle" id="gardenKnockModalSubtitle">Request access to Poetry Corner</p>
          </div>
          <div class="garden-modal-body">
            <label class="garden-knock-message-label">Leave a note (optional)</label>
            <textarea class="garden-knock-message" id="gardenKnockMessage" placeholder="Hi! I loved your work and would love to see more..."></textarea>
            <div class="garden-knock-suggestions">
              <button class="garden-knock-suggestion" onclick="setGardenKnockMessage('Just browsing, thank you!')">Just browsing </button>
              <button class="garden-knock-suggestion" onclick="setGardenKnockMessage('I love your work!')">Love your work </button>
              <button class="garden-knock-suggestion" onclick="setGardenKnockMessage('Found you through a friend.')">Via friend </button>
            </div>
          </div>
          <div class="garden-modal-actions">
            <button class="garden-modal-cancel" onclick="closeGardenKnockModal()">Cancel</button>
            <button class="garden-modal-submit" onclick="sendGardenKnock()">
              <span></span>
              Send Knock
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Room Interior  outside garden-view so z-index works correctly -->
    <div class="garden-room-interior" id="gardenRoomInterior">
      <!-- Sticky back button above hero -->
      <div class="interior-topbar">
        <button class="interior-hero-back" onclick="closeRoomInterior()">
           Back to Garden
        </button>
      </div>
      <!-- Hero -->
      <div class="interior-hero" id="interiorHero">
        <div class="interior-hero-bg" id="interiorHeroBg"></div>
        <div class="interior-hero-content">
          <div class="interior-mood-badge" id="interiorMoodBadge"></div>
          <span class="interior-room-emoji" id="interiorRoomEmoji"></span>
          <div class="interior-room-name" id="interiorRoomName"></div>
          <div class="interior-room-desc" id="interiorRoomDesc"></div>
          <div class="interior-hero-meta">
            <span> <span id="interiorAppreciations">0</span> appreciations</span>
            <span> <span id="interiorVisits">0</span> visits</span>
          </div>
          <div class="interior-growth-section">
            <div class="interior-growth-label">
              <span>Garden Growth</span>
              <span id="interiorGrowthPct">0%</span>
            </div>
            <div class="interior-growth-track">
              <div class="interior-growth-fill" id="interiorGrowthFill" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Body -->
      <div class="interior-body">
        <div class="interior-section-label">Creations</div>
        <div class="interior-creations-grid" id="interiorCreationsGrid">
          <!-- Populated by JS -->
        </div>

        <div class="interior-section-label">Recent Visitors</div>
        <div class="interior-visitor-log">
          <div class="interior-visitor-empty">
            <div class="interior-visitor-empty-icon"></div>
            <div class="interior-visitor-empty-text">Your garden is young. Visitors will leave quiet traces as they pass through.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Creation Detail Modal -->
    <div class="creation-detail-overlay" id="creationDetailOverlay" onclick="closeCreationDetail(event)">
      <div class="creation-detail-modal" onclick="event.stopPropagation()">
        <div class="creation-detail-header">
          <div class="creation-detail-emoji" id="detailEmoji"></div>
          <div class="creation-detail-meta">
            <div class="creation-detail-title" id="detailTitle"></div>
            <div class="creation-detail-tags" id="detailTags"></div>
          </div>
          <button class="creation-detail-close" onclick="closeCreationDetail()"></button>
        </div>
        <div class="creation-detail-body" id="detailBody"></div>
        <div class="creation-detail-footer">
          <div class="creation-detail-date" id="detailDate"></div>
          <button class="creation-detail-delete" id="detailDeleteBtn" onclick="deleteCurrentCreation()" style="display:none;">
             Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Seasonal Flow View -->
    <div class="seasonal-view winter" id="seasonalView">
      <!-- Particles -->
      <div class="seasonal-particles" id="seasonalParticles"></div>

      <main class="seasonal-main">
        <!-- Page Header -->
        <div class="seasonal-page-header">
          <h1><span id="seasonIcon"></span> Seasonal Flow</h1>
          <p>Content curated by mood and season. Discover what resonates with how you feel right now.</p>
        </div>

        <!-- Season Selector -->
        <div class="season-selector">
          <button class="season-btn active" data-season="winter" onclick="selectSeason('winter')">
            <span class="season-emoji"></span>
            <span class="season-name">Winter</span>
          </button>
          <button class="season-btn" data-season="spring" onclick="selectSeason('spring')">
            <span class="season-emoji"></span>
            <span class="season-name">Spring</span>
          </button>
          <button class="season-btn" data-season="summer" onclick="selectSeason('summer')">
            <span class="season-emoji"></span>
            <span class="season-name">Summer</span>
          </button>
          <button class="season-btn" data-season="autumn" onclick="selectSeason('autumn')">
            <span class="season-emoji"></span>
            <span class="season-name">Autumn</span>
          </button>
        </div>

        <!-- Mood Filters -->
        <div class="seasonal-mood-section">
          <div class="seasonal-mood-label">Filter by Mood</div>
          <div class="seasonal-mood-filters">
            <button class="seasonal-mood-filter active" data-mood="all" onclick="selectSeasonalMood(this)">All Moods</button>
            <button class="seasonal-mood-filter" data-mood="calm" onclick="selectSeasonalMood(this)"> Calm</button>
            <button class="seasonal-mood-filter" data-mood="reflective" onclick="selectSeasonalMood(this)"> Reflective</button>
            <button class="seasonal-mood-filter" data-mood="creative" onclick="selectSeasonalMood(this)"> Creative</button>
            <button class="seasonal-mood-filter" data-mood="cozy" onclick="selectSeasonalMood(this)"> Cozy</button>
            <button class="seasonal-mood-filter" data-mood="melancholy" onclick="selectSeasonalMood(this)"> Melancholy</button>
            <button class="seasonal-mood-filter" data-mood="hopeful" onclick="selectSeasonalMood(this)"> Hopeful</button>
          </div>
        </div>

        <!-- Empty State -->
        <div class="seasonal-empty-state-main">
          <div class="seasonal-empty-state-icon"></div>
          <h3>No Seasonal Creations Yet</h3>
          <p>Be the first to share something for this season. Your creations will be curated and displayed based on mood and season.</p>
          <button class="seasonal-empty-state-btn" onclick="openCreateModal()">
            <span></span> Create Something
          </button>
        </div>

        <!-- Creations Container (for future content) -->
        <div class="seasonal-creations-container" id="seasonalCreationsGrid">
          <!-- Creations will be dynamically loaded here -->
        </div>
      </main>
    </div>

          <!-- Infinite Canvas View -->
    <div class="canvas-view" id="canvasView">
      <div class="canvas-container">
        <div class="infinite-canvas" id="infiniteCanvas">
          <div class="canvas-grid"></div>
          <div class="center-marker"></div>

          <!-- Canvas Empty State (centered) -->
          <div class="canvas-empty-state" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
            <div class="canvas-empty-icon"></div>
            <h3>Your Infinite Canvas</h3>
            <p>Create something and watch it appear here. Drag to explore, click to interact.</p>
            <button class="canvas-empty-btn" onclick="openCreateModal()">
              <span></span> Add Your First Creation
            </button>
          </div>

          <!-- User Creations Container -->
          <div id="canvasCreationsContainer">
            <!-- User creations will be dynamically added here -->
          </div>
        </div>
      </div>

      <!-- Canvas Toolbar -->
      <div class="canvas-toolbar">
        <button class="tool-btn active" data-tool="pan" onclick="setCanvasTool('pan')" title="Pan (Drag)"></button>
        <button class="tool-btn" data-tool="select" onclick="setCanvasTool('select')" title="Select"></button>
        <span class="tool-separator"></span>
        <button class="tool-btn" onclick="goToCanvasCenter()" title="Go to Center"></button>
        <button class="tool-btn" onclick="goToRandomCreation()" title="Random Creation"></button>
      </div>

      <!-- Minimap -->
      <div class="minimap">
        <div class="minimap-header">Navigator</div>
        <div class="minimap-canvas" id="minimapCanvas" onclick="minimapClick(event)">
          <div class="minimap-dot" style="left: 47%; top: 46%;"></div>
          <div class="minimap-dot" style="left: 52%; top: 43%;"></div>
          <div class="minimap-dot" style="left: 43%; top: 51%;"></div>
          <div class="minimap-dot" style="left: 56%; top: 48%;"></div>
          <div class="minimap-dot" style="left: 41%; top: 42%;"></div>
          <div class="minimap-dot" style="left: 51%; top: 53%;"></div>
          <div class="minimap-dot" style="left: 58%; top: 45%;"></div>
          <div class="minimap-dot" style="left: 46%; top: 56%;"></div>
          <div class="minimap-dot" style="left: 55%; top: 57%;"></div>
          <div class="minimap-dot" style="left: 40%; top: 50%;"></div>
          <div class="minimap-dot" style="left: 61%; top: 51%;"></div>
          <div class="minimap-dot" style="left: 48%; top: 41%;"></div>
          <div class="minimap-viewport" id="minimapViewport"></div>
        </div>
      </div>

      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="canvasZoomIn()">+</button>
        <div class="zoom-level" id="zoomLevel">100%</div>
        <button class="zoom-btn" onclick="canvasZoomOut()"></button>
        <button class="zoom-btn" onclick="resetCanvasZoom()" title="Reset"></button>
      </div>

      <!-- Canvas Hints -->
      <div class="canvas-hint-bar">
        <div class="hint-item">
          <span class="hint-key">Drag</span>
          <span>Pan</span>
        </div>
        <div class="hint-item">
          <span class="hint-key">Scroll</span>
          <span>Zoom</span>
        </div>
        <div class="hint-item">
          <span class="hint-key">Home</span>
          <span>Center</span>
        </div>
      </div>

      <!-- Placement Mode Indicator -->
      <div class="placement-mode" id="placementMode">
        <span> Click anywhere to place your creation</span>
        <button class="cancel-placement" onclick="cancelPlacement()">Cancel</button>
      </div>
    </div>

    <div class="hint" id="mainHint">Drag to explore  Click creations to view  Scroll to zoom</div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
  </div>

  <!-- Create Modal -->
  <div class="create-modal-overlay" id="createModal">
    <div class="create-modal">
      <button class="create-modal-close" onclick="closeCreateModal()"></button>
      <div class="create-modal-header">
        <h2 class="create-modal-title">Create Something New</h2>
        <p class="create-modal-subtitle">What would you like to share with the world?</p>
      </div>
      <div class="create-modal-body">
        <!-- Step 1: Choose Type -->
        <div class="create-step active" id="createStep1">
          <div class="create-type-grid">
            <div class="create-type-card" onclick="selectCreateType(this, 'writing')">
              <span class="create-type-icon"></span>
              <div class="create-type-name">Writing</div>
              <div class="create-type-desc">Poetry, prose, thoughts</div>
            </div>
            <div class="create-type-card" onclick="selectCreateType(this, 'visual')">
              <span class="create-type-icon"></span>
              <div class="create-type-name">Visual Art</div>
              <div class="create-type-desc">Drawings, paintings, photos</div>
            </div>
            <div class="create-type-card" onclick="selectCreateType(this, 'music')">
              <span class="create-type-icon"></span>
              <div class="create-type-name">Music</div>
              <div class="create-type-desc">Songs, compositions, sounds</div>
            </div>
            <div class="create-type-card" onclick="selectCreateType(this, 'idea')">
              <span class="create-type-icon"></span>
              <div class="create-type-name">Idea</div>
              <div class="create-type-desc">Concepts, musings, sparks</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Create Content -->
        <div class="create-step" id="createStep2">
          <button class="create-back-btn" onclick="goToCreateStep(1)"> Back to types</button>

          <div class="create-input-group">
            <label class="create-input-label">Title <span class="required">*</span></label>
            <input type="text" class="create-input" id="createTitle" placeholder="Give your creation a name...">
          </div>

          <!-- Writing Content Area -->
          <div class="create-content-area" id="contentWriting">
            <label class="create-input-label">Your Writing <span class="required">*</span></label>
            <div class="writing-toolbar">
              <button type="button" onclick="formatText('bold')" title="Bold"><b>B</b></button>
              <button type="button" onclick="formatText('italic')" title="Italic"><i>I</i></button>
              <button type="button" onclick="formatText('heading')" title="Heading">H</button>
              <span class="toolbar-divider"></span>
              <button type="button" onclick="formatText('quote')" title="Quote">"</button>
              <button type="button" onclick="formatText('list')" title="List"></button>
            </div>
            <textarea class="create-input create-content-editor" id="writingContent" placeholder="Start writing your piece...

Tips:
 Use line breaks to separate stanzas or paragraphs
 Express yourself freely - there's no wrong way to create
 Your work can be as short or long as you'd like"></textarea>
            <div class="content-footer">
              <span class="word-count" id="wordCount">0 words</span>
              <label class="upload-alt">
                <input type="file" accept=".txt,.md,.doc,.docx" onchange="importWritingFile(event)" hidden>
                <span> Import from file</span>
              </label>
            </div>
          </div>

          <!-- Visual Art Content Area -->
          <div class="create-content-area" id="contentVisual" style="display: none;">
            <label class="create-input-label">Your Artwork <span class="required">*</span></label>
            <div class="upload-zone" id="visualUploadZone" onclick="document.getElementById('visualFileInput').click()">
              <input type="file" id="visualFileInput" accept="image/*" onchange="handleVisualUpload(event)" hidden>
              <div class="upload-zone-content" id="visualUploadContent">
                <span class="upload-icon"></span>
                <p class="upload-text">Click to upload or drag & drop</p>
                <p class="upload-hint">PNG, JPG, GIF, WebP (max 10MB)</p>
              </div>
              <div class="upload-preview" id="visualPreview" style="display: none;">
                <img id="visualPreviewImg" src="" alt="Preview">
                <button class="remove-upload" onclick="removeVisualUpload(event)"> Remove</button>
              </div>
            </div>
            <div class="create-input-group" style="margin-top: 16px;">
              <label class="create-input-label">Art Description (optional)</label>
              <textarea class="create-input create-textarea" id="visualDescription" placeholder="What inspired this piece? What techniques did you use?"></textarea>
            </div>
          </div>

          <!-- Music Content Area -->
          <div class="create-content-area" id="contentMusic" style="display: none;">
            <label class="create-input-label">Your Music <span class="required">*</span></label>
            <div class="music-options">
              <button class="music-option-btn active" onclick="switchMusicOption('upload')"> Upload File</button>
              <button class="music-option-btn" onclick="switchMusicOption('link')"> Add Link</button>
            </div>
            <div class="music-upload-area" id="musicUploadArea">
              <div class="upload-zone" id="musicUploadZone" onclick="document.getElementById('musicFileInput').click()">
                <input type="file" id="musicFileInput" accept="audio/*" onchange="handleMusicUpload(event)" hidden>
                <div class="upload-zone-content" id="musicUploadContent">
                  <span class="upload-icon"></span>
                  <p class="upload-text">Click to upload audio file</p>
                  <p class="upload-hint">MP3, WAV, OGG, M4A (max 20MB)</p>
                </div>
                <div class="upload-preview audio-preview" id="musicPreview" style="display: none;">
                  <span class="audio-icon"></span>
                  <span class="audio-name" id="musicFileName"></span>
                  <button class="remove-upload" onclick="removeMusicUpload(event)"></button>
                </div>
              </div>
            </div>
            <div class="music-link-area" id="musicLinkArea" style="display: none;">
              <input type="text" class="create-input" id="musicLink" placeholder="Paste a SoundCloud, Spotify, or YouTube link...">
              <p class="input-hint">Share music from your favorite platforms</p>
            </div>
            <div class="create-input-group" style="margin-top: 16px;">
              <label class="create-input-label">About this piece (optional)</label>
              <textarea class="create-input create-textarea" id="musicDescription" placeholder="What's the story behind this music? What mood were you in?"></textarea>
            </div>
          </div>

          <!-- Idea Content Area -->
          <div class="create-content-area" id="contentIdea" style="display: none;">
            <label class="create-input-label">Your Idea <span class="required">*</span></label>
            <textarea class="create-input create-content-editor" id="ideaContent" placeholder="Share your idea, concept, or spark of inspiration...

This could be:
 A concept you've been thinking about
 A shower thought worth sharing
 An idea for a project or collaboration
 A philosophical musing
 Anything that sparked your curiosity"></textarea>
            <div class="create-input-group" style="margin-top: 16px;">
              <label class="create-input-label">Tags (optional)</label>
              <input type="text" class="create-input" id="ideaTags" placeholder="Add tags separated by commas (e.g., philosophy, creativity, nature)">
            </div>
          </div>

          <!-- Common Fields -->
          <div class="create-input-group">
            <label class="create-input-label">Mood</label>
            <div class="mood-options">
              <div class="mood-option" onclick="selectCreateMood(this, 'reflective')"> Reflective</div>
              <div class="mood-option" onclick="selectCreateMood(this, 'hopeful')"> Hopeful</div>
              <div class="mood-option" onclick="selectCreateMood(this, 'melancholic')"> Melancholic</div>
              <div class="mood-option" onclick="selectCreateMood(this, 'peaceful')"> Peaceful</div>
              <div class="mood-option" onclick="selectCreateMood(this, 'energetic')"> Energetic</div>
              <div class="mood-option" onclick="selectCreateMood(this, 'nostalgic')"> Nostalgic</div>
            </div>
          </div>

          <div class="create-input-group">
            <label class="create-input-label">Visibility</label>
            <div class="visibility-options">
              <label class="visibility-option">
                <input type="radio" name="visibility" value="public" checked>
                <span class="visibility-card">
                  <span class="visibility-icon"></span>
                  <span class="visibility-name">Public</span>
                  <span class="visibility-desc">Anyone can see</span>
                </span>
              </label>
              <label class="visibility-option">
                <input type="radio" name="visibility" value="community">
                <span class="visibility-card">
                  <span class="visibility-icon"></span>
                  <span class="visibility-name">Community</span>
                  <span class="visibility-desc">Only community members</span>
                </span>
              </label>
              <label class="visibility-option">
                <input type="radio" name="visibility" value="private">
                <span class="visibility-card">
                  <span class="visibility-icon"></span>
                  <span class="visibility-name">Private</span>
                  <span class="visibility-desc">Only you can see</span>
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="create-modal-footer">
        <button class="create-modal-btn cancel" onclick="closeCreateModal()">Cancel</button>
        <button class="create-modal-btn submit" id="createSubmitBtn" onclick="submitCreation()" disabled>Create & Share </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==================== SUPABASE INIT ====================
    const SUPABASE_URL = 'https://dlgntsscabbhdqlxqpwd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsZ250c3NjYWJiaGRxbHhxcHdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDAyMzYsImV4cCI6MjA3MDI3NjIzNn0.FIyWgqehDBMMQCN3nl-dPfkDAPjv_-dFBvmGHgABEBA';

    let db = null;
    let currentUser = null;

    try {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
      console.error('Supabase init error:', err);
    }

    async function initAuth() {
      if (!db) return;
      try {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
          currentUser = session.user;
        }
      } catch (err) {
        console.error('Auth error:', err);
      }
    }

    // Initialize auth on load
    initAuth();

    // ==================== WIZARD ====================
    let step = 1;
    const totalSteps = 5;
    let selectedMode = 'constellation'; // Track selected mode

    // Mode data for preview
    const modeData = {
      constellation: {
        icon: '',
        title: 'Constellation Mode',
        description: 'Creations float like stars in space. Drift and explore. Similar ideas cluster together like galaxies.'
      },
      garden: {
        icon: '',
        title: 'Garden Mode',
        description: 'Design your own room. Visitors knock before entering. Arrange your work however you want.'
      },
      canvas: {
        icon: '',
        title: 'Infinite Canvas Mode',
        description: 'One shared space. Place your work anywhere. Zoom to discover. A living tapestry that grows.'
      },
      seasonal: {
        icon: '',
        title: 'Seasonal Flow Mode',
        description: 'Content by moods and themes. Curated exhibitions. Slower, intentional discovery.'
      }
    };

    function updateWizard() {
      // Steps
      document.querySelectorAll('.step').forEach(s => {
        s.classList.toggle('active', parseInt(s.dataset.step) === step);
      });

      // Dots
      document.querySelectorAll('.dot').forEach(d => {
        const dStep = parseInt(d.dataset.step);
        d.classList.remove('active', 'done');
        if (dStep === step) d.classList.add('active');
        else if (dStep < step) d.classList.add('done');
      });

      // Buttons
      document.getElementById('backBtn').style.display = step > 1 ? 'inline-block' : 'none';
      document.getElementById('nextBtn').textContent = step === totalSteps ? 'Enter Your Space' : 'Continue';

      // Update preview card when on step 5
      if (step === 5) {
        updatePreviewCard();
      }
    }

    function updatePreviewCard() {
      const mode = modeData[selectedMode];
      document.getElementById('previewIcon').textContent = mode.icon;
      document.getElementById('previewTitle').textContent = mode.title;
      document.getElementById('previewDescription').textContent = mode.description;
    }

    function nextStep() {
      if (step < totalSteps) {
        step++;
        updateWizard();
      } else {
        enterSpace();
      }
    }

    function prevStep() {
      if (step > 1) {
        step--;
        updateWizard();
      }
    }

    function enterSpace() {
      document.getElementById('wizardPage').classList.remove('active');
      document.getElementById('creativePage').classList.add('active');

      // Show the correct view based on selected mode
      if (selectedMode === 'canvas') {
        showViewByName('canvas');
        initInfiniteCanvas();
      } else if (selectedMode === 'garden') {
        showViewByName('garden');
      } else if (selectedMode === 'seasonal') {
        showViewByName('seasonal');
        initSeasonalParticles();
      } else {
        showViewByName('constellation');
        initConstellation();
      }
    }

    // Select a mode and enter the creative space directly
    function selectModeAndEnter(mode) {
      selectedMode = mode;
      enterSpace();
    }

    // Helper to show view without event
    function showViewByName(view) {
      document.querySelectorAll('.mode-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase().includes(view));
      });
      document.getElementById('constellationView').classList.toggle('active', view === 'constellation');
      document.getElementById('gardenView').classList.toggle('active', view === 'garden');
      document.getElementById('canvasView').classList.toggle('active', view === 'canvas');
      document.getElementById('seasonalView').classList.toggle('active', view === 'seasonal');

      const mainHint = document.getElementById('mainHint');
      if (mainHint) {
        mainHint.style.display = (view === 'canvas' || view === 'garden' || view === 'seasonal') ? 'none' : 'block';
      }

      // Initialize seasonal particles when showing seasonal view
      if (view === 'seasonal') {
        initSeasonalParticles();
      }

      // Initialize garden world when showing garden view
      if (view === 'garden') {
        initGardenWorld();
      }

      // Show/hide constellation controls
      const constCtrl = document.getElementById('constControls');
      if (constCtrl) constCtrl.classList.toggle('visible', view === 'constellation');

      // Swap the create button label for garden vs other views
      const createBtn = document.querySelector('.create-btn');
      if (createBtn) {
        if (view === 'garden') {
          createBtn.textContent = '+ Room';
          createBtn.onclick = openCreateRoomModal;
        } else {
          createBtn.textContent = '+ Create';
          createBtn.onclick = openCreateModal;
        }
      }
    }

    function openSettings() {
      document.getElementById('creativePage').classList.remove('active');
      document.getElementById('wizardPage').classList.add('active');
    }

    // Mode cards selection
    document.querySelectorAll('.mode-card').forEach(card => {
      card.onclick = function() {
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        // Track the selected mode
        selectedMode = this.dataset.mode;
      };
    });

    // Skip wizard and enter with defaults
    function skipWizard() {
      enterSpace();
    }

    // Option selection
    document.querySelectorAll('.options-list').forEach(list => {
      list.querySelectorAll('.option').forEach(opt => {
        opt.onclick = function() {
          list.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
        };
      });
    });

    // ==================== VIEWS ====================
    function showView(view) {
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('constellationView').classList.toggle('active', view === 'constellation');
      document.getElementById('gardenView').classList.toggle('active', view === 'garden');
      document.getElementById('canvasView').classList.toggle('active', view === 'canvas');
      document.getElementById('seasonalView').classList.toggle('active', view === 'seasonal');

      // Show/hide appropriate hints
      const mainHint = document.getElementById('mainHint');
      if (mainHint) {
        mainHint.style.display = (view === 'canvas' || view === 'garden' || view === 'seasonal') ? 'none' : 'block';
      }

      // Initialize canvas when switching to canvas view
      if (view === 'canvas') {
        initInfiniteCanvas();
      }

      // Initialize seasonal when switching to seasonal view
      if (view === 'seasonal') {
        initSeasonalParticles();
      }

      // Initialize garden world when switching to garden view
      if (view === 'garden') {
        initGardenWorld();
      }
    }

    // ==================== CONSTELLATION ====================
    let constellationInitialized = false;
    let activeStarCreation = null;
    const TYPE_COLORS = {
      writing: '#c4a1ff', visual: '#7cb8e8', music: '#7ce8a8', idea: '#e8c87c'
    };
    const TYPE_EMOJIS_CONST = { writing: '', visual: '', music: '', idea: '' };
    // Cluster angles: degrees from center
    const CLUSTER_ANGLES = { writing: 45, visual: 135, music: 225, idea: 315 };
    const CLUSTER_NAMES = { writing: 'Writing', visual: 'Visual', music: 'Music', idea: 'Ideas' };
    // Track node positions for line drawing
    const clusterNodes = { writing: [], visual: [], music: [], idea: [] };

    function initConstellation() {
      if (constellationInitialized) return;
      constellationInitialized = true;

      const el = document.getElementById('constellationView');
      const emptyState = el.querySelector('.constellation-empty-state');

      // Nebula clouds
      [
        { c:'rgba(196,161,255,0.04)', s:550, x:18, y:28 },
        { c:'rgba(124,184,232,0.04)', s:420, x:75, y:65 },
        { c:'rgba(124,232,168,0.03)', s:500, x:45, y:78 },
      ].forEach(n => {
        const d = document.createElement('div');
        d.className = 'const-nebula';
        d.style.cssText = `width:${n.s}px;height:${n.s}px;background:${n.c};left:${n.x}%;top:${n.y}%;transform:translate(-50%,-50%)`;
        el.appendChild(d);
      });

      // SVG lines layer
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('class','const-lines-svg');
      svg.setAttribute('id','constLinesSvg');
      el.appendChild(svg);

      // Parallax star layer
      const parallax = document.createElement('div');
      parallax.className = 'const-parallax';
      parallax.id = 'constParallax';
      for (let i = 0; i < 130; i++) {
        const s = document.createElement('div');
        const sz = ['sm','sm','sm','sm','md','md','lg'][Math.floor(Math.random()*7)];
        s.className = 'star ' + sz;
        s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;--td:${(3+Math.random()*5).toFixed(1)}s;--dl:${(-Math.random()*5).toFixed(1)}s`;
        parallax.appendChild(s);
      }
      el.appendChild(parallax);

      // Center user star
      const center = document.createElement('div');
      center.className = 'user-center-star';
      center.id = 'userCenterStar';
      center.style.cssText = 'left:50%;top:50%';
      center.innerHTML = `<div class="user-star-core"><div class="user-star-ring"></div><div class="user-star-ring-2"></div></div><div class="user-star-label">You</div>`;
      el.appendChild(center);

      // Cluster labels
      Object.keys(CLUSTER_ANGLES).forEach(type => {
        const angle = CLUSTER_ANGLES[type] * Math.PI / 180;
        const r = Math.min(window.innerWidth, window.innerHeight) * 0.28;
        const lx = 50 + (r / window.innerWidth) * 100 * Math.cos(angle);
        const ly = 50 + (r / window.innerHeight) * 100 * Math.sin(angle);
        const lbl = document.createElement('div');
        lbl.className = 'cluster-label';
        lbl.id = 'clabel-' + type;
        lbl.style.cssText = `left:${lx}%;top:${ly}%`;
        lbl.textContent = CLUSTER_NAMES[type];
        el.appendChild(lbl);
      });

      // Info card
      let card = document.getElementById('starInfoCard');
      if (!card) {
        card = document.createElement('div');
        card.className = 'star-info-card';
        card.id = 'starInfoCard';
        card.innerHTML = `<button class="star-info-close" onclick="hideStarInfoCard()"></button><div class="star-info-type" id="starInfoType"></div><div class="star-info-title" id="starInfoTitle"></div><div class="star-info-snippet" id="starInfoSnippet"></div><div class="star-info-actions"><button class="star-info-btn" onclick="hideStarInfoCard()">Close Space</button><button class="star-info-btn danger" id="starInfoDelete">Remove</button></div>`;
        document.body.appendChild(card);
      }

      // Controls
      let controls = document.getElementById('constControls');
      if (!controls) {
        controls = document.createElement('div');
        controls.className = 'const-controls';
        controls.id = 'constControls';
        controls.innerHTML = `<button class="const-control-btn active" id="filterAll" title="All" onclick="filterConstellation(null,this)"></button><button class="const-control-btn" title="Writing" onclick="filterConstellation('writing',this)"></button><button class="const-control-btn" title="Visual" onclick="filterConstellation('visual',this)"></button><button class="const-control-btn" title="Music" onclick="filterConstellation('music',this)"></button><button class="const-control-btn" title="Ideas" onclick="filterConstellation('idea',this)"></button>`;
        document.body.appendChild(controls);
      }
      controls.classList.add('visible');

      // Parallax on mouse move
      el.addEventListener('mousemove', e => {
        const dx = (e.clientX / window.innerWidth - 0.5) * 18;
        const dy = (e.clientY / window.innerHeight - 0.5) * 18;
        const p = document.getElementById('constParallax');
        if (p) p.style.transform = `translate(${dx}px,${dy}px)`;
      });

      // Close card on background click
      el.addEventListener('click', e => {
        if (!e.target.closest('.creation-node') && !e.target.closest('#starInfoCard')) hideStarInfoCard();
      });

      // Load creations  own go into personal galaxy, others become distant galaxies
      async function loadConstellationCreations() {
        // Always resolve auth fresh to avoid race condition where currentUser is still null
        let myId = currentUser ? currentUser.id : null;
        if (!myId && db) {
          try {
            const { data: { session } } = await db.auth.getSession();
            if (session) myId = session.user.id;
          } catch(e) {}
        }

        // Purge any cached creations that don't belong to the current user.
        // Old code fetched all users' public creations into localStorage  remove them now.
        if (myId) {
          try {
            const saved = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
            const clean = saved.filter(c => c.user_id === myId);
            if (clean.length !== saved.length) {
              localStorage.setItem('introvert_creations', JSON.stringify(clean));
            }
          } catch(e) {}
        }

        let ownCreations = [];
        let othersByUser = {}; // { userId: { username, creations[] } }

        if (db && myId) {
          // Query 1: ALL of the current user's own creations (no view_mode filter so nothing is lost)
          try {
            const { data: myData } = await db
              .from('creations')
              .select('id, type, title, content, description, mood, view_mode, user_id')
              .eq('user_id', myId)
              .order('created_at', { ascending: false })
              .limit(100);
            if (myData) ownCreations = myData;
          } catch(e) {}

          // Query 2: Other users' public creations  shown as distant galaxies
          // No view_mode filter so we never miss a user whose creation was saved with a different value
          try {
            const { data: othersData } = await db
              .from('creations')
              .select('id, type, title, content, description, mood, view_mode, user_id')
              .in('visibility', ['public', 'community'])
              .neq('user_id', myId)
              .order('created_at', { ascending: false })
              .limit(60);

            if (othersData && othersData.length > 0) {
              const otherUserIds = new Set();
              othersData.forEach(c => {
                if (!c.user_id) return;
                otherUserIds.add(c.user_id);
                if (!othersByUser[c.user_id]) othersByUser[c.user_id] = { username: null, creations: [] };
                othersByUser[c.user_id].creations.push(c);
              });

              // Fetch usernames for other users
              if (otherUserIds.size > 0) {
                try {
                  const { data: profiles } = await db
                    .from('profiles')
                    .select('id, username')
                    .in('id', Array.from(otherUserIds));
                  if (profiles) {
                    profiles.forEach(p => {
                      if (othersByUser[p.id]) othersByUser[p.id].username = p.username || 'Anonymous';
                    });
                  }
                } catch(e) {}
              }
            }
          } catch(e) {}
        }

        // Merge local-only creations for own galaxy (no user_id = pre-login local, or matches myId)
        try {
          const local = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
          local
            .filter(c => c.user_id === myId)
            .forEach(lc => {
              if (!ownCreations.find(c => String(c.id) === String(lc.id))) ownCreations.push(lc);
            });
        } catch(e) {}

        // Also clear any stale dismissed list from previous buggy code
        localStorage.removeItem('dismissed_constellation_ids');

        // Render own creations into personal galaxy
        if (ownCreations.length > 0) {
          if (emptyState) emptyState.style.display = 'none';
          ownCreations.forEach(c => addCreationToConstellation(c));
        }

        // Render other users as distant galaxies
        const otherEntries = Object.entries(othersByUser);
        otherEntries.forEach(([userId, info], idx) => {
          addDistantGalaxy(userId, info.username || 'Anonymous', info.creations, idx, otherEntries.length);
        });
      }
      loadConstellationCreations();
    }

    // ==================== INFINITE CANVAS ====================
    let canvasPanX = 0;
    let canvasPanY = 0;
    let canvasZoom = 1;
    let isCanvasDragging = false;
    let canvasStartX, canvasStartY;
    let currentCanvasTool = 'pan';
    let isPlacing = false;
    let canvasInitialized = false;

    function initInfiniteCanvas() {
      if (canvasInitialized) return;
      canvasInitialized = true;

      const canvasContainer = document.querySelector('.canvas-view .canvas-container');
      const canvas = document.getElementById('infiniteCanvas');

      // Mouse events for panning
      canvasContainer.addEventListener('mousedown', (e) => {
        if (e.target.closest('.canvas-toolbar') || e.target.closest('.minimap') ||
            e.target.closest('.zoom-controls') || e.target.closest('.canvas-hint-bar') ||
            e.target.closest('.placement-mode')) return;

        if (isPlacing) {
          placeCreation(e);
          return;
        }

        if (e.target.closest('.canvas-creation')) return;

        isCanvasDragging = true;
        canvasStartX = e.clientX - canvasPanX;
        canvasStartY = e.clientY - canvasPanY;
        document.body.classList.add('canvas-dragging');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isCanvasDragging) return;
        canvasPanX = e.clientX - canvasStartX;
        canvasPanY = e.clientY - canvasStartY;
        updateInfiniteCanvas();
      });

      document.addEventListener('mouseup', () => {
        isCanvasDragging = false;
        document.body.classList.remove('canvas-dragging');
      });

      // Scroll to zoom (only when canvas is active)
      canvasContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        canvasZoom = Math.max(0.25, Math.min(2, canvasZoom + delta));
        updateInfiniteCanvas();
      }, { passive: false });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (!document.getElementById('canvasView').classList.contains('active')) return;

        if (e.key === 'Escape') {
          cancelPlacement();
        } else if (e.key === 'Home') {
          goToCanvasCenter();
        } else if (e.key === '+' || e.key === '=') {
          canvasZoomIn();
        } else if (e.key === '-') {
          canvasZoomOut();
        }
      });

      // Initial canvas position
      updateInfiniteCanvas();
    }

    function updateInfiniteCanvas() {
      const canvas = document.getElementById('infiniteCanvas');
      canvas.style.transform = `translate(calc(-50% + ${canvasPanX}px), calc(-50% + ${canvasPanY}px)) scale(${canvasZoom})`;
      updateMinimap();
      updateZoomLevel();
    }

    function canvasZoomIn() {
      canvasZoom = Math.min(2, canvasZoom + 0.2);
      updateInfiniteCanvas();
    }

    function canvasZoomOut() {
      canvasZoom = Math.max(0.25, canvasZoom - 0.2);
      updateInfiniteCanvas();
    }

    function resetCanvasZoom() {
      canvasZoom = 1;
      canvasPanX = 0;
      canvasPanY = 0;
      updateInfiniteCanvas();
      showToast(' Reset to center');
    }

    function updateZoomLevel() {
      const zoomEl = document.getElementById('zoomLevel');
      if (zoomEl) {
        zoomEl.textContent = Math.round(canvasZoom * 100) + '%';
      }
    }

    function updateMinimap() {
      const viewport = document.getElementById('minimapViewport');
      if (!viewport) return;

      const mapWidth = 200;
      const mapHeight = 110;
      const canvasSize = 8000;

      const viewportW = (window.innerWidth / canvasZoom / canvasSize) * mapWidth;
      const viewportH = (window.innerHeight / canvasZoom / canvasSize) * mapHeight;

      const viewportX = ((canvasSize / 2 - canvasPanX / canvasZoom) / canvasSize) * mapWidth - viewportW / 2;
      const viewportY = ((canvasSize / 2 - canvasPanY / canvasZoom) / canvasSize) * mapHeight - viewportH / 2;

      viewport.style.width = Math.max(20, viewportW) + 'px';
      viewport.style.height = Math.max(14, viewportH) + 'px';
      viewport.style.left = Math.max(0, Math.min(mapWidth - viewportW, viewportX)) + 'px';
      viewport.style.top = Math.max(0, Math.min(mapHeight - viewportH, viewportY)) + 'px';
    }

    function minimapClick(e) {
      const rect = e.currentTarget.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      canvasPanX = (0.5 - x) * 8000 * canvasZoom;
      canvasPanY = (0.5 - y) * 8000 * canvasZoom;
      updateInfiniteCanvas();
    }

    function goToCanvasCenter() {
      canvasPanX = 0;
      canvasPanY = 0;
      canvasZoom = 1;
      updateInfiniteCanvas();
      showToast(' Returned to center');
    }

    function goToRandomCreation() {
      const creations = document.querySelectorAll('.canvas-creation');
      if (creations.length === 0) return;

      const random = creations[Math.floor(Math.random() * creations.length)];
      const left = parseInt(random.style.left);
      const top = parseInt(random.style.top);

      canvasPanX = (4000 - left) * canvasZoom;
      canvasPanY = (4000 - top) * canvasZoom;
      updateInfiniteCanvas();

      const title = random.querySelector('.creation-title').textContent;
      showToast(` Found: ${title}`);
    }

    function setCanvasTool(tool) {
      currentCanvasTool = tool;
      document.querySelectorAll('.canvas-toolbar .tool-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.canvas-toolbar [data-tool="${tool}"]`).classList.add('active');

      const container = document.querySelector('.canvas-view .canvas-container');
      if (tool === 'pan') {
        container.style.cursor = 'grab';
      } else if (tool === 'select') {
        container.style.cursor = 'default';
      }
    }

    function startPlacement() {
      isPlacing = true;
      document.body.classList.add('canvas-placing');
      document.getElementById('placementMode').classList.add('active');
      showToast(' Click anywhere on the canvas to place');
    }

    function cancelPlacement() {
      isPlacing = false;
      document.body.classList.remove('canvas-placing');
      document.getElementById('placementMode').classList.remove('active');
    }

    function placeCreation(e) {
      cancelPlacement();
      showToast(' Creation placed! Opening editor...');
      // In real app, open creation modal
    }

    function openCanvasCreation(title) {
      showToast(` Opening: ${title}...`);
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ==================== GARDEN ====================
    let currentKnockRoom = '';
    let currentKnockOwner = '';

    // Seeded featured rooms (mirrors the DB migration data)
    const FEATURED_GARDEN_ROOMS = [
      {
        name: 'Midnight Poetry Garden',
        description: 'A quiet corner where words bloom under moonlight. Leave a verse, take a breath.',
        mood: 'dreamy',
        emoji: '',
        gradient: 'linear-gradient(135deg, rgba(196,161,255,0.35), rgba(124,184,232,0.25)), #141c14',
        glowClass: 'garden-room-dreamy-glow',
        growthLevel: 75,
        appreciations: 124,
        visits: 89,
        status: 'quiet'
      },
      {
        name: 'Quiet Sketch Sanctuary',
        description: 'Pencil lines and soft shadows. A place for visual whispers and half-finished ideas.',
        mood: 'calm',
        emoji: '',
        gradient: 'linear-gradient(135deg, rgba(232,168,124,0.35), rgba(240,232,124,0.25)), #141c14',
        glowClass: 'garden-room-warm-glow',
        growthLevel: 60,
        appreciations: 87,
        visits: 63,
        status: 'open'
      },
      {
        name: 'Dream Archive Room',
        description: 'Collect fragments of dreams. Half-remembered images and impossible landscapes welcome.',
        mood: 'dreamy',
        emoji: '',
        gradient: 'linear-gradient(135deg, rgba(124,184,232,0.35), rgba(196,161,255,0.25)), #141c14',
        glowClass: 'garden-room-dreamy-glow',
        growthLevel: 85,
        appreciations: 203,
        visits: 156,
        status: 'quiet'
      },
      {
        name: 'Morning Light Studio',
        description: 'Warm tones and gentle starts. Create before the world wakes and expectations form.',
        mood: 'energetic',
        emoji: '',
        gradient: 'linear-gradient(135deg, rgba(232,200,124,0.35), rgba(124,232,168,0.25)), #141c14',
        glowClass: 'garden-room-warm-glow',
        growthLevel: 45,
        appreciations: 52,
        visits: 38,
        status: 'open'
      },
      {
        name: 'Reflection Pool',
        description: 'Still waters for deep thoughts. Write what surfaces. Stay as long as you need.',
        mood: 'reflective',
        emoji: '',
        gradient: 'linear-gradient(135deg, rgba(124,232,168,0.35), rgba(124,184,232,0.25)), #141c14',
        glowClass: 'garden-room-calm-glow',
        growthLevel: 90,
        appreciations: 341,
        visits: 278,
        status: 'quiet'
      }
    ];

    async function loadFeaturedRooms() {
      const grid = document.getElementById('gardenRoomsGrid');
      const ghosts = document.getElementById('gardenGhostRooms');
      if (!grid) return;

      // Fetch real user rooms from Supabase
      let userRooms = [];
      if (db) {
        try {
          const { data: { session } } = await db.auth.getSession();
          const { data } = await db
            .from('garden_rooms')
            .select('id, user_id, name, description, mood, emoji, cover_image_url, growth_level, visit_count, appreciation_count')
            .eq('is_system_room', false)
            .order('created_at', { ascending: false })
            .limit(20);
          if (data) {
            // Exclude the current user's own room (already shown in "Your Rooms")
            userRooms = session
              ? data.filter(r => r.user_id !== session.user.id)
              : data;
          }
        } catch(e) {}
      }

      setTimeout(() => {
        if (ghosts) ghosts.style.display = 'none';

        const MOOD_GRADIENTS = {
          calm:       'linear-gradient(135deg, rgba(124,232,168,0.3) 0%, rgba(124,184,232,0.2) 100%)',
          dreamy:     'linear-gradient(135deg, rgba(196,161,255,0.3) 0%, rgba(124,184,232,0.2) 100%)',
          energetic:  'linear-gradient(135deg, rgba(232,168,124,0.3) 0%, rgba(232,210,124,0.2) 100%)',
          reflective: 'linear-gradient(135deg, rgba(124,184,232,0.3) 0%, rgba(196,161,255,0.2) 100%)'
        };
        const MOOD_EMOJI_MAP = { calm: '', dreamy: '', energetic: '', reflective: '' };

        // Render real user rooms first
        const userRoomHtml = userRooms.map(room => {
          const emoji = room.emoji || MOOD_EMOJI_MAP[room.mood] || '';
          const gradient = MOOD_GRADIENTS[room.mood] || MOOD_GRADIENTS.calm;
          const coverHtml = room.cover_image_url
            ? `<img src="${room.cover_image_url}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.7;">`
            : '';
          const safeName = (room.name || '').replace(/'/g, "\\'");
          return `
            <div class="garden-room-card" onclick="openGardenKnockModal('${safeName}', 'member')">
              <div class="garden-room-preview" style="background:${gradient};position:relative;">
                ${coverHtml}
                <div class="garden-room-status open" style="position:absolute;top:12px;left:12px;z-index:2;"><span class="garden-status-dot"></span> Open</div>
                <div class="garden-room-preview-emoji" style="position:absolute;bottom:12px;right:16px;font-size:40px;opacity:0.6;">${emoji}</div>
              </div>
              <div class="garden-growth-bar-wrap">
                <div class="garden-growth-label"><span>Garden Growth</span><span>${room.growth_level || 0}%</span></div>
                <div class="garden-growth-bar-track">
                  <div class="garden-growth-bar-fill" style="width:0%" data-target="${room.growth_level || 0}"></div>
                </div>
              </div>
              <div class="garden-room-info">
                <div class="garden-room-title">${emoji} ${room.name}</div>
                <div class="garden-room-description">${room.description || 'A creative sanctuary.'}</div>
                <div class="garden-room-meta">
                  <div class="garden-meta-item"> ${room.appreciation_count || 0} appreciations</div>
                  <div class="garden-meta-item"> ${room.visit_count || 0} visits</div>
                </div>
                <div class="garden-room-actions">
                  <button class="garden-knock-btn" onclick="event.stopPropagation(); openGardenKnockModal('${safeName}', 'member')">
                    <span></span> Knock to Enter
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Then render featured/system rooms
        const featuredHtml = FEATURED_GARDEN_ROOMS.map(room => {
          const statusLabel = room.status === 'open'
            ? '<span class="garden-status-dot"></span> Open'
            : room.status === 'quiet'
            ? '<span class="garden-status-dot"></span> Quiet Hours'
            : '<span class="garden-status-dot"></span> Closed';
          return `
            <div class="garden-room-card ${room.glowClass}" onclick="openGardenKnockModal('${room.name}', 'curator')">
              <div class="garden-room-preview" style="background:${room.gradient};">
                <div class="garden-room-status ${room.status}">${statusLabel}</div>
                <div class="garden-room-preview-emoji">${room.emoji}</div>
              </div>
              <div class="garden-growth-bar-wrap">
                <div class="garden-growth-label"><span>Garden Growth</span><span>${room.growthLevel}%</span></div>
                <div class="garden-growth-bar-track">
                  <div class="garden-growth-bar-fill" style="width:0%" data-target="${room.growthLevel}"></div>
                </div>
              </div>
              <div class="garden-room-info">
                <div class="garden-featured-label"> Featured Garden</div>
                <div class="garden-room-title">${room.emoji} ${room.name}</div>
                <div class="garden-room-description">${room.description}</div>
                <div class="garden-room-meta">
                  <div class="garden-meta-item"> ${room.appreciations} appreciations</div>
                  <div class="garden-meta-item"> ${room.visits} visits</div>
                </div>
                <div class="garden-room-actions">
                  <button class="garden-knock-btn" onclick="event.stopPropagation(); openGardenKnockModal('${room.name}', 'curator')">
                    <span></span> Knock to Enter
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        grid.innerHTML = userRoomHtml + featuredHtml;

        requestAnimationFrame(() => {
          document.querySelectorAll('.garden-growth-bar-fill[data-target]').forEach(bar => {
            setTimeout(() => { bar.style.width = bar.dataset.target + '%'; }, 200);
          });
        });
      }, 900);
    }

    function initGardenFireflies() {
      const container = document.getElementById('gardenFireflies');
      if (!container || container.childElementCount > 0) return;
      const colors = [
        ['rgba(124,232,168,0.9)', 'rgba(124,232,168,0.3)'],
        ['rgba(196,161,255,0.8)', 'rgba(196,161,255,0.3)'],
        ['rgba(232,210,124,0.7)', 'rgba(232,210,124,0.3)']
      ];
      for (let i = 0; i < 16; i++) {
        const fly = document.createElement('div');
        fly.className = 'garden-firefly';
        const startX = Math.random() * window.innerWidth;
        const startY = Math.random() * window.innerHeight;
        const dx = (Math.random() - 0.5) * 320;
        const dy = (Math.random() - 0.5) * 320;
        const duration = 7 + Math.random() * 12;
        const delay = Math.random() * -20;
        const size = 2 + Math.random() * 3;
        const [main, glow] = colors[Math.floor(Math.random() * colors.length)];
        fly.style.cssText = `
          left:${startX}px; top:${startY}px;
          --dx:${dx}px; --dy:${dy}px;
          animation-duration:${duration}s; animation-delay:${delay}s;
          width:${size}px; height:${size}px;
          background:${main};
          box-shadow:0 0 8px ${main},0 0 20px ${glow};
        `;
        container.appendChild(fly);
      }
    }

    // Initialize garden world when entering the view
    let gardenInitialized = false;
    function initGardenWorld() {
      if (gardenInitialized) return;
      gardenInitialized = true;
      initGardenFireflies();
      loadFeaturedRooms();
      checkUserRoomCard();
    }

    async function checkUserRoomCard() {
      const savedMood = localStorage.getItem('gardenRoomMood');
      const config = JSON.parse(localStorage.getItem('gardenRoomConfig') || '{}');

      // Count garden creations for growth calculation
      let gardenCreations = [];
      try {
        if (db) {
          const { data: { session } } = await db.auth.getSession();
          if (session) {
            const { data } = await db
              .from('creations')
              .select('id')
              .eq('user_id', session.user.id)
              .eq('view_mode', 'garden');
            if (data) gardenCreations = data;
          }
        }
      } catch(e) {}
      if (gardenCreations.length === 0) {
        try {
          const local = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
          gardenCreations = local.filter(c => c.view_mode === 'garden');
        } catch(e) {}
      }

      const hasRoom = savedMood || gardenCreations.length > 0 || config.name;
      const card = document.querySelector('.garden-room-card.your-room');
      if (!card) return;

      if (hasRoom) {
        const mood = savedMood || 'calm';
        const MOOD_GRADIENTS = {
          calm:       'linear-gradient(135deg, rgba(124,232,168,0.3) 0%, rgba(124,184,232,0.2) 100%)',
          dreamy:     'linear-gradient(135deg, rgba(196,161,255,0.3) 0%, rgba(124,184,232,0.2) 100%)',
          energetic:  'linear-gradient(135deg, rgba(232,168,124,0.3) 0%, rgba(232,210,124,0.2) 100%)',
          reflective: 'linear-gradient(135deg, rgba(124,184,232,0.3) 0%, rgba(196,161,255,0.2) 100%)'
        };
        const MOOD_EMOJI = { calm: '', dreamy: '', energetic: '', reflective: '' };
        const emoji = MOOD_EMOJI[mood] || '';
        const roomName = config.name || 'Your Garden Room';
        const roomDesc = config.description || 'A sanctuary only you design. Plant creations, watch them grow.';

        // Growth = 8% per creation, capped at 100
        const growthLevel = Math.min(100, gardenCreations.length * 8);
        const creationCount = gardenCreations.length;

        let previewBg = `background: ${MOOD_GRADIENTS[mood]};`;
        let previewImg = '';
        if (config.coverImage) {
          previewImg = `<img src="${config.coverImage}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.7;">`;
        }

        // Determine if the viewer is the room owner
        const isOwner = currentUser != null;

        // Fetch owner profile name for visitor view
        let ownerLabel = ' Your Room';
        if (!isOwner && db) {
          try {
            // Would fetch profile of the room owner  placeholder for when rooms have user_id
            ownerLabel = ' Garden Room';
          } catch(e) {}
        } else if (isOwner) {
          // Fetch the logged-in user's own display name for visitor preview
          try {
            const { data: profile } = await db.from('profiles').select('username').eq('id', currentUser.id).single();
            if (profile && profile.username) ownerLabel = ` ${profile.username}'s Room`;
          } catch(e) {}
        }

        card.style.borderStyle = 'solid';
        card.style.borderColor = 'rgba(255,255,255,0.04)';
        card.onclick = openMyRoom;
        card.innerHTML = `
          <div class="garden-room-preview" style="${previewBg}position:relative;">
            ${previewImg}
            <div class="garden-room-status your-room-status" style="position:absolute;top:12px;left:12px;z-index:2;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);border-radius:100px;padding:4px 10px;font-size:11px;color:rgba(255,255,255,0.7);">${isOwner ? ' Your Room' : ownerLabel}</div>
            <div class="garden-room-preview-emoji" style="position:absolute;bottom:12px;right:16px;z-index:2;font-size:40px;opacity:0.6;">${emoji}</div>
          </div>
          <div class="garden-growth-bar-wrap">
            <div class="garden-growth-label"><span>Garden Growth</span><span id="myRoomGrowthPct">${growthLevel}%</span></div>
            <div class="garden-growth-bar-track">
              <div class="garden-growth-bar-fill" style="width:0%" id="myRoomGrowthFill" data-target="${growthLevel}"></div>
            </div>
          </div>
          <div class="garden-room-info">
            <div class="garden-room-title">${emoji} ${roomName}</div>
            <div class="garden-room-description">${roomDesc}</div>
            <div class="garden-room-meta">
              <div class="garden-meta-item"> ${creationCount} creation${creationCount !== 1 ? 's' : ''}</div>
              <div class="garden-meta-item"> 0 appreciations</div>
              <div class="garden-meta-item"> 0 visits</div>
            </div>
            <div class="garden-room-actions" style="display:flex;gap:8px;">
              ${isOwner ? `
                <button class="garden-enter-btn" style="flex:1;" onclick="event.stopPropagation(); openMyRoom()">
                  <span></span> Enter Your Room
                </button>
                <button class="garden-enter-btn" style="padding:12px 14px;flex-shrink:0;" onclick="event.stopPropagation(); openRoomEditModal()" title="Edit room">
                  
                </button>
              ` : `
                <button class="garden-knock-btn" style="flex:1;" onclick="event.stopPropagation(); openGardenKnockModal('${roomName}', '${ownerLabel}')">
                  <span></span> Knock to Enter
                </button>
              `}
            </div>
          </div>
        `;

        // Animate growth bar  double rAF ensures browser paints 0% before transition
        requestAnimationFrame(() => requestAnimationFrame(() => {
          setTimeout(() => {
            const fill = document.getElementById('myRoomGrowthFill');
            if (fill) fill.style.width = growthLevel + '%';
          }, 100);
        }));

        // Render additional rooms from gardenUserRooms
        const extraRooms = JSON.parse(localStorage.getItem('gardenUserRooms') || '[]');
        const grid = document.getElementById('userRoomsGrid');
        if (grid && extraRooms.length > 0) {
          // Remove any previously rendered extra rooms
          grid.querySelectorAll('.extra-room-card').forEach(el => el.remove());

          const MOOD_GRADIENTS = {
            calm:       'linear-gradient(135deg, rgba(124,232,168,0.3) 0%, rgba(124,184,232,0.2) 100%)',
            dreamy:     'linear-gradient(135deg, rgba(196,161,255,0.3) 0%, rgba(124,184,232,0.2) 100%)',
            energetic:  'linear-gradient(135deg, rgba(232,168,124,0.3) 0%, rgba(232,210,124,0.2) 100%)',
            reflective: 'linear-gradient(135deg, rgba(124,184,232,0.3) 0%, rgba(196,161,255,0.2) 100%)'
          };
          const MOOD_EMOJI = { calm: '', dreamy: '', energetic: '', reflective: '' };

          extraRooms.forEach(room => {
            const emoji = MOOD_EMOJI[room.mood] || '';
            const gradient = MOOD_GRADIENTS[room.mood];
            const coverHtml = room.coverImage
              ? `<img src="${room.coverImage}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.7;">`
              : '';
            const el = document.createElement('div');
            el.className = 'garden-room-card extra-room-card';
            el.style.cssText = 'border-style:solid;border-color:rgba(255,255,255,0.04);';
            el.innerHTML = `
              <div class="garden-room-preview" style="background:${gradient};position:relative;">
                ${coverHtml}
                <div style="position:absolute;top:12px;left:12px;z-index:2;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);border-radius:100px;padding:4px 10px;font-size:11px;color:rgba(255,255,255,0.7);"> Your Room</div>
                <div class="garden-room-preview-emoji" style="position:absolute;bottom:12px;right:16px;z-index:2;font-size:40px;opacity:0.6;">${emoji}</div>
              </div>
              <div class="garden-growth-bar-wrap">
                <div class="garden-growth-label"><span>Garden Growth</span><span>0%</span></div>
                <div class="garden-growth-bar-track">
                  <div class="garden-growth-bar-fill" style="width:0%"></div>
                </div>
              </div>
              <div class="garden-room-info">
                <div class="garden-room-title">${emoji} ${room.name}</div>
                <div class="garden-room-description">${room.description || 'Your creative sanctuary.'}</div>
                <div class="garden-room-meta">
                  <div class="garden-meta-item"> 0 creations</div>
                  <div class="garden-meta-item"> 0 appreciations</div>
                </div>
                <div class="garden-room-actions" style="display:flex;gap:8px;">
                  <button class="garden-enter-btn" style="flex:1;" onclick="event.stopPropagation(); openExtraRoom(${room.id})">
                    <span></span> Enter Room
                  </button>
                  <button class="garden-enter-btn" style="padding:12px 14px;flex-shrink:0;" onclick="event.stopPropagation(); deleteUserRoom(${room.id})" title="Delete room">
                    
                  </button>
                </div>
              </div>
            `;
            grid.appendChild(el);
          });
        }
      }
    }

    function openExtraRoom(roomId) {
      const rooms = JSON.parse(localStorage.getItem('gardenUserRooms') || '[]');
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;
      gardenRoomMood = room.mood;
      openRoomInterior({
        name: room.name,
        desc: room.description || 'Your creative sanctuary.',
        coverImage: room.coverImage || null,
        mood: room.mood,
        growthLevel: 0,
        appreciations: 0,
        visits: 0,
        isUserRoom: true
      });
    }

    function deleteUserRoom(roomId) {
      if (!confirm('Delete this room?')) return;
      const rooms = JSON.parse(localStorage.getItem('gardenUserRooms') || '[]');
      localStorage.setItem('gardenUserRooms', JSON.stringify(rooms.filter(r => r.id !== roomId)));
      checkUserRoomCard();
      showToast(' Room deleted');
    }

    // Room edit modal
    function openRoomEditModal() {
      const config = JSON.parse(localStorage.getItem('gardenRoomConfig') || '{}');
      document.getElementById('roomEditName').value = config.name || '';
      document.getElementById('roomEditDesc').value = config.description || '';
      const preview = document.getElementById('roomCoverPreview');
      const placeholder = document.getElementById('roomCoverPlaceholder');
      if (config.coverImage) {
        preview.src = config.coverImage;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
      }
      document.getElementById('roomEditModal').classList.add('active');
    }

    function closeRoomEditModal() {
      document.getElementById('roomEditModal').classList.remove('active');
    }

    function previewRoomCover(input) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => {
        const preview = document.getElementById('roomCoverPreview');
        const placeholder = document.getElementById('roomCoverPlaceholder');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      };
      reader.readAsDataURL(input.files[0]);
    }

    async function saveRoomSettings() {
      const name = document.getElementById('roomEditName').value.trim() || 'Your Garden Room';
      const desc = document.getElementById('roomEditDesc').value.trim();
      const fileInput = document.getElementById('roomCoverInput');
      const existing = JSON.parse(localStorage.getItem('gardenRoomConfig') || '{}');
      let coverImage = existing.coverImage || null;

      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        try {
          if (db) {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
              const ext = file.name.split('.').pop();
              const path = `garden-covers/${session.user.id}.${ext}`;
              await db.storage.from('images').upload(path, file, { upsert: true });
              const { data: urlData } = db.storage.from('images').getPublicUrl(path);
              coverImage = urlData.publicUrl;
            }
          }
        } catch(e) {}
        if (!coverImage) {
          coverImage = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
          });
        }
      }

      const mood = localStorage.getItem('gardenRoomMood') || 'calm';
      localStorage.setItem('gardenRoomConfig', JSON.stringify({ name, description: desc, coverImage }));

      // Save to Supabase so other users can see this room
      if (db && currentUser) {
        try {
          const existingId = localStorage.getItem('gardenRoomDbId');
          const roomData = {
            user_id: currentUser.id,
            name,
            description: desc,
            mood,
            cover_image_url: coverImage && !coverImage.startsWith('data:') ? coverImage : null,
            is_system_room: false
          };
          if (existingId) {
            await db.from('garden_rooms').update(roomData).eq('id', existingId).eq('user_id', currentUser.id);
          } else {
            const { data: inserted } = await db.from('garden_rooms').insert(roomData).select('id').single();
            if (inserted) localStorage.setItem('gardenRoomDbId', inserted.id);
          }
        } catch(e) {}
      }

      fileInput.value = '';
      closeRoomEditModal();
      gardenInitialized = false;
      checkUserRoomCard();
      showToast(' Room updated!');
    }

    // ==================== CREATE NEW ROOM ====================
    let createRoomSelectedMood = 'calm';

    function openCreateRoomModal() {
      createRoomSelectedMood = 'calm';
      document.getElementById('createRoomName').value = '';
      document.getElementById('createRoomDesc').value = '';
      document.getElementById('createRoomCoverInput').value = '';
      const preview = document.getElementById('createRoomCoverPreview');
      preview.style.display = 'none';
      document.querySelectorAll('.create-room-mood-option').forEach(o => o.classList.remove('selected'));
      document.querySelector('.create-room-mood-option').classList.add('selected');
      document.getElementById('createRoomModal').classList.add('active');
    }

    function closeCreateRoomModal() {
      document.getElementById('createRoomModal').classList.remove('active');
    }

    function selectCreateRoomMood(el, mood) {
      document.querySelectorAll('.create-room-mood-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      createRoomSelectedMood = mood;
    }

    function previewCreateRoomCover(input) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => {
        const preview = document.getElementById('createRoomCoverPreview');
        const placeholder = document.getElementById('createRoomCoverArea').querySelectorAll('span');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.forEach(el => el.style.display = 'none');
      };
      reader.readAsDataURL(input.files[0]);
    }

    async function saveNewRoom() {
      const name = document.getElementById('createRoomName').value.trim();
      if (!name) { showToast('Please give your room a name'); return; }
      const desc = document.getElementById('createRoomDesc').value.trim();
      const fileInput = document.getElementById('createRoomCoverInput');
      let coverImage = null;

      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        try {
          if (db) {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
              const ext = file.name.split('.').pop();
              const path = `garden-covers/${session.user.id}-${Date.now()}.${ext}`;
              await db.storage.from('images').upload(path, file, { upsert: true });
              const { data: urlData } = db.storage.from('images').getPublicUrl(path);
              coverImage = urlData.publicUrl;
            }
          }
        } catch(e) {}
        if (!coverImage) {
          coverImage = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
          });
        }
      }

      let dbId = null;
      if (db && currentUser) {
        try {
          const { data: inserted } = await db.from('garden_rooms').insert({
            user_id: currentUser.id,
            name,
            description: desc,
            mood: createRoomSelectedMood,
            cover_image_url: coverImage && !coverImage.startsWith('data:') ? coverImage : null,
            is_system_room: false
          }).select('id').single();
          if (inserted) dbId = inserted.id;
        } catch(e) {}
      }

      const newRoom = {
        id: dbId || Date.now(),
        name,
        description: desc,
        mood: createRoomSelectedMood,
        coverImage,
        createdAt: new Date().toISOString()
      };

      const rooms = JSON.parse(localStorage.getItem('gardenUserRooms') || '[]');
      rooms.push(newRoom);
      localStorage.setItem('gardenUserRooms', JSON.stringify(rooms));

      closeCreateRoomModal();
      renderAllUserRooms();
      showToast(' Room created!');
    }

    function renderAllUserRooms() {
      checkUserRoomCard(); // re-renders primary room + extra rooms
    }

    // Garden onboarding
    let selectedOnboardingMood = null;
    // Track whether create modal was opened from garden room
    let gardenCreateContext = false;
    let gardenRoomMood = null;

    const ROOM_MOOD_TO_CREATION_MOOD = {
      calm: 'peaceful',
      dreamy: 'reflective',
      energetic: 'energetic',
      reflective: 'reflective'
    };

    function openGardenCreateEditor(roomMood) {
      gardenCreateContext = true;
      gardenRoomMood = roomMood;

      // Open the existing modal
      openCreateModal();

      // Skin it for garden context
      document.querySelector('.create-modal-title').textContent = 'Plant a Creation';
      document.querySelector('.create-modal-subtitle').textContent = 'What will you grow in your garden today?';
      document.getElementById('createSubmitBtn').textContent = 'Plant & Bloom ';
    }

    function addCreationToRoom(creation) {
      const grid = document.getElementById('interiorCreationsGrid');
      if (!grid) return;

      // Remove the "plant first" slot and one ghost slot
      const plantSlot = grid.querySelector('.interior-plant-slot');
      const firstGhost = grid.querySelector('.interior-ghost-slot');
      if (plantSlot) grid.removeChild(plantSlot);
      if (firstGhost) grid.removeChild(firstGhost);

      // Render the new card
      renderCreationCard(grid, creation);

      // Animate it in
      const newCard = grid.firstChild;
      if (newCard) newCard.style.animation = 'interior-card-bloom 0.5s cubic-bezier(0.4,0,0.2,1)';

      // Update growth bar
      const fillEl = document.getElementById('interiorGrowthFill');
      const pctEl  = document.getElementById('interiorGrowthPct');
      if (fillEl) {
        const newPct = Math.min(100, (parseInt(fillEl.style.width) || 0) + 8);
        fillEl.style.width = newPct + '%';
        if (pctEl) pctEl.textContent = newPct + '%';
      }

      // Keep a "plant another" slot at end if there are still ghost slots
      if (grid.querySelector('.interior-ghost-slot')) {
        const newPlant = document.createElement('div');
        newPlant.className = 'interior-plant-slot';
        newPlant.innerHTML = `<div class="interior-plant-icon"></div><div class="interior-plant-text">Plant another<br>creation</div>`;
        newPlant.onclick = () => openGardenCreateEditor(gardenRoomMood);
        grid.appendChild(newPlant);
      }
    }

    function openGardenOnboarding() {
      selectedOnboardingMood = null;
      document.querySelectorAll('.garden-mood-option').forEach(o => o.classList.remove('selected'));
      document.getElementById('gardenOnboardingNext').disabled = true;
      document.getElementById('gardenOnboardingModal').classList.add('active');
    }
    function closeGardenOnboarding() {
      document.getElementById('gardenOnboardingModal').classList.remove('active');
    }
    function selectOnboardingMood(el, mood) {
      document.querySelectorAll('.garden-mood-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selectedOnboardingMood = mood;
      document.getElementById('gardenOnboardingNext').disabled = false;
    }
    // Mood config for room interior
    const MOOD_CONFIG = {
      calm:       { emoji: '', label: 'Calm',       color: '#7ce8a8', badge: 'rgba(124,232,168,0.15)', orb1: 'rgba(124,232,168,0.25)', orb2: 'rgba(124,184,232,0.15)', roomEmoji: '' },
      dreamy:     { emoji: '', label: 'Dreamy',     color: '#c4a1ff', badge: 'rgba(196,161,255,0.15)', orb1: 'rgba(196,161,255,0.25)', orb2: 'rgba(124,184,232,0.15)', roomEmoji: '' },
      energetic:  { emoji: '', label: 'Energetic',  color: '#e8c87c', badge: 'rgba(232,200,124,0.15)', orb1: 'rgba(232,168,124,0.25)', orb2: 'rgba(232,210,124,0.15)', roomEmoji: '' },
      reflective: { emoji: '', label: 'Reflective', color: '#7cb8e8', badge: 'rgba(124,184,232,0.15)', orb1: 'rgba(124,184,232,0.25)', orb2: 'rgba(196,161,255,0.15)', roomEmoji: '' }
    };

    function openRoomInterior(config) {
      const { name, desc, mood, growthLevel, appreciations, visits, isNew, isUserRoom, coverImage } = config;
      const isMyRoom = isNew || isUserRoom;
      const mc = MOOD_CONFIG[mood] || MOOD_CONFIG.calm;

      // Hero background orbs + optional cover image
      let heroBg = `
        <div class="interior-hero-orb" style="width:500px;height:500px;background:${mc.orb1};top:-150px;left:-100px;"></div>
        <div class="interior-hero-orb" style="width:350px;height:350px;background:${mc.orb2};bottom:-80px;right:-60px;animation-delay:-6s;"></div>
      `;
      if (coverImage) {
        heroBg += `<div style="position:absolute;inset:0;background:url('${coverImage}') center/cover;opacity:0.25;z-index:1;"></div>`;
      }
      document.getElementById('interiorHeroBg').innerHTML = heroBg;

      // Edit button in topbar (only for user's own room)
      const topbar = document.querySelector('.interior-topbar');
      const existingEdit = topbar ? topbar.querySelector('.interior-edit-btn') : null;
      if (existingEdit) existingEdit.remove();
      if (isMyRoom && topbar) {
        const editBtn = document.createElement('button');
        editBtn.className = 'interior-edit-btn';
        editBtn.innerHTML = ' Edit Room';
        editBtn.style.cssText = 'display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:100px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer;margin-left:10px;';
        editBtn.onclick = openRoomEditModal;
        topbar.appendChild(editBtn);
      }

      // Mood badge
      const badge = document.getElementById('interiorMoodBadge');
      badge.textContent = `${mc.emoji} ${mc.label}`;
      badge.style.background = mc.badge;
      badge.style.color = mc.color;
      badge.style.border = `1px solid ${mc.color}30`;

      document.getElementById('interiorRoomEmoji').textContent = '';
      document.getElementById('interiorRoomName').innerHTML = `<span style="font-size:36px;line-height:1;">${mc.roomEmoji}</span>${name}`;
      document.getElementById('interiorRoomDesc').textContent = desc;
      document.getElementById('interiorAppreciations').textContent = appreciations || 0;
      document.getElementById('interiorVisits').textContent = visits || 0;
      document.getElementById('interiorGrowthPct').textContent = (growthLevel || 0) + '%';

      // Build creation grid
      const grid = document.getElementById('interiorCreationsGrid');
      if (isMyRoom) {
        grid.innerHTML = `
          <div class="interior-plant-slot" onclick="openGardenCreateEditor(gardenRoomMood)">
            <div class="interior-plant-icon"></div>
            <div class="interior-plant-text">Plant your<br>first creation</div>
          </div>
          <div class="interior-ghost-slot"></div>
          <div class="interior-ghost-slot"></div>
          <div class="interior-ghost-slot"></div>
          <div class="interior-ghost-slot"></div>
          <div class="interior-ghost-slot"></div>
        `;
      }

      // Show interior and hide the page header
      document.getElementById('gardenRoomInterior').classList.add('active');
      document.getElementById('creativePage').classList.add('interior-open');

      // Animate growth bar
      requestAnimationFrame(() => {
        setTimeout(() => {
          document.getElementById('interiorGrowthFill').style.width = (growthLevel || 0) + '%';
        }, 300);
      });

      // Load saved creations if this is the user's own room
      if (isMyRoom) {
        loadRoomCreations();
      }
    }

    async function loadRoomCreations() {
      const grid = document.getElementById('interiorCreationsGrid');
      if (!grid) return;

      let creations = [];

      if (db && currentUser) {
        try {
          const { data, error } = await db
            .from('creations')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('view_mode', 'garden')
            .order('created_at', { ascending: false });

          if (!error && data) creations = data;
        } catch (e) {
          console.error('Load room creations error:', e);
        }
      }

      // Also check localStorage for offline creations
      if (creations.length === 0) {
        const local = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
        creations = local.filter(c => c.view_mode === 'garden');
      }

      if (creations.length === 0) return; // keep the empty "plant" state

      // Clear ghost slots and plant slot, then render saved creations
      grid.innerHTML = '';
      creations.forEach(c => renderCreationCard(grid, c));

      // Always add a "plant another" slot at the end
      const plantSlot = document.createElement('div');
      plantSlot.className = 'interior-plant-slot';
      plantSlot.innerHTML = `<div class="interior-plant-icon"></div><div class="interior-plant-text">Plant another<br>creation</div>`;
      plantSlot.onclick = () => openGardenCreateEditor(gardenRoomMood);
      grid.appendChild(plantSlot);

      // Update growth bar based on number of creations
      const fillEl = document.getElementById('interiorGrowthFill');
      const pctEl  = document.getElementById('interiorGrowthPct');
      if (fillEl) {
        const pct = Math.min(100, creations.length * 8);
        fillEl.style.width = pct + '%';
        if (pctEl) pctEl.textContent = pct + '%';
      }
    }

    function renderCreationCard(grid, creation) {
      const typeEmoji = { writing: '', visual: '', music: '', idea: '' };
      const card = document.createElement('div');
      card.className = 'interior-creation-card';
      card.dataset.creationId = String(creation.id);
      card.style.cssText = `
        aspect-ratio: 1; border-radius: 18px; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.08);
        cursor: pointer; transition: all 0.3s ease; position: relative;
        background: rgba(255,255,255,0.03);
      `;

      // Delete button (owner only, shown on hover via CSS)
      const isOwner = currentUser && creation.user_id === currentUser.id;
      const deleteBtnHtml = isOwner
        ? `<button class="card-delete-btn" onclick="event.stopPropagation(); quickDeleteCreation('${creation.id}', this)" title="Delete"></button>`
        : '';

      if (creation.cover_image_url) {
        card.style.backgroundImage = `url('${creation.cover_image_url}')`;
        card.style.backgroundSize = 'cover';
        card.style.backgroundPosition = 'center';
        card.innerHTML = `
          ${deleteBtnHtml}
          <div style="position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.7) 0%,transparent 60%);display:flex;flex-direction:column;justify-content:flex-end;padding:14px;">
            <div style="font-size:13px;color:#f0eeeb;font-family:'Cormorant Garamond',serif;line-height:1.3;">${escapeHtml(creation.title)}</div>
            <div style="font-size:11px;color:rgba(240,238,235,0.5);text-transform:uppercase;letter-spacing:0.1em;margin-top:4px;">${creation.type}</div>
          </div>
        `;
      } else {
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'center';
        card.style.justifyContent = 'center';
        card.style.gap = '10px';
        card.style.padding = '20px';
        card.style.textAlign = 'center';
        card.innerHTML = `
          ${deleteBtnHtml}
          <div style="font-size:36px;">${typeEmoji[creation.type] || ''}</div>
          <div style="font-size:14px;color:#f0eeeb;font-family:'Cormorant Garamond',serif;">${escapeHtml(creation.title)}</div>
          <div style="font-size:11px;color:#6b7a6b;text-transform:uppercase;letter-spacing:0.1em;">${creation.type}</div>
        `;
      }

      card.onclick = () => showCreationDetail(creation);
      card.onmouseenter = () => { card.style.borderColor = 'rgba(124,232,168,0.3)'; card.style.transform = 'scale(1.02)'; };
      card.onmouseleave = () => { card.style.borderColor = 'rgba(255,255,255,0.08)'; card.style.transform = 'scale(1)'; };
      grid.insertBefore(card, grid.firstChild);
    }

    async function quickDeleteCreation(creationId, btn) {
      const confirmed = confirm('Delete this creation? This cannot be undone.');
      if (!confirmed) return;

      if (db && currentUser) {
        try {
          const { error } = await db.from('creations').delete().eq('id', creationId).eq('user_id', currentUser.id);
          if (error) { showToast(' Could not delete: ' + error.message); return; }
        } catch (e) { showToast(' Error deleting'); return; }
      } else {
        const saved = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
        localStorage.setItem('introvert_creations', JSON.stringify(saved.filter(c => String(c.id) !== String(creationId))));
      }

      // Remove the card from the grid
      btn.closest('.interior-creation-card').remove();
      showToast(' Deleted');
    }

    function closeRoomInterior() {
      document.getElementById('gardenRoomInterior').classList.remove('active');
      document.getElementById('creativePage').classList.remove('interior-open');
    }

    async function completeGardenOnboarding() {
      closeGardenOnboarding();
      gardenRoomMood = selectedOnboardingMood;
      localStorage.setItem('gardenRoomMood', selectedOnboardingMood);

      // Create room in Supabase so others can discover it
      if (db && currentUser) {
        try {
          const existingId = localStorage.getItem('gardenRoomDbId');
          if (!existingId) {
            const config = JSON.parse(localStorage.getItem('gardenRoomConfig') || '{}');
            const { data: inserted } = await db.from('garden_rooms').insert({
              user_id: currentUser.id,
              name: config.name || 'Garden Room',
              description: config.description || null,
              mood: selectedOnboardingMood,
              is_system_room: false
            }).select('id').single();
            if (inserted) localStorage.setItem('gardenRoomDbId', inserted.id);
          }
        } catch(e) {}
      }
      openMyRoom();
    }

    async function openMyRoom() {
      const savedMood = localStorage.getItem('gardenRoomMood') || gardenRoomMood || 'calm';
      const config = JSON.parse(localStorage.getItem('gardenRoomConfig') || '{}');
      gardenRoomMood = savedMood;

      // Calculate growth from creation count
      let gardenCreations = [];
      try {
        if (db) {
          const { data: { session } } = await db.auth.getSession();
          if (session) {
            const { data } = await db.from('creations').select('id').eq('user_id', session.user.id).eq('view_mode', 'garden');
            if (data) gardenCreations = data;
          }
        }
      } catch(e) {}
      if (gardenCreations.length === 0) {
        try {
          const local = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
          gardenCreations = local.filter(c => c.view_mode === 'garden');
        } catch(e) {}
      }
      const growthLevel = Math.min(100, gardenCreations.length * 8);

      openRoomInterior({
        name: config.name || 'Your Garden Room',
        desc: config.description || 'A sanctuary only you design. Plant creations, watch them grow, and let visitors knock before they enter.',
        coverImage: config.coverImage || null,
        mood: savedMood,
        growthLevel,
        appreciations: 0,
        visits: 0,
        isUserRoom: true
      });
    }

    // Garden view toggle
    function setGardenView(btn, view) {
      document.querySelectorAll('.garden-view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showToast(`Viewing: ${btn.textContent.trim()}`);
    }

    // Enter room (for open rooms)
    function enterGardenRoom(roomName) {
      const room = FEATURED_GARDEN_ROOMS.find(r => r.name === roomName);
      if (room) {
        openRoomInterior({
          name: room.name,
          desc: room.description,
          mood: room.mood,
          growthLevel: room.growthLevel,
          appreciations: room.appreciations,
          visits: room.visits,
          isNew: false
        });
      }
    }

    // Knock modal
    function openGardenKnockModal(roomName, ownerName) {
      currentKnockRoom = roomName;
      currentKnockOwner = ownerName;
      document.getElementById('gardenKnockModalSubtitle').textContent = `Request access to ${roomName} by @${ownerName}`;
      document.getElementById('gardenKnockMessage').value = '';
      document.getElementById('gardenKnockModal').classList.add('active');
    }

    function closeGardenKnockModal(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('gardenKnockModal').classList.remove('active');
    }

    function setGardenKnockMessage(msg) {
      document.getElementById('gardenKnockMessage').value = msg;
    }

    function sendGardenKnock() {
      const message = document.getElementById('gardenKnockMessage').value;
      closeGardenKnockModal();
      showToast(` Knock sent to ${currentKnockRoom}! You'll be notified when they respond.`);
    }

    // Close modals with Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('creationDetailOverlay').classList.contains('active')) {
          closeCreationDetail();
        } else {
          closeGardenKnockModal();
          closeGardenOnboarding();
          closeRoomInterior();
        }
      }
    });

    // ==================== SEASONAL FLOW ====================
    let seasonalParticlesInitialized = false;

    // Season data
    const seasonData = {
      winter: { icon: '', name: 'Winter Stillness' },
      spring: { icon: '', name: 'Spring Awakening' },
      summer: { icon: '', name: 'Summer Radiance' },
      autumn: { icon: '', name: 'Autumn Reflection' }
    };

    // Initialize seasonal particles
    function initSeasonalParticles() {
      if (seasonalParticlesInitialized) return;
      seasonalParticlesInitialized = true;
      createSeasonalParticles();
    }

    // Create particles
    function createSeasonalParticles() {
      const container = document.getElementById('seasonalParticles');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'seasonal-particle';
        particle.style.width = (2 + Math.random() * 4) + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        container.appendChild(particle);
      }
    }

    // Select season
    function selectSeason(season) {
      const seasonalView = document.getElementById('seasonalView');
      const wasActive = seasonalView.classList.contains('active');

      // Update seasonal view class for background color
      seasonalView.className = 'seasonal-view ' + season;
      if (wasActive) {
        seasonalView.classList.add('active');
      }

      // Update buttons
      document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-season="${season}"]`).classList.add('active');

      // Update icon
      const seasonIcon = document.getElementById('seasonIcon');
      if (seasonIcon) {
        seasonIcon.textContent = seasonData[season].icon;
      }

      // Update first exhibition title
      const mainTitle = document.getElementById('mainExhibitionTitle');
      if (mainTitle) {
        mainTitle.innerHTML = `<span>${seasonData[season].icon}</span> ${seasonData[season].name}`;
      }

      // Recreate particles for new season color
      createSeasonalParticles();

      showToast(`${seasonData[season].icon} Viewing ${season} content`);
    }

    // Select mood filter
    function selectSeasonalMood(btn) {
      const mood = btn.dataset.mood;

      if (mood === 'all') {
        document.querySelectorAll('.seasonal-mood-filter').forEach(f => f.classList.remove('active'));
        btn.classList.add('active');
      } else {
        document.querySelector('.seasonal-mood-filter[data-mood="all"]').classList.remove('active');
        btn.classList.toggle('active');

        // If nothing selected, reactivate "All"
        const anyActive = document.querySelectorAll('.seasonal-mood-filter.active:not([data-mood="all"])').length > 0;
        if (!anyActive) {
          document.querySelector('.seasonal-mood-filter[data-mood="all"]').classList.add('active');
        }
      }

      showToast(' Filter updated');
    }

    // Open seasonal creation
    function openSeasonalCreation(title) {
      showToast(` Opening: ${title}...`);
    }

    // Toggle appreciation
    function toggleSeasonalAppreciation(btn) {
      btn.classList.toggle('appreciated');
      if (btn.classList.contains('appreciated')) {
        showToast(' Appreciation sent');
      } else {
        showToast('Appreciation removed');
      }
    }

    // ==================== CREATE MODAL ====================
    let selectedCreateType = null;
    let selectedCreateMood = null;

    function openCreateModal() {
      document.getElementById('createModal').classList.add('active');
      // Start at step 1 (type selection)
      goToCreateStep(1);
      resetCreateModal();
    }

    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('active');
      // Reset modal state
      setTimeout(() => {
        goToCreateStep(1);
        resetCreateModal();
        // Reset garden context and button label if cancelled
        if (gardenCreateContext) {
          gardenCreateContext = false;
          document.getElementById('createSubmitBtn').textContent = 'Create & Share ';
        }
      }, 300);
    }

    function resetCreateModal() {
      document.getElementById('createTitle').value = '';
      document.getElementById('writingContent').value = '';
      document.getElementById('ideaContent').value = '';
      document.getElementById('ideaTags').value = '';
      document.getElementById('visualDescription').value = '';
      document.getElementById('musicDescription').value = '';
      document.getElementById('musicLink').value = '';

      // Reset previews
      document.getElementById('visualPreview').style.display = 'none';
      document.getElementById('visualUploadContent').style.display = 'block';
      document.getElementById('musicPreview').style.display = 'none';
      document.getElementById('musicUploadContent').style.display = 'block';

      // Reset selections
      document.querySelectorAll('.create-type-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.mood-option').forEach(m => m.classList.remove('selected'));
      document.querySelector('input[name="visibility"][value="public"]').checked = true;

      selectedCreateType = null;
      selectedCreateMood = null;
      uploadedVisualFile = null;
      uploadedMusicFile = null;

      updateSubmitButton();
    }

    function goToCreateStep(stepNum) {
      document.querySelectorAll('.create-step').forEach(s => s.classList.remove('active'));
      document.getElementById('createStep' + stepNum).classList.add('active');

      if (stepNum === 1) {
        document.querySelector('.create-modal-title').textContent = 'Create Something New';
        document.querySelector('.create-modal-subtitle').textContent = 'What would you like to share with the world?';
      }
    }

    function selectCreateType(card, type) {
      document.querySelectorAll('.create-type-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedCreateType = type;

      // Update header
      const typeNames = {
        writing: ' Writing',
        visual: ' Visual Art',
        music: ' Music',
        idea: ' Idea'
      };
      document.querySelector('.create-modal-title').textContent = 'Create ' + typeNames[type];
      document.querySelector('.create-modal-subtitle').textContent = 'Express yourself freely';

      // Show appropriate content area
      document.querySelectorAll('.create-content-area').forEach(area => area.style.display = 'none');
      const contentMap = {
        writing: 'contentWriting',
        visual: 'contentVisual',
        music: 'contentMusic',
        idea: 'contentIdea'
      };
      document.getElementById(contentMap[type]).style.display = 'block';

      // Go to step 2
      goToCreateStep(2);
      updateSubmitButton();
    }

    function selectCreateMood(option, mood) {
      document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      selectedCreateMood = mood;
    }

    // File upload variables
    let uploadedVisualFile = null;
    let uploadedMusicFile = null;

    function handleVisualUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        showToast('File too large. Max 10MB allowed.');
        return;
      }

      uploadedVisualFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('visualPreviewImg').src = e.target.result;
        document.getElementById('visualUploadContent').style.display = 'none';
        document.getElementById('visualPreview').style.display = 'block';
        updateSubmitButton();
      };
      reader.readAsDataURL(file);
    }

    function removeVisualUpload(event) {
      event.stopPropagation();
      uploadedVisualFile = null;
      document.getElementById('visualPreview').style.display = 'none';
      document.getElementById('visualUploadContent').style.display = 'block';
      document.getElementById('visualFileInput').value = '';
      updateSubmitButton();
    }

    function handleMusicUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 20 * 1024 * 1024) {
        showToast('File too large. Max 20MB allowed.');
        return;
      }

      uploadedMusicFile = file;
      document.getElementById('musicFileName').textContent = file.name;
      document.getElementById('musicUploadContent').style.display = 'none';
      document.getElementById('musicPreview').style.display = 'flex';
      updateSubmitButton();
    }

    function removeMusicUpload(event) {
      event.stopPropagation();
      uploadedMusicFile = null;
      document.getElementById('musicPreview').style.display = 'none';
      document.getElementById('musicUploadContent').style.display = 'block';
      document.getElementById('musicFileInput').value = '';
      updateSubmitButton();
    }

    function switchMusicOption(option) {
      document.querySelectorAll('.music-option-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      if (option === 'upload') {
        document.getElementById('musicUploadArea').style.display = 'block';
        document.getElementById('musicLinkArea').style.display = 'none';
      } else {
        document.getElementById('musicUploadArea').style.display = 'none';
        document.getElementById('musicLinkArea').style.display = 'block';
      }
      updateSubmitButton();
    }

    function importWritingFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        let content = e.target.result;
        const lines = content.split('\n');
        const firstLine = lines[0].trim();

        // If first line looks like a title, use it
        if (firstLine.startsWith('# ')) {
          document.getElementById('createTitle').value = firstLine.substring(2);
          content = lines.slice(1).join('\n').trim();
        }

        document.getElementById('writingContent').value = content;
        updateWordCount();
        updateSubmitButton();
        showToast(' File imported!');
      };
      reader.readAsText(file);
    }

    function formatText(format) {
      const textarea = document.getElementById('writingContent');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selectedText = text.substring(start, end);

      let newText = '';
      switch(format) {
        case 'bold':
          newText = `**${selectedText}**`;
          break;
        case 'italic':
          newText = `*${selectedText}*`;
          break;
        case 'heading':
          newText = `\n## ${selectedText}`;
          break;
        case 'quote':
          newText = `\n> ${selectedText}`;
          break;
        case 'list':
          newText = selectedText.split('\n').map(line => ` ${line}`).join('\n');
          break;
      }

      textarea.value = text.substring(0, start) + newText + text.substring(end);
      textarea.focus();
      updateWordCount();
    }

    function updateWordCount() {
      const text = document.getElementById('writingContent').value.trim();
      const words = text ? text.split(/\s+/).length : 0;
      document.getElementById('wordCount').textContent = words + ' word' + (words !== 1 ? 's' : '');
    }

    // Add event listeners for word count
    document.getElementById('writingContent')?.addEventListener('input', updateWordCount);

    function updateSubmitButton() {
      const title = document.getElementById('createTitle').value.trim();
      const btn = document.getElementById('createSubmitBtn');
      let hasContent = false;

      switch(selectedCreateType) {
        case 'writing':
          hasContent = document.getElementById('writingContent').value.trim().length > 0;
          break;
        case 'visual':
          hasContent = uploadedVisualFile !== null;
          break;
        case 'music':
          const linkArea = document.getElementById('musicLinkArea');
          if (linkArea.style.display === 'none') {
            hasContent = uploadedMusicFile !== null;
          } else {
            hasContent = document.getElementById('musicLink').value.trim().length > 0;
          }
          break;
        case 'idea':
          hasContent = document.getElementById('ideaContent').value.trim().length > 0;
          break;
      }

      btn.disabled = !(title && hasContent);
    }

    // Add input listeners for submit button
    document.getElementById('createTitle')?.addEventListener('input', updateSubmitButton);
    document.getElementById('writingContent')?.addEventListener('input', updateSubmitButton);
    document.getElementById('ideaContent')?.addEventListener('input', updateSubmitButton);
    document.getElementById('musicLink')?.addEventListener('input', updateSubmitButton);

    // Drag and drop for upload zones
    ['visualUploadZone', 'musicUploadZone'].forEach(zoneId => {
      const zone = document.getElementById(zoneId);
      if (!zone) return;

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
          if (zoneId === 'visualUploadZone') {
            document.getElementById('visualFileInput').files = e.dataTransfer.files;
            handleVisualUpload({ target: { files: [file] } });
          } else {
            document.getElementById('musicFileInput').files = e.dataTransfer.files;
            handleMusicUpload({ target: { files: [file] } });
          }
        }
      });
    });

    async function submitCreation() {
      const title = document.getElementById('createTitle').value.trim();
      const visibility = document.querySelector('input[name="visibility"]:checked').value;

      let content = '';
      let description = '';
      let cover_image_url = null;

      switch(selectedCreateType) {
        case 'writing':
          content = document.getElementById('writingContent').value.trim();
          break;
        case 'visual':
          description = document.getElementById('visualDescription').value.trim();
          content = description || 'visual';
          // Upload image to storage if available
          if (uploadedVisualFile && db && currentUser) {
            try {
              const ext = uploadedVisualFile.name.split('.').pop().toLowerCase();
              const path = `creations/${currentUser.id}/${Date.now()}.${ext}`;
              const { error: uploadError } = await db.storage
                .from('images')
                .upload(path, uploadedVisualFile, { upsert: false });
              if (!uploadError) {
                const { data: urlData } = db.storage.from('images').getPublicUrl(path);
                cover_image_url = urlData.publicUrl;
              } else {
                // Fallback: store data URL from preview
                const previewSrc = document.getElementById('visualPreviewImg').src;
                if (previewSrc && previewSrc.startsWith('data:')) cover_image_url = previewSrc;
              }
            } catch (e) {
              const previewSrc = document.getElementById('visualPreviewImg').src;
              if (previewSrc && previewSrc.startsWith('data:')) cover_image_url = previewSrc;
            }
          } else if (uploadedVisualFile) {
            // Not logged in  use data URL as preview
            const previewSrc = document.getElementById('visualPreviewImg').src;
            if (previewSrc && previewSrc.startsWith('data:')) cover_image_url = previewSrc;
          }
          break;
        case 'music':
          const linkArea = document.getElementById('musicLinkArea');
          if (linkArea.style.display === 'none') {
            content = uploadedMusicFile ? uploadedMusicFile.name : '';
          } else {
            content = document.getElementById('musicLink').value.trim();
          }
          description = document.getElementById('musicDescription').value.trim();
          break;
        case 'idea':
          content = document.getElementById('ideaContent').value.trim();
          description = document.getElementById('ideaTags').value.trim();
          break;
      }

      if (!title || !content) {
        showToast('Please fill in the required fields');
        return;
      }

      // Use 'garden' as the view_mode when creating from within the garden room
      const effectiveViewMode = gardenCreateContext ? 'garden' : selectedMode;

      const newCreation = {
        type: selectedCreateType,
        title: title,
        content: content,
        description: description,
        mood: selectedCreateMood,
        visibility: visibility,
        view_mode: effectiveViewMode,
        cover_image_url: cover_image_url,
        created_at: new Date().toISOString()
      };

      // Refresh auth session in case it expired
      if (db && !currentUser) {
        try {
          const { data: { session } } = await db.auth.getSession();
          if (session) currentUser = session.user;
        } catch (e) {}
      }

      // Save to Supabase if logged in
      if (db && currentUser) {
        try {
          const { data, error } = await db.from('creations').insert({
            ...newCreation,
            user_id: currentUser.id
          }).select();

          if (error) {
            console.error('Save creation error:', error);
            showToast(' Could not save: ' + error.message);
            return;
          }

          if (data && data[0]) {
            newCreation.id = data[0].id;
            newCreation.user_id = currentUser.id;
          }
        } catch (err) {
          console.error('Save creation exception:', err);
          showToast(' Could not reach the server. Please check your connection.');
          return;
        }
      } else {
        // Not logged in  save locally and prompt to log in
        newCreation.id = Date.now();
        const creations = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
        creations.push(newCreation);
        localStorage.setItem('introvert_creations', JSON.stringify(creations));
        showToast(' You\'re not logged in  saved locally only. Log in to keep your work.');
        closeCreateModal();
        if (gardenCreateContext) {
          gardenCreateContext = false;
          document.getElementById('createSubmitBtn').textContent = 'Create & Share ';
          addCreationToRoom(newCreation);
        } else {
          addCreationToView(newCreation);
        }
        return;
      }

      closeCreateModal();

      // Garden room context: plant the creation into the room interior
      if (gardenCreateContext) {
        gardenCreateContext = false;
        document.getElementById('createSubmitBtn').textContent = 'Create & Share ';
        addCreationToRoom(newCreation);
        showToast(' Your creation is taking root...');
      } else {
        showToast(' Creation added to your space!');
        addCreationToView(newCreation);
      }
    }

    const typeEmojis = {
      writing: '',
      visual: '',
      music: '',
      idea: ''
    };

    function addCreationToView(creation) {
      // If in constellation view, add a new node
      const constellationView = document.getElementById('constellationView');
      if (constellationView && constellationView.classList.contains('active')) {
        addCreationToConstellation(creation);
      }

      // If in canvas view, add a new card
      const canvasView = document.getElementById('canvasView');
      if (canvasView && canvasView.classList.contains('active')) {
        addCreationToCanvas(creation);
      }

      // If in seasonal view, add a card
      const seasonalView = document.getElementById('seasonalView');
      if (seasonalView && seasonalView.classList.contains('active')) {
        addCreationToSeasonal(creation);
      }
    }

    function addCreationToConstellation(creation) {
      const el = document.getElementById('constellationView');
      const emptyState = el.querySelector('.constellation-empty-state');
      if (emptyState) emptyState.style.display = 'none';

      const type = creation.type || 'idea';
      const angle = (CLUSTER_ANGLES[type] || 0) * Math.PI / 180;
      const clusterList = clusterNodes[type] || [];
      const idx = clusterList.length;
      // Spread within cluster: small angle offset per star
      const spread = 0.25;
      const spreadAngle = angle + (idx - (clusterList.length > 1 ? 1 : 0)) * spread * (idx % 2 === 0 ? 1 : -1);
      // Distance from center  newer = closer
      const minR = 0.15, maxR = 0.32;
      const r = minR + (idx * 0.04 > maxR - minR ? maxR - minR : idx * 0.04);

      const vw = window.innerWidth, vh = window.innerHeight;
      const cx = 50, cy = 50;
      const px = cx + r * 100 * Math.cos(spreadAngle) * (vh / vw);
      const py = cy + r * 100 * Math.sin(spreadAngle);

      const node = document.createElement('div');
      node.className = 'creation-node';
      node.style.cssText = `left:${Math.min(90,Math.max(10,px))}%;top:${Math.min(88,Math.max(12,py))}%`;
      node.dataset.type = type;
      node.dataset.id = String(creation.id || '');
      node.innerHTML = `<div class="node-orb type-${type}">${typeEmojis[type] || ''}</div><span class="node-label">${creation.title}</span>`;
      node.onclick = (e) => { e.stopPropagation(); showStarInfoCard(creation, node); };
      el.appendChild(node);

      // Track position for lines
      if (clusterNodes[type]) clusterNodes[type].push({ node, px, py });
      else clusterNodes[type] = [{ node, px, py }];

      // Redraw cluster lines
      drawClusterLines(type);
    }

    function drawClusterLines(type) {
      const svg = document.getElementById('constLinesSvg');
      if (!svg) return;
      const color = TYPE_COLORS[type] || 'rgba(255,255,255,0.1)';
      // Remove old lines for this type
      svg.querySelectorAll(`line[data-type="${type}"]`).forEach(l => l.remove());
      const nodes = clusterNodes[type] || [];
      if (nodes.length < 2) return;

      const vw = window.innerWidth, vh = window.innerHeight;
      // Connect each node to the next
      for (let i = 0; i < nodes.length - 1; i++) {
        const a = nodes[i], b = nodes[i+1];
        const x1 = (a.px / 100) * vw, y1 = (a.py / 100) * vh;
        const x2 = (b.px / 100) * vw, y2 = (b.py / 100) * vh;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', x1); line.setAttribute('y1', y1);
        line.setAttribute('x2', x2); line.setAttribute('y2', y2);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', '0.5');
        line.setAttribute('stroke-opacity', '0.25');
        line.setAttribute('data-type', type);
        svg.appendChild(line);
      }
      // Also draw a faint line from center (50%,50%) to first node
      const first = nodes[0];
      const cx = vw * 0.5, cy = vh * 0.5;
      const nx = (first.px / 100) * vw, ny = (first.py / 100) * vh;
      const l0 = document.createElementNS('http://www.w3.org/2000/svg','line');
      l0.setAttribute('x1', cx); l0.setAttribute('y1', cy);
      l0.setAttribute('x2', nx); l0.setAttribute('y2', ny);
      l0.setAttribute('stroke', color);
      l0.setAttribute('stroke-width', '0.5');
      l0.setAttribute('stroke-opacity', '0.12');
      l0.setAttribute('data-type', type);
      svg.appendChild(l0);
    }

    function addDistantGalaxy(userId, username, creations, idx, total) {
      const el = document.getElementById('constellationView');
      if (!el) return;

      // Distribute galaxies evenly around the outer ring (avoid the 4 cluster angles)
      // Offset base angle by 22.5 to sit between cluster quadrants
      const baseAngle = 22.5 + (idx / Math.max(total, 1)) * 360;
      const angleDeg = baseAngle;
      const angleRad = angleDeg * Math.PI / 180;

      // Position far from center (6580% radius)
      const rMin = 0.62, rMax = 0.78;
      const r = rMin + ((idx % 3) / 3) * (rMax - rMin);
      const vw = window.innerWidth, vh = window.innerHeight;
      const cx = 50, cy = 50;
      const px = cx + r * 100 * Math.cos(angleRad) * (vh / vw);
      const py = cy + r * 100 * Math.sin(angleRad);

      const galaxy = document.createElement('div');
      galaxy.className = 'distant-galaxy';
      galaxy.style.cssText = `left:${Math.min(92,Math.max(8,px))}%;top:${Math.min(90,Math.max(10,py))}%`;
      galaxy.title = `${username}'s galaxy`;

      // Determine mini-star colors from creation types
      const typeColors = {
        writing: '#c4a1ff', visual: '#7cb8e8', music: '#7ce8a8', idea: '#e8c87c'
      };
      const count = Math.min(creations.length, 6);
      let miniStars = '';
      // Place mini-stars around center of the galaxy core
      for (let i = 0; i < count; i++) {
        const a = (i / count) * 360;
        const rad = a * Math.PI / 180;
        const mr = 18 + (i % 2) * 6; // 18 or 24px from center
        const mx = 50 + (mr / 52) * 100 * Math.cos(rad); // % of core width (52px)
        const my = 50 + (mr / 52) * 100 * Math.sin(rad);
        const c = creations[i];
        const col = typeColors[c.type] || '#c4a1ff';
        const sz = 3 + (i === 0 ? 2 : 0);
        const delay = (i * 0.6).toFixed(1);
        miniStars += `<div class="distant-galaxy-mini-star" style="width:${sz}px;height:${sz}px;background:${col};left:${mx}%;top:${my}%;box-shadow:0 0 6px ${col};animation-delay:${delay}s"></div>`;
      }

      galaxy.innerHTML = `
        <div class="distant-galaxy-core">
          <div class="distant-galaxy-ring"></div>
          ${miniStars}
          <div class="distant-galaxy-center"></div>
        </div>
        <div class="distant-galaxy-label"> ${username}</div>
        <div class="distant-galaxy-count">${creations.length} creation${creations.length !== 1 ? 's' : ''}</div>
      `;

      galaxy.addEventListener('click', (e) => {
        e.stopPropagation();
        showUserGalaxyModal(userId, username, creations);
      });

      el.appendChild(galaxy);
    }

    function showUserGalaxyModal(userId, username, creations) {
      // Remove any existing modal
      const existing = document.getElementById('userGalaxyModalOverlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.className = 'user-galaxy-modal-overlay';
      overlay.id = 'userGalaxyModalOverlay';

      const itemsHtml = creations.map(c => {
        const icons = { writing: '', visual: '', music: '', idea: '' };
        const snippet = (c.content || c.description || '').slice(0, 120) || 'No preview.';
        return `
          <div class="user-galaxy-creation-item">
            <div class="ugci-icon type-${c.type || 'idea'}">${icons[c.type] || ''}</div>
            <div>
              <div class="ugci-title">${c.title || 'Untitled'}</div>
              <div class="ugci-snippet">${snippet}</div>
              <div class="ugci-type">${(c.type || 'idea').toUpperCase()}</div>
            </div>
          </div>`;
      }).join('');

      overlay.innerHTML = `
        <div class="user-galaxy-modal">
          <div class="user-galaxy-modal-header">
            <div>
              <div class="user-galaxy-modal-title"> ${username}'s Galaxy</div>
              <div class="user-galaxy-modal-subtitle">${creations.length} creation${creations.length !== 1 ? 's' : ''} in this constellation</div>
            </div>
            <button class="user-galaxy-modal-close" onclick="closeUserGalaxyModal()"></button>
          </div>
          <div class="user-galaxy-creation-list">${itemsHtml}</div>
        </div>`;

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeUserGalaxyModal();
      });

      document.body.appendChild(overlay);
      requestAnimationFrame(() => overlay.classList.add('visible'));
    }

    function closeUserGalaxyModal() {
      const overlay = document.getElementById('userGalaxyModalOverlay');
      if (!overlay) return;
      overlay.classList.remove('visible');
      setTimeout(() => overlay.remove(), 260);
    }

    function showStarInfoCard(creation, node) {
      activeStarCreation = creation;
      const card = document.getElementById('starInfoCard');
      if (!card) return;
      document.getElementById('starInfoType').textContent = (creation.type || 'idea').toUpperCase();
      document.getElementById('starInfoTitle').textContent = creation.title;
      document.getElementById('starInfoSnippet').textContent = creation.content || creation.description || 'No preview available.';
      const del = document.getElementById('starInfoDelete');
      if (del) del.onclick = () => deleteConstellationStar(creation.id, node);

      // Position near the node
      const rect = node.getBoundingClientRect();
      let left = rect.right + 12;
      let top = rect.top - 20;
      if (left + 220 > window.innerWidth) left = rect.left - 232;
      if (top + 160 > window.innerHeight) top = window.innerHeight - 170;
      card.style.left = Math.max(8, left) + 'px';
      card.style.top = Math.max(8, top) + 'px';
      card.classList.add('visible');
    }

    function hideStarInfoCard() {
      const card = document.getElementById('starInfoCard');
      if (card) card.classList.remove('visible');
      activeStarCreation = null;
    }

    async function deleteConstellationStar(id, node) {
      hideStarInfoCard();
      if (node) node.remove();
      const sid = String(id);
      // Remove from own creations localStorage
      try {
        const saved = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
        localStorage.setItem('introvert_creations', JSON.stringify(saved.filter(c => String(c.id) !== sid)));
      } catch(e) {}
      // Delete from Supabase (RLS ensures only own rows are deleted)
      if (db) {
        try {
          await db.from('creations').delete().eq('id', id);
        } catch(e) {}
      }
      showToast(' Star removed from your constellation');
    }

    function filterConstellation(type, btn) {
      document.querySelectorAll('.const-control-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.creation-node').forEach(n => {
        n.style.opacity = (!type || n.dataset.type === type) ? '1' : '0.1';
      });
      document.querySelectorAll('.const-lines-svg line').forEach(l => {
        l.style.opacity = (!type || l.dataset.type === type) ? '1' : '0';
      });
    }

    function addCreationToCanvas(creation) {
      const canvas = document.querySelector('.infinite-canvas');
      if (!canvas) return;
      const card = document.createElement('div');
      card.className = 'canvas-creation';
      card.style.left = (3500 + Math.random() * 1000) + 'px';
      card.style.top = (3500 + Math.random() * 1000) + 'px';
      card.innerHTML = `
        <div class="creation-image">${typeEmojis[creation.type] || ''}</div>
        <div class="creation-info">
          <div class="creation-title">${creation.title}</div>
          <div class="creation-author">
            <div class="author-avatar"></div>
            <span>You  just now</span>
          </div>
          ${creation.mood ? `<div class="creation-meta"><span class="mood-tag">${creation.mood}</span></div>` : ''}
        </div>
      `;
      canvas.appendChild(card);
    }

    function addCreationToSeasonal(creation) {
      const grid = document.getElementById('seasonalCreationsGrid');
      const emptyState = document.querySelector('.seasonal-empty-state-main');
      if (!grid) return;

      // Hide empty state when we have creations
      if (emptyState) emptyState.style.display = 'none';

      // Get author info from profiles join or fallback
      const profile = creation.profiles || {};
      const authorName = profile.username || 'Anonymous';
      const authorAvatar = profile.avatar || profile.avatar_emoji || '';
      const isOwnCreation = currentUser && creation.user_id === currentUser.id;

      const card = document.createElement('div');
      card.className = 'seasonal-creation-card';
      card.innerHTML = `
        <div class="seasonal-creation-image">
          <span class="seasonal-creation-type">${typeEmojis[creation.type] || ''}</span>
        </div>
        <div class="seasonal-creation-info">
          <h4 class="seasonal-creation-title">${escapeHtml(creation.title)}</h4>
          <div class="seasonal-creation-author">
            <div class="seasonal-creation-author-avatar">${authorAvatar}</div>
            <span>${isOwnCreation ? 'You' : escapeHtml(authorName)}</span>
          </div>
          ${creation.mood ? `<div class="seasonal-creation-footer"><span class="mood-tag">${creation.mood}</span></div>` : ''}
        </div>
      `;
      card.onclick = () => showCreationDetail(creation);
      grid.appendChild(card);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let activeDetailCreation = null;

    function showCreationDetail(creation) {
      activeDetailCreation = creation;
      const typeEmoji = { writing: '', visual: '', music: '', idea: '' };

      document.getElementById('detailEmoji').textContent = typeEmoji[creation.type] || '';
      document.getElementById('detailTitle').textContent = creation.title;

      // Tags
      const tagsEl = document.getElementById('detailTags');
      tagsEl.innerHTML = `<span class="creation-detail-tag">${creation.type}</span>`;
      if (creation.mood) tagsEl.innerHTML += `<span class="creation-detail-tag mood">${creation.mood}</span>`;

      // Body content
      const body = document.getElementById('detailBody');
      body.innerHTML = '';
      if (creation.type === 'visual' && creation.cover_image_url) {
        body.innerHTML = `<img class="creation-detail-image" src="${creation.cover_image_url}" alt="${creation.title}">`;
        if (creation.description) {
          body.innerHTML += `<p class="creation-detail-content" style="margin-top:20px;">${escapeHtml(creation.description)}</p>`;
        }
      } else if (creation.type === 'music') {
        const isLink = creation.content && creation.content.startsWith('http');
        body.innerHTML = isLink
          ? `<a class="creation-detail-music-link" href="${creation.content}" target="_blank" rel="noopener"> &nbsp;Listen to this piece</a>`
          : `<div class="creation-detail-content"> ${escapeHtml(creation.content || '')}</div>`;
        if (creation.description) {
          body.innerHTML += `<p class="creation-detail-content" style="margin-top:20px;">${escapeHtml(creation.description)}</p>`;
        }
      } else {
        body.innerHTML = `<div class="creation-detail-content">${escapeHtml(creation.content || creation.description || '')}</div>`;
      }

      // Date
      const date = creation.created_at ? new Date(creation.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      document.getElementById('detailDate').textContent = date;

      // Show delete button only for owner
      const deleteBtn = document.getElementById('detailDeleteBtn');
      deleteBtn.style.display = (currentUser && creation.user_id === currentUser.id) ? 'block' : 'none';

      document.getElementById('creationDetailOverlay').classList.add('active');
    }

    function closeCreationDetail(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('creationDetailOverlay').classList.remove('active');
      activeDetailCreation = null;
    }

    async function deleteCurrentCreation() {
      if (!activeDetailCreation) return;
      const creation = activeDetailCreation;

      const confirmed = confirm(`Delete "${creation.title}"? This cannot be undone.`);
      if (!confirmed) return;

      // Delete from Supabase
      if (db && currentUser && creation.id && typeof creation.id === 'string') {
        try {
          const { error } = await db.from('creations').delete().eq('id', creation.id).eq('user_id', currentUser.id);
          if (error) { showToast(' Could not delete: ' + error.message); return; }
        } catch (e) {
          showToast(' Error deleting creation'); return;
        }
      } else {
        // Remove from localStorage
        const saved = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
        localStorage.setItem('introvert_creations', JSON.stringify(saved.filter(c => c.id !== creation.id)));
      }

      // Remove card from grid
      const grid = document.getElementById('interiorCreationsGrid');
      if (grid) {
        grid.querySelectorAll('.interior-creation-card').forEach(card => {
          if (card.dataset.creationId === String(creation.id)) card.remove();
        });
      }

      closeCreationDetail();
      showToast(' Creation deleted');

      // Reload room to stay in sync
      loadRoomCreations();
    }

    // Load all saved creations on page load
    async function loadSavedCreations() {
      let creations = [];

      // Try to load from Supabase first
      if (db) {
        try {
          // Load all public creations + user's own creations for current view mode
          const { data, error } = await db
            .from('creations')
            .select('*')
            .or(`visibility.eq.public,user_id.eq.${currentUser?.id || '00000000-0000-0000-0000-000000000000'}`)
            .eq('view_mode', selectedMode)
            .order('created_at', { ascending: false });

          if (!error && data && data.length > 0) {
            creations = data;

            // Fetch profiles for all unique user_ids
            const userIds = [...new Set(data.map(c => c.user_id).filter(Boolean))];
            if (userIds.length > 0) {
              const { data: profiles } = await db
                .from('profiles')
                .select('id, username, avatar, avatar_emoji, avatar_bg, avatar_url')
                .in('id', userIds);

              // Attach profile to each creation
              if (profiles) {
                const profileMap = {};
                profiles.forEach(p => profileMap[p.id] = p);
                creations = creations.map(c => ({
                  ...c,
                  profiles: profileMap[c.user_id] || null
                }));
              }
            }
          }
        } catch (err) {
          console.error('Load creations error:', err);
        }
      }

      // Fallback to localStorage if no DB creations
      if (creations.length === 0) {
        creations = JSON.parse(localStorage.getItem('introvert_creations') || '[]');
      }

      if (creations.length === 0) return;

      const seasonalView = document.getElementById('seasonalView');
      const constellationView = document.getElementById('constellationView');
      const canvasView = document.getElementById('canvasView');

      creations.forEach(creation => {
        if (seasonalView && seasonalView.classList.contains('active')) {
          addCreationToSeasonal(creation);
        } else if (constellationView && constellationView.classList.contains('active')) {
          addCreationToConstellation(creation);
        } else if (canvasView && canvasView.classList.contains('active')) {
          addCreationToCanvas(creation);
        }
      });
    }

    // Close modal on overlay click
    document.getElementById('createModal').addEventListener('click', function(e) {
      if (e.target.id === 'createModal') {
        closeCreateModal();
      }
    });

    // ========== MODE PERSISTENCE VIA LOCALSTORAGE ==========
    // Save mode to localStorage when entering a space
    const originalEnterSpace = enterSpace;
    enterSpace = function() {
      originalEnterSpace();
      localStorage.setItem('introvert_creative_mode', selectedMode);
    };

    const originalSelectModeAndEnter = selectModeAndEnter;
    selectModeAndEnter = function(mode) {
      originalSelectModeAndEnter(mode);
      localStorage.setItem('introvert_creative_mode', mode);
    };

    // On page load, check for saved mode and restore it
    (function restoreModeFromStorage() {
      const mode = localStorage.getItem('introvert_creative_mode');
      if (mode && ['constellation', 'canvas', 'garden', 'seasonal'].includes(mode)) {
        selectedMode = mode;
        // Skip wizard and go directly to the creative space with saved mode
        document.getElementById('wizardPage').classList.remove('active');
        document.getElementById('creativePage').classList.add('active');
        showViewByName(mode);
        // Initialize the view
        if (mode === 'canvas') initInfiniteCanvas();
        else if (mode === 'constellation') initConstellation();
        else if (mode === 'seasonal') initSeasonalParticles();
        // Load saved creations
        setTimeout(loadSavedCreations, 100);
      }
    })();
  </script>

</body>
</html>

