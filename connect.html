<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect - Introvert Place</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0c10;
      --bg-surface: #12151c;
      --bg-elevated: #1a1e28;
      --bg-hover: #242a36;
      --accent-warm: #e8a87c;
      --accent-soft: #c4a1ff;
      --accent-calm: #7cb8e8;
      --accent-green: #7ce8a8;
      --accent-gold: #f0e87c;
      --accent-rose: #e87c9a;
      --text-primary: #f0eeeb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border-subtle: rgba(255,255,255,0.06);
      --border-light: rgba(255,255,255,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-full: 9999px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
    }

    h1, h2, h3, h4 { font-family: 'Fraunces', serif; font-weight: 400; }

    /* Layout */
    .app-container { display: flex; min-height: 100vh; }

    /* Main Content */
    .main-content {
      flex: 1;
      min-height: 100vh;
      position: relative;
    }

    .ambient-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(120px);
      animation: float 25s ease-in-out infinite;
    }

    .orb-1 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(196,161,255,0.2) 0%, transparent 70%);
      top: -200px;
      right: -100px;
    }

    .orb-2 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(124,232,168,0.15) 0%, transparent 70%);
      bottom: -150px;
      left: 20%;
      animation-direction: reverse;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, -30px) scale(1.05); }
    }

    .content-wrapper {
      position: relative;
      z-index: 1;
      padding: 36px 48px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .page-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .page-header h1 { font-size: 42px; font-weight: 300; margin-bottom: 12px; }
    .page-header .tagline { font-size: 20px; color: var(--text-secondary); margin-bottom: 8px; }
    .page-header .subtitle { font-family: 'Fraunces', serif; font-size: 16px; font-style: italic; color: var(--text-muted); }

    /* Search */
    .search-section {
      max-width: 600px;
      margin: 0 auto 40px;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 18px 24px 18px 56px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 4px rgba(196,161,255,0.1);
    }

    .search-input::placeholder { color: var(--text-muted); }

    .search-icon {
      position: absolute;
      left: 22px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--text-muted);
    }

    .search-hints {
      text-align: center;
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .search-hints span { margin: 0 10px; }

    /* Search Results */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    .search-results.active { display: block; }
    .search-results-empty {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }
    .search-results-empty .icon { font-size: 32px; margin-bottom: 12px; }
    .search-category {
      padding: 12px 16px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .search-result-item:hover { background: var(--bg-elevated); }
    .search-result-item:last-child { border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
    .search-result-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-name { font-size: 15px; font-weight: 500; margin-bottom: 2px; }
    .search-result-meta { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result-badge {
      padding: 4px 10px;
      background: rgba(196,161,255,0.15);
      color: var(--accent-soft);
      border-radius: var(--radius-full);
      font-size: 11px;
      flex-shrink: 0;
    }
    .search-loading {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
    }
    .search-loading .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-soft);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover { background: var(--bg-elevated); color: var(--text-primary); }

    .tab.active {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    .tab-badge {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 12px;
    }

    .tab.active .tab-badge { background: rgba(0,0,0,0.2); }

    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Communities */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .section-header h2 { font-size: 24px; }

    .create-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .create-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(196,161,255,0.3);
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter {
      padding: 8px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .filter.active { background: var(--bg-elevated); border-color: var(--accent-soft); color: var(--text-primary); }

    .communities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .community-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .community-card:hover {
      border-color: var(--accent-soft);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }

    .community-top {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .community-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .community-info { flex: 1; }
    .community-info h4 { font-size: 20px; margin-bottom: 6px; }

    .community-stats {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .community-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .community-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tag {
      padding: 4px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-muted);
    }

    .community-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .activity {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .join-btn {
      padding: 10px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .join-btn:hover {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    .join-btn.joined {
      background: rgba(124,232,168,0.15);
      border-color: rgba(124,232,168,0.3);
      color: var(--accent-green);
    }

    /* Find Souls */
    .souls-intro {
      text-align: center;
      padding: 40px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      margin-bottom: 32px;
    }

    .souls-intro .intro-icon { font-size: 56px; margin-bottom: 16px; }
    .souls-intro h3 { font-size: 26px; margin-bottom: 10px; }
    .souls-intro p { font-size: 16px; color: var(--text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.6; }

    .privacy-note {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 20px;
    }

    .souls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .soul-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 28px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .soul-card:hover {
      border-color: var(--accent-soft);
      transform: translateY(-4px);
    }

    .soul-avatar {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-lg);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .soul-name { font-size: 18px; font-weight: 500; margin-bottom: 4px; }
    .soul-tagline { font-size: 14px; color: var(--text-muted); font-style: italic; margin-bottom: 16px; }

    .match-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(124,232,168,0.1);
      border: 1px solid rgba(124,232,168,0.2);
      border-radius: var(--radius-full);
      font-size: 13px;
      color: var(--accent-green);
      margin-bottom: 16px;
    }

    .interests {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .interest {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .wave-btn {
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .wave-btn:hover {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    .wave-btn.waved {
      background: rgba(196,161,255,0.15);
      border-color: rgba(196,161,255,0.3);
      color: var(--accent-soft);
      pointer-events: none;
    }

    /* Messages */
    .messages-section { max-width: 800px; margin: 0 auto; }

    .async-banner {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(124,232,168,0.1) 0%, rgba(124,184,232,0.1) 100%);
      border: 1px solid rgba(124,232,168,0.2);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .async-banner .icon { font-size: 40px; }
    .async-banner h4 { font-size: 18px; margin-bottom: 6px; }
    .async-banner p { font-size: 14px; color: var(--text-secondary); }

    .async-badges {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .async-badge {
      padding: 10px 18px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conversations { display: flex; flex-direction: column; gap: 12px; }

    .conversation {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .conversation:hover { background: var(--bg-elevated); }
    .conversation.unread { border-left: 3px solid var(--accent-soft); }

    .convo-avatar {
      width: 52px;
      height: 52px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
    }

    .convo-content { flex: 1; min-width: 0; }
    .convo-header { display: flex; justify-stretch: space-between; margin-bottom: 4px; }
    .convo-name { font-size: 15px; font-weight: 500; }
    .convo-time { font-size: 12px; color: var(--text-muted); }
    .convo-preview { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .unread-dot {
      width: 10px;
      height: 10px;
      background: var(--accent-soft);
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Conversation View */
    .convo-view-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .convo-view-header .back-btn {
      width: 36px; height: 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 50%;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .convo-view-header .back-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .convo-view-header .convo-user-info { flex: 1; }
    .convo-view-header .convo-user-name { font-size: 16px; font-weight: 500; }
    .convo-view-header .convo-user-status { font-size: 12px; color: var(--text-muted); }
    .convo-view-avatar {
      width: 42px; height: 42px;
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0;
    }

    .messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      min-height: 200px;
    }

    .message-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .message-bubble.sent {
      align-self: flex-end;
      background: rgba(196,161,255,0.2);
      border: 1px solid rgba(196,161,255,0.15);
      color: var(--text-primary);
      border-bottom-right-radius: 4px;
    }
    .message-bubble.received {
      align-self: flex-start;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }
    .message-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .message-bubble.sent .message-time { text-align: right; }

    .message-input-area {
      display: flex;
      gap: 10px;
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
    }
    .message-input-area input {
      flex: 1;
      padding: 12px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
    }
    .message-input-area input:focus {
      outline: none;
      border-color: var(--accent-soft);
    }
    .message-input-area input::placeholder { color: var(--text-muted); }
    .send-btn {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: 50%;
      color: var(--bg-deep);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .send-btn:hover { transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .messages-empty {
      padding: 60px 24px;
      text-align: center;
      color: var(--text-muted);
    }
    .messages-empty .icon { font-size: 48px; margin-bottom: 16px; }

    /* Profile View Modal */
    .profile-view-card {
      text-align: center;
      padding: 12px 0;
    }
    .profile-view-avatar {
      width: 80px; height: 80px;
      border-radius: var(--radius-lg);
      margin: 0 auto 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 40px;
    }
    .profile-view-name { font-size: 22px; font-weight: 500; margin-bottom: 4px; }
    .profile-view-bio { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
    .profile-view-interests { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .profile-view-actions { display: flex; gap: 12px; }
    .profile-view-actions button { flex: 1; }

    /* Modals */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(10,12,16,0.9);
      backdrop-filter: blur(12px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal.active { display: flex; }

    .modal-box {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 28px 28px 0;
      text-align: center;
    }

    .modal-header .icon { font-size: 48px; margin-bottom: 16px; }
    .modal-header h2 { font-size: 28px; margin-bottom: 8px; }
    .modal-header p { font-size: 15px; color: var(--text-secondary); }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

    .modal-body { padding: 28px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .form-group textarea { min-height: 100px; resize: vertical; line-height: 1.5; }

    .form-group select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      cursor: pointer;
    }

    .icon-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .icon-opt {
      width: 52px;
      height: 52px;
      background: var(--bg-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-md);
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-opt:hover { background: var(--bg-hover); }
    .icon-opt.selected { border-color: var(--accent-soft); background: rgba(196,161,255,0.1); }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(196,161,255,0.3);
    }

    /* Graceful Decline Modal */
    .battery-display {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .battery-mini {
      width: 60px;
      height: 30px;
      background: var(--bg-deep);
      border-radius: 6px;
      overflow: hidden;
    }

    .battery-mini .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-warm), var(--accent-gold));
    }

    .battery-display .text .pct { font-size: 24px; font-weight: 600; }
    .battery-display .text .status { font-size: 13px; color: var(--text-muted); }

    .tone-grid {
      display: flex;
      gap: 10px;
    }

    .tone-opt {
      flex: 1;
      padding: 14px;
      background: var(--bg-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .tone-opt:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tone-opt.active { border-color: var(--accent-rose); background: rgba(232,124,154,0.1); color: var(--text-primary); }
    .tone-opt .emoji { display: block; font-size: 24px; margin-bottom: 6px; }

    .generate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-rose) 0%, var(--accent-warm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 24px;
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(232,124,154,0.3);
    }

    .response-box {
      display: none;
      padding: 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--accent-green);
    }

    .response-box.show { display: block; animation: fadeIn 0.4s ease; }
    .response-box .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }
    .response-box .text { font-size: 16px; line-height: 1.7; margin-bottom: 20px; }

    .response-btns { display: flex; gap: 10px; }

    .resp-btn {
      flex: 1;
      padding: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .resp-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .resp-btn.primary { background: var(--accent-green); color: var(--bg-deep); border-color: var(--accent-green); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 28px;
      background: var(--accent-green);
      color: var(--bg-deep);
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Responsive */
    @media (max-width: 600px) {
      .content-wrapper { padding: 20px 16px; }
      .page-header h1 { font-size: 32px; }
      .tabs { justify-content: flex-start; overflow-x: auto; }
      .tone-grid { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="app-container">

    <!-- Main Content -->
    <main class="main-content">
      
      <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
      </div>

      <div class="content-wrapper">
        
        <!-- Header -->
        <header class="page-header">
          <h1>ü§ù Connect</h1>
          <p class="tagline">Find your people. No small talk required.</p>
          <p class="subtitle">Communities for quiet connection. Join when ready, participate when comfortable.</p>
        </header>

        <!-- Search -->
        <div class="search-section">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search communities, interests, or similar souls..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
          </div>
          <p class="search-hints">
            <span>üè† communities</span>
            <span>üí≠ interests</span>
            <span>‚ú® similar souls</span>
          </p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="communities"><span>üè†</span> Communities</button>
          <button class="tab" data-tab="souls"><span>‚ú®</span> Find Souls</button>
          <button class="tab" data-tab="messages"><span>üí¨</span> Messages <span class="tab-badge" id="messagesBadge" style="display: none;">0</span></button>
        </div>

        <!-- COMMUNITIES TAB -->
        <div class="tab-content active" id="tab-communities">
          
          <div class="section-header">
            <h2>Discover Communities</h2>
            <button class="create-btn" onclick="openModal('createModal')">
              <span>‚ú®</span> Create Community
            </button>
          </div>

          <div class="filters">
            <button class="filter active">All</button>
            <button class="filter">Joined</button>
            <button class="filter">Reading</button>
            <button class="filter">Creative</button>
            <button class="filter">Wellness</button>
            <button class="filter">Night Owls</button>
          </div>

          <div class="communities-grid">
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">üåø</span>
              <h3 style="margin-top: 16px;">No communities yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Communities will appear here as the platform grows. Be one of the first to create a space!</p>
            </div>
          </div>
        </div>

        <!-- FIND SOULS TAB -->
        <div class="tab-content" id="tab-souls">
          
          <div class="souls-intro">
            <div class="intro-icon">‚ú®</div>
            <h3>Find Similar Souls</h3>
            <p>Connect with people who share your interests and energy. No awkward intros ‚Äî we show what you have in common.</p>
            <div class="privacy-note"><span>üîí</span> Your profile is only shown to compatible matches</div>
          </div>

          <div class="souls-grid" id="soulsGrid">
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">üîÆ</span>
              <h3 style="margin-top: 16px;">Loading souls...</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Finding compatible souls who share your interests.</p>
            </div>
          </div>
        </div>

        <!-- MESSAGES TAB -->
        <div class="tab-content" id="tab-messages">
          <div class="messages-section">
            
            <div class="async-banner">
              <div class="icon">üí¨</div>
              <div>
                <h4>Async-First Messaging</h4>
                <p>Take your time. No pressure to respond quickly ‚Äî we all understand.</p>
              </div>
            </div>

            <div class="async-badges">
              <div class="async-badge"><span>üëÅÔ∏è‚Äçüó®Ô∏è</span> No read receipts</div>
              <div class="async-badge"><span>‚å®Ô∏è</span> No typing indicators</div>
              <div class="async-badge"><span>üü¢</span> No online status</div>
            </div>

            <div class="conversations">
              <div style="padding: 60px 24px; text-align: center;">
                <span style="font-size: 48px;">üí¨</span>
                <h3 style="margin-top: 16px;">No messages yet</h3>
                <p style="color: var(--text-muted); margin-top: 8px;">When you connect with someone, your conversations will appear here.</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- CREATE COMMUNITY MODAL -->
  <div class="modal" id="createModal">
    <div class="modal-box">
      <button class="close-btn" onclick="closeModal('createModal')">‚úï</button>
      <div class="modal-header">
        <div class="icon">üè†</div>
        <h2>Create Community</h2>
        <p>Build a space for introverts who share your interests</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Community Name</label>
          <input type="text" placeholder="e.g., Rainy Day Writers">
        </div>
        <div class="form-group">
          <label>Choose an Icon</label>
          <div class="icon-grid">
            <div class="icon-opt selected">üåô</div>
            <div class="icon-opt">üìö</div>
            <div class="icon-opt">üé®</div>
            <div class="icon-opt">üéß</div>
            <div class="icon-opt">üßò</div>
            <div class="icon-opt">‚òï</div>
            <div class="icon-opt">üåø</div>
            <div class="icon-opt">üí≠</div>
            <div class="icon-opt">‚ú®</div>
            <div class="icon-opt">üåßÔ∏è</div>
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea placeholder="What's this community about?"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select>
            <option value="">Select a category...</option>
            <option>Creative & Art</option>
            <option>Reading & Writing</option>
            <option>Wellness & Recovery</option>
            <option>Music & Audio</option>
            <option>Night Owls</option>
            <option>Deep Conversations</option>
          </select>
        </div>
        <button class="submit-btn" onclick="createCommunity()">‚ú® Create Community</button>
      </div>
    </div>
  </div>

  <!-- GRACEFUL DECLINE MODAL -->
  <div class="modal" id="declineModal">
    <div class="modal-box">
      <button class="close-btn" onclick="closeModal('declineModal')">‚úï</button>
      <div class="modal-header">
        <div class="icon">üõ°Ô∏è</div>
        <h2>Graceful Decline</h2>
        <p>Need help saying no? We've got you.</p>
      </div>
      <div class="modal-body">
        <div class="battery-display">
          <div class="battery-mini"><div class="fill" style="width: 35%"></div></div>
          <div class="text">
            <div class="pct">35%</div>
            <div class="status">Social battery running low</div>
          </div>
        </div>

        <div class="form-group">
          <label>What's the situation?</label>
          <select id="situation">
            <option value="party">Friend invited me to a party</option>
            <option value="hangout">Coworker wants to hang out</option>
            <option value="family">Family gathering</option>
            <option value="videocall">Group video call</option>
            <option value="lastminute">Last-minute plans</option>
          </select>
        </div>

        <div class="form-group">
          <label>What tone feels right?</label>
          <div class="tone-grid">
            <div class="tone-opt active" data-tone="warm"><span class="emoji">üíõ</span>Warm</div>
            <div class="tone-opt" data-tone="professional"><span class="emoji">üíº</span>Professional</div>
            <div class="tone-opt" data-tone="honest"><span class="emoji">üíô</span>Honest</div>
          </div>
        </div>

        <button class="generate-btn" onclick="generateDecline()">‚ú® Generate Response</button>

        <div class="response-box" id="responseBox">
          <div class="label">Your graceful decline:</div>
          <p class="text" id="responseText"></p>
          <div class="response-btns">
            <button class="resp-btn primary" onclick="copyResponse()"><span>üìã</span> Copy</button>
            <button class="resp-btn" onclick="generateDecline()"><span>üîÑ</span> Regenerate</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // Supabase initialization
    const SUPABASE_URL = 'https://inpziyxjznikinqqputz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucHppeXhqem5pa2lucXFwdXR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzQ0MTcsImV4cCI6MjA4NDAxMDQxN30.5QoXaD5vNcuteEmwmo82l_OIklVbGGCRpNtV0PMuSyY';

    let db = null;
    let currentUser = null;

    try {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
      console.error('Supabase init error:', err);
    }

    // Auth check
    async function initAuth() {
      if (!db) return;
      try {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
          currentUser = session.user;
        }
      } catch (err) {
        console.error('Auth error:', err);
      }
    }

  </script>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // Filters
    document.querySelectorAll('.filter').forEach(f => {
      f.addEventListener('click', function() {
        document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Join buttons
    document.querySelectorAll('.join-btn:not(.joined)').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        this.classList.add('joined');
        this.textContent = '‚úì Joined';
        showToast('üè† Welcome to the community!');
      });
    });

    // Icon selector
    document.querySelectorAll('.icon-opt').forEach(icon => {
      icon.addEventListener('click', function() {
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
      });
    });

    // Tone selector
    document.querySelectorAll('.tone-opt').forEach(tone => {
      tone.addEventListener('click', function() {
        document.querySelectorAll('.tone-opt').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Modals
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
      });
    });

    // Also handle dynamically created modals
    document.addEventListener('click', function(e) {
      if (e.target.id === 'communityViewModal') {
        e.target.classList.remove('active');
      }
    });

    // Wave button
    function sendWave(btn) {
      btn.classList.add('waved');
      btn.innerHTML = '<span>‚úì</span> Wave sent!';
      showToast('üëã Quiet wave sent!');
    }

    // Create community
    async function createCommunity() {
      // Get form values
      const nameInput = document.querySelector('#createModal .form-group input[type="text"]');
      const descTextarea = document.querySelector('#createModal .form-group textarea');
      const categorySelect = document.querySelector('#createModal .form-group select');
      const selectedIcon = document.querySelector('#createModal .icon-opt.selected');

      const name = nameInput?.value?.trim();
      const description = descTextarea?.value?.trim();
      const category = categorySelect?.value;
      const icon = selectedIcon?.textContent || 'üåô';

      // Validate
      if (!name) {
        showToast('‚ö†Ô∏è Please enter a community name');
        return;
      }

      if (!db) {
        showToast('‚ö†Ô∏è Database not connected');
        return;
      }

      try {
        // Insert into Supabase
        const { data, error } = await db
          .from('communities')
          .insert([{
            name: name,
            description: description || '',
            category: category || 'General',
            icon: icon,
            creator_id: currentUser?.id || null,
            member_count: 1,
            created_at: new Date().toISOString()
          }])
          .select();

        if (error) {
          console.error('Create community error:', error);
          showToast('‚ö†Ô∏è Error: ' + (error.message || 'Could not create community'));
          return;
        }

        // Success - close modal and refresh
        closeModal('createModal');
        showToast('‚ú® Community created!');

        // Clear form
        if (nameInput) nameInput.value = '';
        if (descTextarea) descTextarea.value = '';
        if (categorySelect) categorySelect.selectedIndex = 0;

        // Reload communities
        loadCommunities();

      } catch (err) {
        console.error('Create community exception:', err);
        showToast('‚ö†Ô∏è Error creating community');
      }
    }

    // Load communities from database
    async function loadCommunities() {
      if (!db) return;

      const grid = document.querySelector('.communities-grid');
      if (!grid) return;

      try {
        // Fetch communities
        const { data: communities, error } = await db
          .from('communities')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Load communities error:', error);
          return;
        }

        if (!communities || communities.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">üåø</span>
              <h3 style="margin-top: 16px;">No communities yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Communities will appear here as the platform grows. Be one of the first to create a space!</p>
            </div>
          `;
          return;
        }

        // Get actual member counts from community_members table
        const memberCounts = {};
        const userMemberships = new Set();

        try {
          // Get counts for all communities
          const { data: countData } = await db
            .from('community_members')
            .select('community_id');

          if (countData) {
            countData.forEach(row => {
              memberCounts[row.community_id] = (memberCounts[row.community_id] || 0) + 1;
            });
          }

          // Check which communities current user has joined
          if (currentUser) {
            const { data: userJoined } = await db
              .from('community_members')
              .select('community_id')
              .eq('user_id', currentUser.id);

            if (userJoined) {
              userJoined.forEach(row => userMemberships.add(row.community_id));
            }
          }
        } catch (countErr) {
          console.log('Could not load member counts:', countErr);
        }

        // Render communities with actual member counts
        grid.innerHTML = communities.map(c => {
          const actualMemberCount = memberCounts[c.id] || 0;
          const isJoined = userMemberships.has(c.id);
          const memberText = actualMemberCount === 1 ? '1 member' : `${actualMemberCount} members`;

          return `
            <div class="community-card" onclick="viewCommunity('${c.id}')">
              <div class="community-top">
                <div class="community-icon">${c.icon || 'üè†'}</div>
                <div class="community-info">
                  <h4>${escapeHtml(c.name)}</h4>
                  <div class="community-stats">
                    <span>${memberText}</span>
                  </div>
                </div>
              </div>
              <p class="community-desc">${escapeHtml(c.description || '')}</p>
              <div class="community-tags">
                <span class="tag">${escapeHtml(c.category || 'General')}</span>
              </div>
              <div class="community-footer">
                <div class="activity">
                  <span class="activity-dot"></span>
                  <span>Active</span>
                </div>
                <button class="join-btn ${isJoined ? 'joined' : ''}" onclick="event.stopPropagation(); ${isJoined ? `leaveCommunity('${c.id}', this)` : `joinCommunity('${c.id}', this)`}">${isJoined ? '‚úì Joined' : 'Join'}</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load communities exception:', err);
      }
    }

    // Join a community
    async function joinCommunity(communityId, btn) {
      if (!db || !currentUser) {
        showToast('‚ö†Ô∏è Please sign in to join');
        return;
      }

      try {
        // Insert into community_members junction table
        const { error } = await db
          .from('community_members')
          .insert({
            user_id: currentUser.id,
            community_id: communityId
          });

        if (error) {
          // Check if already joined (unique constraint)
          if (error.code === '23505') {
            showToast('üëã You\'re already a member!');
            btn.classList.add('joined');
            btn.textContent = '‚úì Joined';
            return;
          }
          throw error;
        }

        // Update member count
        await db.rpc('increment_member_count', { cid: communityId }).catch(() => {
          // RPC might not exist, that's ok
        });

        btn.classList.add('joined');
        btn.textContent = '‚úì Joined';
        btn.onclick = function(e) { e.stopPropagation(); leaveCommunity(communityId, btn); };
        showToast('üè† Welcome to the community!');

        // Reload to update member counts
        setTimeout(() => loadCommunities(), 500);

      } catch (err) {
        console.error('Join community error:', err);
        showToast('‚ö†Ô∏è Error joining community');
      }
    }

    // Leave a community
    async function leaveCommunity(communityId, btn) {
      if (!db || !currentUser) return;

      try {
        const { error } = await db
          .from('community_members')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('community_id', communityId);

        if (error) throw error;

        btn.classList.remove('joined');
        btn.textContent = 'Join';
        btn.onclick = function(e) { e.stopPropagation(); joinCommunity(communityId, btn); };
        showToast('üëã Left community');

        // Reload to update member counts
        setTimeout(() => loadCommunities(), 500);

      } catch (err) {
        console.error('Leave community error:', err);
      }
    }

    // Load unread message count
    async function loadUnreadCount() {
      const badge = document.getElementById('messagesBadge');
      if (!badge) return;

      if (!db || !currentUser) {
        badge.style.display = 'none';
        return;
      }

      try {
        const { count, error } = await db
          .from('messages')
          .select('*', { count: 'exact', head: true })
          .eq('recipient_id', currentUser.id)
          .eq('read', false);

        if (error) {
          console.error('Load unread count error:', error);
          badge.style.display = 'none';
          return;
        }

        if (count && count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        console.error('Load unread count exception:', err);
        badge.style.display = 'none';
      }
    }

    // Ensure communities table exists (creates if needed)
    async function ensureCommunitiesTable() {
      if (!db) return;

      try {
        // Try to query the table - if it fails, we'll create it
        const { error } = await db.from('communities').select('id').limit(1);

        if (error && error.message.includes('does not exist')) {
          console.log('Communities table does not exist. Please create it in Supabase dashboard with:');
          console.log(`
CREATE TABLE communities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT DEFAULT 'General',
  icon TEXT DEFAULT 'üè†',
  creator_id UUID REFERENCES auth.users(id),
  member_count INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE communities ENABLE ROW LEVEL SECURITY;

-- Allow anyone to read communities
CREATE POLICY "Anyone can view communities" ON communities
  FOR SELECT USING (true);

-- Allow authenticated users to create communities
CREATE POLICY "Authenticated users can create communities" ON communities
  FOR INSERT WITH CHECK (true);
          `);
          showToast('‚ö†Ô∏è Database table needs setup - check console');
        }
      } catch (err) {
        console.error('Table check error:', err);
      }
    }

    // Load souls (all users from profiles)
    async function loadSouls() {
      if (!db) return;

      const grid = document.getElementById('soulsGrid');
      if (!grid) return;

      try {
        const { data: profiles, error } = await db
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(20);

        if (error) {
          console.error('Load souls error:', error);
          return;
        }

        if (!profiles || profiles.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">üîÆ</span>
              <h3 style="margin-top: 16px;">No souls yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Be one of the first to complete your profile and connect with others!</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = profiles.map(profile => {
          const avatar = profile.avatar_emoji || profile.avatar || 'üåô';
          const avatarBg = profile.avatar_bg || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          const interests = profile.interests ? profile.interests.split(',').map(i => i.trim()).filter(Boolean).slice(0, 3) : [];
          const isMe = currentUser && profile.id === currentUser.id;

          return `
            <div class="soul-card" onclick="viewProfile('${profile.id}')">
              <div class="soul-avatar" style="background: ${avatarBg}">${avatar}</div>
              <div class="soul-name">${escapeHtml(profile.username || 'Anonymous')}${isMe ? ' (You)' : ''}</div>
              <div class="soul-tagline">${escapeHtml(profile.tagline || profile.bio?.substring(0, 50) || 'A quiet soul')}</div>
              ${interests.length > 0 ? `
                <div class="interests">
                  ${interests.map(i => `<span class="interest">${escapeHtml(i)}</span>`).join('')}
                </div>
              ` : ''}
              ${!isMe ? `<button class="wave-btn" onclick="event.stopPropagation(); sendWave(this)">üëã Send a quiet wave</button>` : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load souls exception:', err);
      }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initAuth();
      await ensureCommunitiesTable();
      loadCommunities();
      loadUnreadCount();
      loadSouls();

      // Check URL params for auto-opening a community
      const urlParams = new URLSearchParams(window.location.search);
      const communityId = urlParams.get('community');
      if (communityId) {
        // Wait a moment for communities to load then open the specific one
        setTimeout(() => viewCommunity(communityId), 500);
      }
    });

    // Graceful decline responses
    const responses = {
      party: {
        warm: "Thank you so much for thinking of me! I'm going to sit this one out ‚Äî I need some quiet time to recharge. Have an amazing time! üíõ",
        professional: "Thank you for the invitation. Unfortunately, I have a prior commitment. I hope the event goes well!",
        honest: "I'd love to see you, but my social battery is completely drained. I need some alone time. Can we reschedule?"
      },
      hangout: {
        warm: "That's so nice of you! I'm pretty wiped today and need to decompress solo. Let's definitely do it another time! üíõ",
        professional: "Thanks for the offer! I have personal commitments this evening, but let's plan something else.",
        honest: "I appreciate you asking, but I need to recharge after work. Nothing personal ‚Äî just hit my limit today!"
      },
      family: {
        warm: "Thank you for including me! I need some quiet time this weekend. Send my love to everyone! üíõ",
        professional: "Thank you for the invitation. I won't be able to attend this time. I hope everyone has a lovely gathering.",
        honest: "I love you all, but I really need this weekend to recharge. My social battery is empty. Next time!"
      },
      videocall: {
        warm: "Thanks for including me! Video calls drain me, so I'll sit this one out. Fill me in later! üíõ",
        professional: "I have a scheduling conflict and can't join. Please send me any notes afterward.",
        honest: "I'm at my limit with video calls. Need a break from screens. Can someone fill me in after?"
      },
      lastminute: {
        warm: "That sounds fun! I'm already in decompress mode though. Have an amazing time! üíõ",
        professional: "Thank you for thinking of me. I already have plans this evening.",
        honest: "Last-minute plans stress me out ‚Äî I need time to mentally prepare. Rain check?"
      }
    };

    function generateDecline() {
      const situation = document.getElementById('situation').value;
      const tone = document.querySelector('.tone-opt.active').dataset.tone;
      const text = responses[situation][tone];
      
      document.getElementById('responseText').textContent = text;
      document.getElementById('responseBox').classList.add('show');
    }

    function copyResponse() {
      const text = document.getElementById('responseText').textContent;
      navigator.clipboard.writeText(text);
      showToast('üìã Copied to clipboard!');
    }

    // Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ========== SEARCH FUNCTIONALITY ==========
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout = null;

    // Debounced search
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();

      // Clear previous timeout
      clearTimeout(searchTimeout);

      // Hide results if query is empty
      if (!query) {
        searchResults.classList.remove('active');
        return;
      }

      // Show loading state
      searchResults.innerHTML = `
        <div class="search-loading">
          <span class="spinner"></span>Searching...
        </div>
      `;
      searchResults.classList.add('active');

      // Debounce search (300ms delay)
      searchTimeout = setTimeout(() => performSearch(query), 300);
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-box')) {
        searchResults.classList.remove('active');
      }
    });

    // Focus search on input click
    searchInput.addEventListener('focus', function() {
      if (this.value.trim()) {
        searchResults.classList.add('active');
      }
    });

    // Perform search across all data
    async function performSearch(query) {
      if (!db) {
        showNoResults(query);
        return;
      }

      const lowerQuery = query.toLowerCase();
      let results = {
        communities: [],
        users: [],
        interests: []
      };

      try {
        // Search communities
        const { data: communities } = await db
          .from('communities')
          .select('*')
          .or(`name.ilike.%${query}%,description.ilike.%${query}%`)
          .limit(5);

        if (communities) {
          results.communities = communities;
        }
      } catch (err) {
        console.log('Communities table may not exist yet');
      }

      try {
        // Search users/profiles
        const { data: profiles } = await db
          .from('profiles')
          .select('*')
          .or(`username.ilike.%${query}%,bio.ilike.%${query}%,interests.ilike.%${query}%`)
          .limit(10);

        if (profiles) {
          results.users = profiles;
        }
      } catch (err) {
        console.log('Profiles table may not exist yet');
      }

      // Render results
      renderSearchResults(results, query);
    }

    // Render search results
    function renderSearchResults(results, query) {
      const { communities, users, interests } = results;
      const totalResults = communities.length + users.length;

      if (totalResults === 0) {
        showNoResults(query);
        return;
      }

      let html = '';

      // Communities section
      if (communities.length > 0) {
        html += `<div class="search-category">üè† Communities</div>`;
        communities.forEach(community => {
          html += `
            <div class="search-result-item" onclick="viewCommunity('${community.id}')">
              <div class="search-result-icon">${community.icon || 'üè†'}</div>
              <div class="search-result-info">
                <div class="search-result-name">${escapeHtml(community.name)}</div>
                <div class="search-result-meta">${escapeHtml(community.description?.substring(0, 60) || '')}...</div>
              </div>
              <div class="search-result-badge">${community.member_count || 0} members</div>
            </div>
          `;
        });
      }

      // Users section
      if (users.length > 0) {
        html += `<div class="search-category">‚ú® People</div>`;
        users.forEach(user => {
          const avatar = user.avatar_emoji || 'üåô';
          html += `
            <div class="search-result-item" onclick="viewProfile('${user.id}')">
              <div class="search-result-icon" style="background: ${user.avatar_bg || 'var(--bg-elevated)'}">${avatar}</div>
              <div class="search-result-info">
                <div class="search-result-name">${escapeHtml(user.username || 'Anonymous')}</div>
                <div class="search-result-meta">${escapeHtml(user.bio?.substring(0, 50) || user.interests?.substring(0, 50) || 'Introvert')}</div>
              </div>
            </div>
          `;
        });
      }

      searchResults.innerHTML = html;
    }

    // Show no results message
    function showNoResults(query) {
      searchResults.innerHTML = `
        <div class="search-results-empty">
          <div class="icon">üîç</div>
          <p>No results found for "${escapeHtml(query)}"</p>
          <p style="font-size: 13px; margin-top: 8px;">Try different keywords or create a new community!</p>
        </div>
      `;
    }

    // Escape HTML for security
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // View community - open community detail modal
    async function viewCommunity(id) {
      searchResults.classList.remove('active');
      searchInput.value = '';

      if (!db) {
        showToast('Database not connected');
        return;
      }

      try {
        // Fetch community details
        const { data: community, error } = await db
          .from('communities')
          .select('*')
          .eq('id', id)
          .single();

        if (error || !community) {
          showToast('Community not found');
          return;
        }

        // Get member count
        const { count: memberCount } = await db
          .from('community_members')
          .select('*', { count: 'exact', head: true })
          .eq('community_id', id);

        // Check if user is a member
        let isJoined = false;
        if (currentUser) {
          const { data: membership } = await db
            .from('community_members')
            .select('id')
            .eq('community_id', id)
            .eq('user_id', currentUser.id)
            .single();
          isJoined = !!membership;
        }

        // Open community view modal
        openCommunityModal(community, memberCount || 0, isJoined);

      } catch (err) {
        console.error('View community error:', err);
        showToast('Error loading community');
      }
    }

    // Open community detail modal
    function openCommunityModal(community, memberCount, isJoined) {
      const memberText = memberCount === 1 ? '1 member' : `${memberCount} members`;

      // Create modal if it doesn't exist
      let modal = document.getElementById('communityViewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'communityViewModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
      }

      modal.innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
          <button class="close-btn" onclick="closeCommunityModal()">‚úï</button>
          <div class="modal-header">
            <div class="icon" style="font-size: 64px;">${community.icon || 'üè†'}</div>
            <h2>${escapeHtml(community.name)}</h2>
            <p style="font-size: 14px; color: var(--text-muted);">${memberText} ‚Ä¢ ${escapeHtml(community.category || 'General')}</p>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: 24px;">
              <p style="font-size: 15px; color: var(--text-secondary); line-height: 1.7;">
                ${escapeHtml(community.description || 'A space for introverts to connect.')}
              </p>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
              <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 24px; font-weight: 600;">${memberCount}</div>
                <div style="font-size: 13px; color: var(--text-muted);">Members</div>
              </div>
              <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 24px;">üí¨</div>
                <div style="font-size: 13px; color: var(--text-muted);">Async Chat</div>
              </div>
              <div style="flex: 1; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 24px;">üîí</div>
                <div style="font-size: 13px; color: var(--text-muted);">Safe Space</div>
              </div>
            </div>

            <button
              class="submit-btn ${isJoined ? 'joined' : ''}"
              id="communityJoinBtn"
              onclick="${isJoined ? `leaveCommunityFromModal('${community.id}')` : `joinCommunityFromModal('${community.id}')`}"
              style="${isJoined ? 'background: rgba(124,232,168,0.15); color: var(--accent-green);' : ''}"
            >
              ${isJoined ? '‚úì Joined - Click to Leave' : '‚ú® Join Community'}
            </button>
          </div>
        </div>
      `;

      modal.classList.add('active');
    }

    function closeCommunityModal() {
      const modal = document.getElementById('communityViewModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Join from modal
    async function joinCommunityFromModal(communityId) {
      if (!db || !currentUser) {
        showToast('‚ö†Ô∏è Please sign in to join');
        return;
      }

      try {
        const { error } = await db
          .from('community_members')
          .insert({
            user_id: currentUser.id,
            community_id: communityId
          });

        if (error && error.code !== '23505') {
          throw error;
        }

        const btn = document.getElementById('communityJoinBtn');
        btn.innerHTML = '‚úì Joined - Click to Leave';
        btn.style.background = 'rgba(124,232,168,0.15)';
        btn.style.color = 'var(--accent-green)';
        btn.onclick = () => leaveCommunityFromModal(communityId);

        showToast('üè† Welcome to the community!');
        loadCommunities(); // Refresh the grid

      } catch (err) {
        console.error('Join error:', err);
        showToast('‚ö†Ô∏è Error joining community');
      }
    }

    // Leave from modal
    async function leaveCommunityFromModal(communityId) {
      if (!db || !currentUser) return;

      try {
        const { error } = await db
          .from('community_members')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('community_id', communityId);

        if (error) throw error;

        const btn = document.getElementById('communityJoinBtn');
        btn.innerHTML = '‚ú® Join Community';
        btn.style.background = '';
        btn.style.color = '';
        btn.onclick = () => joinCommunityFromModal(communityId);

        showToast('üëã Left community');
        loadCommunities(); // Refresh the grid

      } catch (err) {
        console.error('Leave error:', err);
        showToast('‚ö†Ô∏è Error leaving community');
      }
    }

    // View profile - open profile modal with message option
    async function viewProfile(id) {
      searchResults.classList.remove('active');
      searchInput.value = '';

      if (!db) return;

      try {
        const { data: profile, error } = await db
          .from('profiles')
          .select('*')
          .eq('id', id)
          .single();

        if (error || !profile) {
          showToast('Profile not found');
          return;
        }

        openProfileModal(profile);
      } catch (err) {
        console.error('View profile error:', err);
        showToast('Error loading profile');
      }
    }

    function openProfileModal(profile) {
      let modal = document.getElementById('profileViewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'profileViewModal';
        modal.className = 'modal';
        modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });
        document.body.appendChild(modal);
      }

      const avatar = profile.avatar_emoji || profile.avatar || 'üåô';
      const avatarBg = profile.avatar_bg || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      const interests = profile.interests ? profile.interests.split(',').map(i => i.trim()).filter(Boolean) : [];

      modal.innerHTML = `
        <div class="modal-box" style="max-width: 480px;">
          <button class="close-btn" onclick="document.getElementById('profileViewModal').classList.remove('active')">‚úï</button>
          <div class="modal-header">
            <div class="profile-view-card">
              <div class="profile-view-avatar" style="background: ${avatarBg}">${avatar}</div>
              <div class="profile-view-name">${escapeHtml(profile.username || 'Anonymous')}</div>
              ${profile.tagline ? `<p style="font-size: 14px; color: var(--text-muted); font-style: italic; margin-bottom: 8px;">${escapeHtml(profile.tagline)}</p>` : ''}
            </div>
          </div>
          <div class="modal-body">
            ${profile.bio ? `<p class="profile-view-bio">${escapeHtml(profile.bio)}</p>` : ''}
            ${interests.length > 0 ? `
              <div class="profile-view-interests">
                ${interests.map(i => `<span class="interest">${escapeHtml(i)}</span>`).join('')}
              </div>
            ` : ''}
            <div class="profile-view-actions">
              <button class="submit-btn" onclick="document.getElementById('profileViewModal').classList.remove('active'); openConversation('${profile.id}', '${escapeHtml(profile.username || 'Anonymous')}', '${avatar}', '${avatarBg}')">
                üí¨ Send Message
              </button>
            </div>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }

    // ========== MESSAGING SYSTEM ==========
    let conversationsCache = [];
    let currentConvoUserId = null;
    let messagePollingInterval = null;

    // Load conversations list
    async function loadConversations() {
      if (!db || !currentUser) return;

      const container = document.querySelector('.conversations');
      if (!container) return;

      try {
        // Get all messages involving current user, ordered by most recent
        const { data: messages, error } = await db
          .from('messages')
          .select('*')
          .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Load messages error:', error);
          return;
        }

        if (!messages || messages.length === 0) {
          container.innerHTML = `
            <div class="messages-empty">
              <div class="icon">üí¨</div>
              <h3>No messages yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Search for users and start a conversation!</p>
            </div>
          `;
          return;
        }

        // Group by conversation partner
        const convos = {};
        messages.forEach(msg => {
          const partnerId = msg.sender_id === currentUser.id ? msg.recipient_id : msg.sender_id;
          if (!convos[partnerId]) {
            convos[partnerId] = {
              partnerId,
              lastMessage: msg,
              unreadCount: 0
            };
          }
          if (msg.recipient_id === currentUser.id && !msg.read) {
            convos[partnerId].unreadCount++;
          }
        });

        conversationsCache = Object.values(convos);

        // Load partner profiles
        const partnerIds = Object.keys(convos);
        const { data: profiles } = await db
          .from('profiles')
          .select('id, username, avatar, avatar_emoji, avatar_bg')
          .in('id', partnerIds);

        const profileMap = {};
        if (profiles) {
          profiles.forEach(p => { profileMap[p.id] = p; });
        }

        // Render conversations
        container.innerHTML = conversationsCache.map(convo => {
          const profile = profileMap[convo.partnerId] || {};
          const avatar = profile.avatar_emoji || profile.avatar || 'üåô';
          const avatarBg = profile.avatar_bg || 'var(--bg-elevated)';
          const name = profile.username || 'Anonymous';
          const preview = convo.lastMessage.content.length > 60
            ? convo.lastMessage.content.substring(0, 60) + '...'
            : convo.lastMessage.content;
          const time = formatMessageTime(convo.lastMessage.created_at);
          const isSent = convo.lastMessage.sender_id === currentUser.id;

          return `
            <div class="conversation ${convo.unreadCount > 0 ? 'unread' : ''}"
                 onclick="openConversation('${convo.partnerId}', '${escapeHtml(name)}', '${avatar}', '${avatarBg}')">
              <div class="convo-avatar" style="background: ${avatarBg}">${avatar}</div>
              <div class="convo-content">
                <div class="convo-header">
                  <span class="convo-name">${escapeHtml(name)}</span>
                  <span class="convo-time">${time}</span>
                </div>
                <div class="convo-preview">${isSent ? 'You: ' : ''}${escapeHtml(preview)}</div>
              </div>
              ${convo.unreadCount > 0 ? '<div class="unread-dot"></div>' : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load conversations exception:', err);
      }
    }

    // Open a conversation with a specific user
    async function openConversation(userId, userName, userAvatar, userAvatarBg) {
      if (!db || !currentUser) {
        showToast('Please sign in to send messages');
        return;
      }

      currentConvoUserId = userId;

      // Switch to messages tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.tab[data-tab="messages"]').classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-messages').classList.add('active');

      // Replace messages section with conversation view
      const section = document.querySelector('.messages-section');
      section.innerHTML = `
        <div class="convo-view-header">
          <button class="back-btn" onclick="closeConversation()">‚Üê</button>
          <div class="convo-view-avatar" style="background: ${userAvatarBg || 'var(--bg-elevated)'}">${userAvatar || 'üåô'}</div>
          <div class="convo-user-info">
            <div class="convo-user-name">${escapeHtml(userName)}</div>
            <div class="convo-user-status">Take your time responding</div>
          </div>
        </div>
        <div class="messages-list" id="messagesList">
          <div style="text-align: center; color: var(--text-muted); padding: 20px;">Loading...</div>
        </div>
        <div class="message-input-area">
          <input type="text" id="messageInput" placeholder="Write a message..." autocomplete="off"
                 onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
          <button class="send-btn" onclick="sendMessage()" title="Send">‚Üí</button>
        </div>
      `;

      // Load messages for this conversation
      await loadMessages(userId);

      // Mark messages as read
      markAsRead(userId);

      // Start polling for new messages
      startMessagePolling(userId, userName, userAvatar, userAvatarBg);

      // Focus the input
      setTimeout(() => document.getElementById('messageInput')?.focus(), 100);
    }

    // Load messages for a conversation
    async function loadMessages(partnerId) {
      if (!db || !currentUser) return;

      const container = document.getElementById('messagesList');
      if (!container) return;

      try {
        const { data: messages, error } = await db
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${currentUser.id},recipient_id.eq.${partnerId}),and(sender_id.eq.${partnerId},recipient_id.eq.${currentUser.id})`)
          .order('created_at', { ascending: true })
          .limit(100);

        if (error) {
          console.error('Load messages error:', error);
          container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px;">Error loading messages</div>';
          return;
        }

        if (!messages || messages.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; color: var(--text-muted); padding: 60px 20px;">
              <div style="font-size: 40px; margin-bottom: 12px;">üí¨</div>
              <p>Start the conversation! No pressure to be witty.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isSent = msg.sender_id === currentUser.id;
          const time = formatMessageTime(msg.created_at);
          return `
            <div class="message-bubble ${isSent ? 'sent' : 'received'}">
              <div>${escapeHtml(msg.content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

      } catch (err) {
        console.error('Load messages exception:', err);
      }
    }

    // Send a message
    async function sendMessage() {
      if (!db || !currentUser || !currentConvoUserId) return;

      const input = document.getElementById('messageInput');
      if (!input) return;

      const content = input.value.trim();
      if (!content) return;

      input.value = '';

      try {
        const { data, error } = await db
          .from('messages')
          .insert({
            sender_id: currentUser.id,
            recipient_id: currentConvoUserId,
            content: content
          })
          .select();

        if (error) {
          console.error('Send message error:', error);
          showToast('Error sending message');
          input.value = content; // Restore on failure
          return;
        }

        // Add message to the list immediately
        const container = document.getElementById('messagesList');
        if (container) {
          // Remove empty state if present
          const emptyState = container.querySelector('div[style*="text-align: center"]');
          if (emptyState && container.children.length === 1) container.innerHTML = '';

          const time = formatMessageTime(new Date().toISOString());
          container.insertAdjacentHTML('beforeend', `
            <div class="message-bubble sent">
              <div>${escapeHtml(content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `);
          container.scrollTop = container.scrollHeight;
        }

      } catch (err) {
        console.error('Send message exception:', err);
        showToast('Error sending message');
      }
    }

    // Mark messages from a partner as read
    async function markAsRead(partnerId) {
      if (!db || !currentUser) return;

      try {
        await db
          .from('messages')
          .update({ read: true })
          .eq('sender_id', partnerId)
          .eq('recipient_id', currentUser.id)
          .eq('read', false);

        // Update unread badge
        loadUnreadCount();
      } catch (err) {
        console.error('Mark as read error:', err);
      }
    }

    // Poll for new messages in active conversation
    function startMessagePolling(userId, userName, userAvatar, userAvatarBg) {
      stopMessagePolling();
      messagePollingInterval = setInterval(async () => {
        if (currentConvoUserId !== userId) return;
        await loadMessages(userId);
        markAsRead(userId);
      }, 8000); // Poll every 8 seconds
    }

    function stopMessagePolling() {
      if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
        messagePollingInterval = null;
      }
    }

    // Close conversation and return to list
    function closeConversation() {
      stopMessagePolling();
      currentConvoUserId = null;

      // Restore messages section HTML
      const section = document.querySelector('.messages-section');
      section.innerHTML = `
        <div class="async-banner">
          <div class="icon">üí¨</div>
          <div>
            <h4>Async-First Messaging</h4>
            <p>Take your time. No pressure to respond quickly ‚Äî we all understand.</p>
          </div>
        </div>
        <div class="async-badges">
          <div class="async-badge"><span>üëÅÔ∏è‚Äçüó®Ô∏è</span> No read receipts</div>
          <div class="async-badge"><span>‚å®Ô∏è</span> No typing indicators</div>
          <div class="async-badge"><span>üü¢</span> No online status</div>
        </div>
        <div class="conversations">
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading conversations...</div>
        </div>
      `;

      loadConversations();
    }

    // Format message timestamp
    function formatMessageTime(isoStr) {
      const date = new Date(isoStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return diffMins + 'm ago';
      if (diffHours < 24) return diffHours + 'h ago';
      if (diffDays < 7) return diffDays + 'd ago';
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        searchResults.classList.remove('active');
        this.blur();
      }
    });

    // Update DOMContentLoaded to also load conversations
    const origDOMContentLoaded = document.addEventListener;
    (async function() {
      // Wait for auth (already running from initAuth)
      await new Promise(resolve => {
        const check = setInterval(() => {
          if (currentUser || !db) { clearInterval(check); resolve(); }
        }, 100);
        // Timeout after 3 seconds
        setTimeout(() => { clearInterval(check); resolve(); }, 3000);
      });
      loadConversations();
    })();
  </script>

</body>
</html>

