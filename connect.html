<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Connect - Introvert Place</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0c10;
      --bg-surface: #12151c;
      --bg-elevated: #1a1e28;
      --bg-hover: #242a36;
      --accent-warm: #e8a87c;
      --accent-soft: #c4a1ff;
      --accent-calm: #7cb8e8;
      --accent-green: #7ce8a8;
      --accent-gold: #f0e87c;
      --accent-rose: #e87c9a;
      --text-primary: #f0eeeb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border-subtle: rgba(255,255,255,0.06);
      --border-light: rgba(255,255,255,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-full: 9999px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    h1, h2, h3, h4 { font-family: 'Fraunces', serif; font-weight: 400; }

    /* Layout */
    .app-container { display: flex; min-height: 100vh; }

    /* Main Content */
    .main-content {
      flex: 1;
      min-height: 100vh;
      position: relative;
    }

    .ambient-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(120px);
      animation: float 25s ease-in-out infinite;
    }

    .orb-1 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(196,161,255,0.2) 0%, transparent 70%);
      top: -200px;
      right: -100px;
    }

    .orb-2 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(124,232,168,0.15) 0%, transparent 70%);
      bottom: -150px;
      left: 20%;
      animation-direction: reverse;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, -30px) scale(1.05); }
    }

    .content-wrapper {
      position: relative;
      z-index: 1;
      padding: 36px 48px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Search */
    .search-section {
      max-width: 600px;
      margin: 0 auto 40px;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 18px 24px 18px 56px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 4px rgba(196,161,255,0.1);
    }

    .search-input::placeholder { color: var(--text-muted); }

    .search-icon {
      position: absolute;
      left: 22px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--text-muted);
    }

    .search-hints {
      text-align: center;
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .search-hints span { margin: 0 10px; }

    /* Search Results */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    .search-results.active { display: block; }
    .search-results-empty {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }
    .search-results-empty .icon { font-size: 32px; margin-bottom: 12px; }
    .search-category {
      padding: 12px 16px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .search-result-item:hover { background: var(--bg-elevated); }
    .search-result-item:last-child { border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
    .search-result-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-name { font-size: 15px; font-weight: 500; margin-bottom: 2px; }
    .search-result-meta { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result-badge {
      padding: 4px 10px;
      background: rgba(196,161,255,0.15);
      color: var(--accent-soft);
      border-radius: var(--radius-full);
      font-size: 11px;
      flex-shrink: 0;
    }
    .search-loading {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
    }
    .search-loading .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-soft);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* View Navigation */
    .view-nav {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 32px;
      padding: 6px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }

    .view-nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .view-nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }

    .view-nav-item.active {
      background: var(--accent-soft);
      color: var(--bg-deep);
    }

    .view-nav-item .nav-icon { font-size: 16px; }
    .view-nav-item .nav-label { white-space: nowrap; }

    .view-nav-badge {
      background: var(--accent-rose);
      color: #fff;
      padding: 1px 7px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      text-align: center;
    }

    .view-nav-item.active .view-nav-badge { background: rgba(0,0,0,0.25); }

    /* Page Views */
    .page-view { display: none; }
    .page-view.active { display: block; animation: viewFadeIn 0.35s ease; }

    @keyframes viewFadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Per-view headers */
    .view-header {
      text-align: center;
      margin-bottom: 28px;
    }
    .view-header h1 { font-size: 36px; font-weight: 300; margin-bottom: 8px; }
    .view-header .tagline { font-size: 16px; color: var(--text-secondary); }

    /* Communities */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .section-header h2 { font-size: 24px; }

    .create-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .create-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(196,161,255,0.3);
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter {
      padding: 8px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .filter.active { background: var(--bg-elevated); border-color: var(--accent-soft); color: var(--text-primary); }

    .communities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .community-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .community-card:hover {
      border-color: var(--accent-soft);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }

    .community-top {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .community-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .community-info { flex: 1; }
    .community-info h4 { font-size: 20px; margin-bottom: 6px; }

    .community-stats {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .community-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .community-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tag {
      padding: 4px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-muted);
    }

    .community-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .activity {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .join-btn {
      padding: 10px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .join-btn:hover {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    .join-btn.joined {
      background: rgba(124,232,168,0.15);
      border-color: rgba(124,232,168,0.3);
      color: var(--accent-green);
    }

    /* Find Souls */
    .souls-intro {
      text-align: center;
      padding: 40px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      margin-bottom: 32px;
    }

    .souls-intro .intro-icon { font-size: 56px; margin-bottom: 16px; }
    .souls-intro h3 { font-size: 26px; margin-bottom: 10px; }
    .souls-intro p { font-size: 16px; color: var(--text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.6; }

    .privacy-note {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 20px;
    }

    .souls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .soul-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 28px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .soul-card:hover {
      border-color: var(--accent-soft);
      transform: translateY(-4px);
    }

    .soul-avatar {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-lg);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    .soul-avatar img { width: 100%; height: 100%; border-radius: var(--radius-lg); object-fit: cover; }

    .soul-name { font-size: 18px; font-weight: 500; margin-bottom: 4px; }
    .soul-tagline { font-size: 14px; color: var(--text-muted); font-style: italic; margin-bottom: 16px; }

    .match-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(124,232,168,0.1);
      border: 1px solid rgba(124,232,168,0.2);
      border-radius: var(--radius-full);
      font-size: 13px;
      color: var(--accent-green);
      margin-bottom: 16px;
    }

    .interests {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .interest {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .wave-btn {
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .wave-btn:hover {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    .wave-btn.waved {
      background: rgba(196,161,255,0.15);
      border-color: rgba(196,161,255,0.3);
      color: var(--accent-soft);
      pointer-events: none;
    }

    /* Messages Section - Redesigned */
    .messages-section { max-width: 800px; margin: 0 auto; }

    .async-banner {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(124,232,168,0.08) 0%, rgba(196,161,255,0.08) 100%);
      border: 1px solid rgba(124,232,168,0.15);
      border-radius: var(--radius-xl);
      margin-bottom: 20px;
    }
    .async-banner .icon { font-size: 32px; }
    .async-banner h4 { font-size: 16px; margin-bottom: 4px; color: var(--text-primary); }
    .async-banner p { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }

    .async-badges {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .async-badge {
      padding: 8px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .async-badge span { font-size: 14px; }

    /* Conversations Search */
    .messages-search {
      position: relative;
      margin-bottom: 20px;
    }
    .messages-search input {
      width: 100%;
      padding: 14px 18px 14px 48px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }
    .messages-search input:focus {
      outline: none;
      border-color: var(--accent-soft);
      background: var(--bg-elevated);
    }
    .messages-search input::placeholder { color: var(--text-muted); }
    .messages-search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 16px;
      pointer-events: none;
    }

    /* Conversations List */
    .conversations { display: flex; flex-direction: column; gap: 8px; }
    
    .conversations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .conversations-header h3 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .conversations-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-elevated);
      padding: 4px 10px;
      border-radius: var(--radius-full);
    }

    .conversation {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background: var(--bg-surface);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .conversation:hover { 
      background: var(--bg-elevated); 
      border-color: var(--border-subtle);
      transform: translateX(4px);
    }
    .conversation.unread { 
      background: linear-gradient(135deg, rgba(196,161,255,0.05) 0%, transparent 100%);
      border-color: rgba(196,161,255,0.2);
    }
    .conversation.unread::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: var(--accent-soft);
      border-radius: 0 3px 3px 0;
    }

    .convo-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      position: relative;
    }
    .convo-avatar img { width: 100%; height: 100%; border-radius: var(--radius-md); object-fit: cover; }

    .convo-content { flex: 1; min-width: 0; }
    .convo-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 6px; 
    }
    .convo-name { 
      font-size: 15px; 
      font-weight: 500; 
      color: var(--text-primary);
    }
    .conversation.unread .convo-name { font-weight: 600; }
    .convo-time { 
      font-size: 11px; 
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .convo-preview { 
      font-size: 13px; 
      color: var(--text-secondary); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
      line-height: 1.4;
    }
    .conversation.unread .convo-preview { color: var(--text-primary); }

    .unread-badge {
      min-width: 20px;
      height: 20px;
      background: var(--accent-soft);
      border-radius: var(--radius-full);
      color: var(--bg-deep);
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      flex-shrink: 0;
    }

    /* Conversation View */
    .convo-view-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .convo-view-header .back-btn {
      width: 38px; height: 38px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .convo-view-header .back-btn:hover { 
      background: var(--bg-hover); 
      color: var(--text-primary);
      border-color: var(--accent-soft);
    }
    .convo-view-header .convo-user-info { flex: 1; }
    .convo-view-header .convo-user-name { font-size: 16px; font-weight: 500; }
    .convo-view-header .convo-user-status { 
      font-size: 12px; 
      color: var(--accent-green);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .convo-view-header .convo-user-status::before {
      content: 'ðŸŒ±';
      font-size: 10px;
    }
    .convo-view-avatar {
      width: 44px; height: 44px;
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0;
    }
    .convo-view-avatar img { width: 100%; height: 100%; border-radius: var(--radius-md); object-fit: cover; }
    .convo-view-options {
      width: 38px; height: 38px;
      background: transparent;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .convo-view-options:hover { background: var(--bg-elevated); color: var(--text-primary); }

    /* Messages List */
    .messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: 450px;
      min-height: 250px;
      background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-surface) 100%);
    }

    .message-date-divider {
      text-align: center;
      padding: 12px 0;
      position: relative;
    }
    .message-date-divider span {
      background: var(--bg-surface);
      padding: 6px 16px;
      font-size: 11px;
      color: var(--text-muted);
      border-radius: var(--radius-full);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .message-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .message-group.sent { align-items: flex-end; }
    .message-group.received { align-items: flex-start; }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      animation: messageSlide 0.2s ease-out;
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-bubble.sent {
      background: linear-gradient(135deg, rgba(196,161,255,0.25) 0%, rgba(196,161,255,0.15) 100%);
      border: 1px solid rgba(196,161,255,0.2);
      color: var(--text-primary);
      border-bottom-right-radius: 6px;
    }
    .message-bubble.received {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      border-bottom-left-radius: 6px;
    }
    .message-bubble.sent + .message-bubble.sent { border-top-right-radius: 6px; }
    .message-bubble.received + .message-bubble.received { border-top-left-radius: 6px; }

    .message-text { margin-bottom: 4px; }
    .message-time {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .message-bubble.sent .message-time { justify-content: flex-end; }

    /* Message Input Area */
    .message-input-area {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-surface);
      border-top: 1px solid var(--border-subtle);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      align-items: flex-end;
    }
    .message-input-wrapper {
      flex: 1;
      position: relative;
    }
    .message-input-area textarea {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      transition: all 0.2s;
    }
    .message-input-area textarea:focus {
      outline: none;
      border-color: var(--accent-soft);
      background: var(--bg-surface);
    }
    .message-input-area textarea::placeholder { color: var(--text-muted); }
    .message-input-area input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }
    .message-input-area input:focus {
      outline: none;
      border-color: var(--accent-soft);
      background: var(--bg-surface);
    }
    .message-input-area input::placeholder { color: var(--text-muted); }
    
    .send-btn {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, #a78bfa 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(196,161,255,0.3);
    }
    .send-btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 16px rgba(196,161,255,0.4);
    }
    .send-btn:active { transform: translateY(0); }
    .send-btn:disabled { 
      opacity: 0.4; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }

    /* Messages Empty State */
    .messages-empty {
      padding: 60px 24px;
      text-align: center;
    }
    .messages-empty .icon { 
      font-size: 56px; 
      margin-bottom: 20px;
      display: block;
    }
    .messages-empty h3 {
      font-family: 'Fraunces', serif;
      font-size: 22px;
      font-weight: 400;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    .messages-empty p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.5;
      max-width: 300px;
      margin: 0 auto;
    }
    .messages-empty-btn {
      margin-top: 24px;
      padding: 12px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .messages-empty-btn:hover {
      background: var(--accent-soft);
      color: var(--bg-deep);
      border-color: var(--accent-soft);
    }

    /* Profile View Modal */
    .profile-view-card {
      text-align: center;
      padding: 12px 0;
    }
    .profile-view-avatar {
      width: 80px; height: 80px;
      border-radius: var(--radius-lg);
      margin: 0 auto 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 40px;
    }
    .profile-view-avatar img { width: 100%; height: 100%; border-radius: var(--radius-lg); object-fit: cover; }
    .profile-view-name { font-size: 22px; font-weight: 500; margin-bottom: 4px; }
    .profile-view-bio { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
    .profile-view-interests { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .profile-view-actions { display: flex; gap: 12px; }
    .profile-view-actions button { flex: 1; }

    /* Modals */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(10,12,16,0.9);
      backdrop-filter: blur(12px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal.active { display: flex; }

    .modal-box {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 28px 28px 0;
      text-align: center;
    }

    .modal-header .icon { font-size: 48px; margin-bottom: 16px; }
    .modal-header h2 { font-size: 28px; margin-bottom: 8px; }
    .modal-header p { font-size: 15px; color: var(--text-secondary); }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

    .modal-body { padding: 28px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .form-group textarea { min-height: 100px; resize: vertical; line-height: 1.5; }

    .form-group select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      cursor: pointer;
    }

    .icon-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
      margin: -4px;
    }

    .icon-opt {
      width: 46px;
      height: 46px;
      background: var(--bg-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-md);
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-opt:hover { background: var(--bg-hover); }
    .icon-opt.selected { border-color: var(--accent-soft); background: rgba(196,161,255,0.1); }

    .type-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .type-option {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .type-option:hover { background: var(--bg-hover); }
    .type-option.selected,
    .type-option:has(input:checked) {
      border-color: var(--accent-soft);
      background: rgba(196,161,255,0.1);
    }
    .type-option input { display: none; }
    .type-icon { font-size: 24px; }
    .type-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .type-info strong {
      font-size: 14px;
      color: var(--text-primary);
    }
    .type-info small {
      font-size: 12px;
      color: var(--text-muted);
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(196,161,255,0.3);
    }

    /* Graceful Decline Modal */
    .battery-display {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .battery-mini {
      width: 60px;
      height: 30px;
      background: var(--bg-deep);
      border-radius: 6px;
      overflow: hidden;
    }

    .battery-mini .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-warm), var(--accent-gold));
    }

    .battery-display .text .pct { font-size: 24px; font-weight: 600; }
    .battery-display .text .status { font-size: 13px; color: var(--text-muted); }

    .tone-grid {
      display: flex;
      gap: 10px;
    }

    .tone-opt {
      flex: 1;
      padding: 14px;
      background: var(--bg-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .tone-opt:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tone-opt.active { border-color: var(--accent-rose); background: rgba(232,124,154,0.1); color: var(--text-primary); }
    .tone-opt .emoji { display: block; font-size: 24px; margin-bottom: 6px; }

    .generate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-rose) 0%, var(--accent-warm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 24px;
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(232,124,154,0.3);
    }

    .response-box {
      display: none;
      padding: 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--accent-green);
    }

    .response-box.show { display: block; animation: fadeIn 0.4s ease; }
    .response-box .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }
    .response-box .text { font-size: 16px; line-height: 1.7; margin-bottom: 20px; }

    .response-btns { display: flex; gap: 10px; }

    .resp-btn {
      flex: 1;
      padding: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .resp-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .resp-btn.primary { background: var(--accent-green); color: var(--bg-deep); border-color: var(--accent-green); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 28px;
      background: var(--accent-green);
      color: var(--bg-deep);
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Community View */
    .community-view {
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .community-view .modal-box {
      max-width: 750px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .community-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }

    .community-header-top {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .community-header-icon {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      flex-shrink: 0;
    }

    .community-header-info h2 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .community-header-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .community-header-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .community-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border-subtle);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .community-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: var(--radius-full);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .community-tab:hover {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .community-tab.active {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .community-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    /* Post Composer */
    .post-composer {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }

    .post-type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .post-type-btn {
      padding: 8px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .post-type-btn:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .post-type-btn.active {
      background: rgba(196,161,255,0.15);
      border-color: rgba(196,161,255,0.3);
      color: var(--accent-soft);
    }

    .post-composer-title {
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .post-composer-title:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .post-composer-title::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .post-composer-link {
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .post-composer-link:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .post-composer textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      line-height: 1.6;
    }

    .post-composer textarea:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .post-composer textarea::placeholder {
      color: var(--text-muted);
    }

    .post-composer-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .post-composer-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .post-btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, var(--accent-calm) 100%);
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .post-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(196,161,255,0.3);
    }

    .post-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Posts Feed */
    .posts-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .post-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: border-color 0.2s ease;
    }

    .post-card:hover {
      border-color: var(--border-light);
    }

    .post-card.pinned {
      border-color: rgba(240,232,124,0.3);
      background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(240,232,124,0.05) 100%);
    }

    .post-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .post-type-badge.thought { background: rgba(196,161,255,0.1); color: var(--accent-soft); }
    .post-type-badge.resource { background: rgba(124,184,232,0.1); color: var(--accent-calm); }
    .post-type-badge.creation { background: rgba(232,168,124,0.1); color: var(--accent-warm); }
    .post-type-badge.lesson { background: rgba(124,232,168,0.1); color: var(--accent-green); }
    .post-type-badge.question { background: rgba(240,232,124,0.1); color: var(--accent-gold); }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .post-avatar img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-md);
      object-fit: cover;
    }

    .post-author-info {
      flex: 1;
    }

    .post-author-name {
      font-size: 14px;
      font-weight: 500;
    }

    .post-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .post-pin-badge {
      font-size: 12px;
      color: var(--accent-gold);
    }

    .post-title {
      font-family: 'Fraunces', serif;
      font-size: 18px;
      font-weight: 400;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .post-content {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .post-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      margin-top: 12px;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .post-link:hover {
      border-color: var(--accent-calm);
      background: var(--bg-hover);
    }

    .post-link-icon {
      font-size: 20px;
    }

    .post-link-text {
      flex: 1;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .post-link-domain {
      font-size: 12px;
      color: var(--text-muted);
    }

    .post-image {
      margin-top: 12px;
      border-radius: var(--radius-md);
      max-width: 100%;
      max-height: 400px;
      object-fit: cover;
    }

    /* Post Actions */
    .post-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
      flex-wrap: wrap;
    }

    .reaction-btn {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .reaction-btn:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .reaction-btn.active {
      background: rgba(196,161,255,0.15);
      border-color: rgba(196,161,255,0.3);
      color: var(--accent-soft);
    }

    .reaction-btn .count {
      font-size: 12px;
      opacity: 0.8;
    }

    .action-spacer {
      flex: 1;
    }

    .bookmark-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bookmark-btn:hover {
      color: var(--accent-gold);
    }

    .bookmark-btn.active {
      color: var(--accent-gold);
    }

    .comment-toggle {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .comment-toggle:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    /* Comments Section */
    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .comment-composer {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .comment-composer input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
    }

    .comment-composer input:focus {
      outline: none;
      border-color: var(--accent-soft);
    }

    .comment-composer input::placeholder {
      color: var(--text-muted);
    }

    .comment-send-btn {
      width: 36px;
      height: 36px;
      background: var(--accent-soft);
      border: none;
      border-radius: 50%;
      color: var(--bg-deep);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .comment-send-btn:hover {
      transform: scale(1.05);
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .comment {
      display: flex;
      gap: 10px;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .comment-avatar img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-sm);
      object-fit: cover;
    }

    .comment-body {
      flex: 1;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: 10px 14px;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .comment-author {
      font-size: 13px;
      font-weight: 500;
    }

    .comment-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .comment-content {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .comments-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .posts-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .posts-empty .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .join-prompt {
      text-align: center;
      padding: 32px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
    }

    .join-prompt p {
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    /* Lurk mode indicator */
    .lurk-mode-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .content-wrapper { padding: 24px; }
      .view-header h1 { font-size: 32px; }
    }
    @media (max-width: 600px) {
      .content-wrapper { padding: 20px 16px; }
      .view-header h1 { font-size: 28px; }
      .view-nav-item .nav-label { display: none; }
      .view-nav-item { padding: 10px 16px; }
      .view-nav { max-width: 280px; }
      .tone-grid { flex-direction: column; }
    }
    @media (max-width: 380px) {
      .view-header h1 { font-size: 24px; }
    }

    /* ========== JOIN OVERLAY ========== */
    .join-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .join-overlay-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      padding: 32px 28px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .join-overlay-title {
      font-family: 'Fraunces', serif;
      font-size: 21px;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    .join-overlay-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 22px;
    }
    .comfort-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .comfort-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 16px;
      background: var(--bg-surface);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, background 0.2s;
      color: var(--text-primary);
      font-size: 14px;
      width: 100%;
    }
    .comfort-option:hover { background: var(--bg-hover); }
    .comfort-option.selected {
      border-color: var(--accent-soft);
      background: rgba(196,161,255,0.08);
    }
    .comfort-option .co-icon { font-size: 18px; flex-shrink: 0; }
    .comfort-option .co-label { font-weight: 600; line-height: 1.3; }
    .comfort-option .co-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .notif-section { margin-bottom: 22px; }
    .notif-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-align: left;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .notif-options { display: flex; gap: 8px; }
    .notif-option {
      flex: 1;
      padding: 9px 6px;
      background: var(--bg-surface);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .notif-option:hover { background: var(--bg-hover); }
    .notif-option.selected {
      border-color: var(--accent-calm);
      color: var(--accent-calm);
      background: rgba(124,184,232,0.08);
    }
    .join-overlay-actions { display: flex; flex-direction: column; gap: 8px; }
    .join-confirm-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent-soft);
      color: #1a1e28;
      border: none;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .join-confirm-btn:hover { opacity: 0.88; }
    .join-skip-link {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      padding: 4px;
      text-decoration: underline;
      font-family: 'DM Sans', sans-serif;
    }
    .join-skip-link:hover { color: var(--text-secondary); }

    /* ========== ANONYMOUS POSTING TOGGLE ========== */
    .anon-toggle-row {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }
    .anon-toggle-row input {
      cursor: pointer;
      accent-color: var(--accent-soft);
      width: 14px;
      height: 14px;
    }

    /* ========== REPORT BUTTON & DIALOG ========== */
    .post-report-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 15px;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
      line-height: 1;
      opacity: 0.5;
      transition: opacity 0.2s, color 0.2s;
    }
    .post-report-btn:hover { opacity: 1; color: var(--accent-rose); }
    .report-dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1200;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .report-dialog {
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      padding: 24px;
      max-width: 340px;
      width: 90%;
    }
    .report-dialog h3 {
      font-size: 16px;
      margin-bottom: 14px;
      font-family: 'Fraunces', serif;
      font-weight: 400;
    }
    .report-reason-options { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .report-reason-btn {
      padding: 10px 14px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      text-align: left;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s, border-color 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .report-reason-btn:hover { background: var(--bg-hover); border-color: var(--accent-rose); }
    .report-cancel-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      width: 100%;
      padding: 8px;
      font-family: 'DM Sans', sans-serif;
    }
    .report-cancel-btn:hover { color: var(--text-secondary); }
  </style>
</head>
<body>

  <div class="app-container">

    <!-- Main Content -->
    <main class="main-content">
      
      <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
      </div>

      <div class="content-wrapper">
        
        <!-- Secondary Navigation -->
        <nav class="view-nav">
          <button class="view-nav-item active" data-view="communities" onclick="switchView('communities')">
            <span class="nav-icon">ðŸ </span>
            <span class="nav-label">Communities</span>
          </button>
          <button class="view-nav-item" data-view="souls" onclick="switchView('souls')">
            <span class="nav-icon">âœ¨</span>
            <span class="nav-label">Find Souls</span>
          </button>
          <button class="view-nav-item" data-view="messages" onclick="switchView('messages')">
            <span class="nav-icon">ðŸ’¬</span>
            <span class="nav-label">Messages</span>
            <span class="view-nav-badge" id="messagesBadge" style="display: none;">0</span>
          </button>
        </nav>

        <!-- COMMUNITIES VIEW -->
        <div class="page-view active" id="view-communities">

          <div class="view-header">
            <h1>Communities</h1>
            <p class="tagline">Find your people. No small talk required.</p>
          </div>

          <!-- Search (communities only) -->
          <div class="search-section">
            <div class="search-box">
              <span class="search-icon">ðŸ”</span>
              <input type="text" class="search-input" id="communitiesSearchInput" placeholder="Search communities or interests..." autocomplete="off">
              <div class="search-results" id="communitiesSearchResults"></div>
            </div>
            <p class="search-hints">
              <span>ðŸ  communities</span>
              <span>ðŸ’­ interests</span>
            </p>
          </div>

          <div class="section-header">
            <h2>Discover Communities</h2>
            <button class="create-btn" onclick="openModal('createModal')">
              <span>âœ¨</span> Create Community
            </button>
          </div>

          <div class="filters">
            <button class="filter active">All</button>
            <button class="filter">Joined</button>
            <button class="filter">Reading</button>
            <button class="filter">Creative</button>
            <button class="filter">Wellness</button>
            <button class="filter">Night Owls</button>
          </div>

          <div class="communities-grid">
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">ðŸŒ¿</span>
              <h3 style="margin-top: 16px;">No communities yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Communities will appear here as the platform grows. Be one of the first to create a space!</p>
            </div>
          </div>
        </div>

        <!-- FIND SOULS VIEW -->
        <div class="page-view" id="view-souls">

          <div class="view-header">
            <h1>Find Souls</h1>
            <p class="tagline">Connect with people who share your energy.</p>
          </div>

          <div class="souls-intro">
            <div class="intro-icon">âœ¨</div>
            <h3>Find Similar Souls</h3>
            <p>Connect with people who share your interests and energy. No awkward intros â€” we show what you have in common.</p>
            <div class="privacy-note"><span>ðŸ”’</span> Your profile is only shown to compatible matches</div>
          </div>

          <div class="souls-grid" id="soulsGrid">
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">ðŸ”®</span>
              <h3 style="margin-top: 16px;">Loading souls...</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Finding compatible souls who share your interests.</p>
            </div>
          </div>
        </div>

        <!-- MESSAGES VIEW -->
        <div class="page-view" id="view-messages">

          <div class="view-header">
            <h1>Messages</h1>
          </div>

          <div class="messages-section">

            <div class="async-banner">
              <div class="icon">ðŸŒ™</div>
              <div>
                <h4>Async-First Messaging</h4>
                <p>Take your time responding. No pressure, no rush â€” we all understand the need for space.</p>
              </div>
            </div>

            <div class="async-badges">
              <div class="async-badge"><span>ðŸ‘ï¸</span> No read receipts</div>
              <div class="async-badge"><span>âŒ¨ï¸</span> No typing indicators</div>
              <div class="async-badge"><span>ðŸ”•</span> No online status</div>
            </div>

            <div class="messages-search">
              <span class="messages-search-icon">ðŸ”</span>
              <input type="text" placeholder="Search conversations..." id="conversationsSearch" autocomplete="off">
            </div>

            <div class="conversations-header">
              <h3>Conversations</h3>
              <span class="conversations-count" id="convosCount">0 chats</span>
            </div>

            <div class="conversations" id="conversationsList">
              <div class="messages-empty">
                <span class="icon">ðŸ’œ</span>
                <h3>Your quiet inbox</h3>
                <p>When you connect with similar souls, your conversations will appear here. No pressure to respond quickly.</p>
                <button class="messages-empty-btn" onclick="switchView('souls')">Find Similar Souls</button>
              </div>
            </div>

          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- CREATE COMMUNITY MODAL -->
  <div class="modal" id="createModal">
    <div class="modal-box">
      <button class="close-btn" onclick="closeModal('createModal')">âœ•</button>
      <div class="modal-header">
        <div class="icon">ðŸ </div>
        <h2>Create Community</h2>
        <p>Build a space for introverts who share your interests</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Community Name</label>
          <input type="text" placeholder="e.g., Rainy Day Writers">
        </div>
        <div class="form-group">
          <label>Choose an Icon</label>
          <div class="icon-grid">
            <!-- Nature & Calm -->
            <div class="icon-opt selected">ðŸŒ™</div>
            <div class="icon-opt">ðŸŒ¿</div>
            <div class="icon-opt">ðŸŒ§ï¸</div>
            <div class="icon-opt">ðŸŒ»</div>
            <div class="icon-opt">ðŸƒ</div>
            <div class="icon-opt">ðŸŒŠ</div>
            <div class="icon-opt">â›°ï¸</div>
            <!-- Creative -->
            <div class="icon-opt">ðŸŽ¨</div>
            <div class="icon-opt">âœï¸</div>
            <div class="icon-opt">ðŸ“·</div>
            <div class="icon-opt">ðŸŽ­</div>
            <div class="icon-opt">ðŸ§¶</div>
            <!-- Reading & Learning -->
            <div class="icon-opt">ðŸ“š</div>
            <div class="icon-opt">ðŸ“–</div>
            <div class="icon-opt">âœï¸</div>
            <div class="icon-opt">ðŸ”®</div>
            <!-- Music & Audio -->
            <div class="icon-opt">ðŸŽ§</div>
            <div class="icon-opt">ðŸŽµ</div>
            <div class="icon-opt">ðŸŽ¹</div>
            <div class="icon-opt">ðŸŽ¸</div>
            <!-- Wellness -->
            <div class="icon-opt">ðŸ§˜</div>
            <div class="icon-opt">ðŸ’†</div>
            <div class="icon-opt">ðŸ›</div>
            <div class="icon-opt">ðŸŒ¸</div>
            <!-- Cozy & Home -->
            <div class="icon-opt">â˜•</div>
            <div class="icon-opt">ðŸµ</div>
            <div class="icon-opt">ðŸ </div>
            <div class="icon-opt">ðŸ•¯ï¸</div>
            <div class="icon-opt">ðŸ§¸</div>
            <!-- Hobbies -->
            <div class="icon-opt">ðŸŽ®</div>
            <div class="icon-opt">ðŸŽ²</div>
            <div class="icon-opt">ðŸ§©</div>
            <div class="icon-opt">ðŸŒ±</div>
            <!-- Pets & Animals -->
            <div class="icon-opt">ðŸ±</div>
            <div class="icon-opt">ðŸ¶</div>
            <div class="icon-opt">ðŸ°</div>
            <div class="icon-opt">ðŸ¦‹</div>
            <!-- Thoughts & Feelings -->
            <div class="icon-opt">ðŸ’­</div>
            <div class="icon-opt">âœ¨</div>
            <div class="icon-opt">ðŸ’œ</div>
            <div class="icon-opt">ðŸŒˆ</div>
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea placeholder="What's this community about?"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select>
            <option value="">Select a category...</option>
            <optgroup label="Creative">
              <option>Art & Design</option>
              <option>Writing & Poetry</option>
              <option>Photography</option>
              <option>Crafts & DIY</option>
              <option>Music</option>
            </optgroup>
            <optgroup label="Lifestyle">
              <option>Reading & Books</option>
              <option>Gaming</option>
              <option>Cozy Hobbies</option>
              <option>Gardening & Plants</option>
              <option>Cooking & Baking</option>
              <option>Pet Parents</option>
            </optgroup>
            <optgroup label="Wellness">
              <option>Mental Health</option>
              <option>Meditation & Mindfulness</option>
              <option>Self-Care</option>
              <option>Social Anxiety</option>
              <option>Quiet Fitness</option>
            </optgroup>
            <optgroup label="Community">
              <option>Night Owls</option>
              <option>Deep Conversations</option>
              <option>Introvert Life</option>
              <option>Work & Career</option>
              <option>Relationships</option>
              <option>Solo Travel</option>
            </optgroup>
            <optgroup label="Learning">
              <option>Science & Nature</option>
              <option>Philosophy</option>
              <option>Languages</option>
              <option>Tech & Coding</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label>Community Type</label>
          <div class="type-options">
            <label class="type-option selected">
              <input type="radio" name="communityType" value="public" checked>
              <span class="type-icon">ðŸŒ</span>
              <span class="type-info">
                <strong>Public</strong>
                <small>Anyone can join and see posts</small>
              </span>
            </label>
            <label class="type-option">
              <input type="radio" name="communityType" value="private">
              <span class="type-icon">ðŸ”’</span>
              <span class="type-info">
                <strong>Private</strong>
                <small>Approval required to join</small>
              </span>
            </label>
          </div>
        </div>
        <button class="submit-btn" onclick="createCommunity()">âœ¨ Create Community</button>
      </div>
    </div>
  </div>

  <!-- GRACEFUL DECLINE MODAL -->
  <div class="modal" id="declineModal">
    <div class="modal-box">
      <button class="close-btn" onclick="closeModal('declineModal')">âœ•</button>
      <div class="modal-header">
        <div class="icon">ðŸ›¡ï¸</div>
        <h2>Graceful Decline</h2>
        <p>Need help saying no? We've got you.</p>
      </div>
      <div class="modal-body">
        <div class="battery-display">
          <div class="battery-mini"><div class="fill" style="width: 35%"></div></div>
          <div class="text">
            <div class="pct">35%</div>
            <div class="status">Social battery running low</div>
          </div>
        </div>

        <div class="form-group">
          <label>What's the situation?</label>
          <select id="situation">
            <option value="party">Friend invited me to a party</option>
            <option value="hangout">Coworker wants to hang out</option>
            <option value="family">Family gathering</option>
            <option value="videocall">Group video call</option>
            <option value="lastminute">Last-minute plans</option>
          </select>
        </div>

        <div class="form-group">
          <label>What tone feels right?</label>
          <div class="tone-grid">
            <div class="tone-opt active" data-tone="warm"><span class="emoji">ðŸ’›</span>Warm</div>
            <div class="tone-opt" data-tone="professional"><span class="emoji">ðŸ’¼</span>Professional</div>
            <div class="tone-opt" data-tone="honest"><span class="emoji">ðŸ’™</span>Honest</div>
          </div>
        </div>

        <button class="generate-btn" onclick="generateDecline()">âœ¨ Generate Response</button>

        <div class="response-box" id="responseBox">
          <div class="label">Your graceful decline:</div>
          <p class="text" id="responseText"></p>
          <div class="response-btns">
            <button class="resp-btn primary" onclick="copyResponse()"><span>ðŸ“‹</span> Copy</button>
            <button class="resp-btn" onclick="generateDecline()"><span>ðŸ”„</span> Regenerate</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // Supabase initialization
    const SUPABASE_URL = 'https://dlgntsscabbhdqlxqpwd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsZ250c3NjYWJiaGRxbHhxcHdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDAyMzYsImV4cCI6MjA3MDI3NjIzNn0.FIyWgqehDBMMQCN3nl-dPfkDAPjv_-dFBvmGHgABEBA';

    let db = null;
    let currentUser = null;

    try {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
      console.error('Supabase init error:', err);
    }

    // Auth check
    async function initAuth() {
      if (!db) return;
      try {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
          currentUser = session.user;
        }
      } catch (err) {
        console.error('Auth error:', err);
      }
    }

    // Listen for auth state changes (token refresh, sign-in/out)
    if (db) {
      db.auth.onAuthStateChange((event, session) => {
        if (session) {
          currentUser = session.user;
        } else {
          currentUser = null;
        }
      });
    }

  </script>

  <script>
    // View switching (URL-param driven)
    let soulsLoaded = false;
    let conversationsLoaded = false;

    function switchView(viewName) {
      // Update secondary nav
      document.querySelectorAll('.view-nav-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`.view-nav-item[data-view="${viewName}"]`)?.classList.add('active');

      // Switch views
      document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + viewName)?.classList.add('active');

      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('view', viewName);
      history.replaceState(null, '', url);

      // Lazy-load data on first visit
      if (viewName === 'souls' && !soulsLoaded) {
        soulsLoaded = true;
        loadSouls();
      }
      if (viewName === 'messages' && !conversationsLoaded) {
        conversationsLoaded = true;
        loadConversations();
      }

      // Stop message polling when leaving messages
      if (viewName !== 'messages') stopMessagePolling();
    }

    // Filters
    document.querySelectorAll('.filter').forEach(f => {
      f.addEventListener('click', function() {
        document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Join buttons
    document.querySelectorAll('.join-btn:not(.joined)').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        this.classList.add('joined');
        this.textContent = 'âœ“ Joined';
        showToast('ðŸ  Welcome to the community!');
      });
    });

    // Icon selector
    document.querySelectorAll('.icon-opt').forEach(icon => {
      icon.addEventListener('click', function() {
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
      });
    });

    // Tone selector
    document.querySelectorAll('.tone-opt').forEach(tone => {
      tone.addEventListener('click', function() {
        document.querySelectorAll('.tone-opt').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Modals
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
      });
    });

    // Also handle dynamically created modals
    document.addEventListener('click', function(e) {
      if (e.target.id === 'communityViewModal') {
        e.target.classList.remove('active');
      }
    });

    // Wave button
    async function sendWave(btn) {
      const recipientId = btn.dataset.userId;
      btn.classList.add('waved');
      btn.innerHTML = '<span>âœ“</span> Wave sent!';
      showToast('ðŸ‘‹ Quiet wave sent!');
      if (!db || !currentUser || !recipientId) return;
      try {
        await db.from('messages').insert({
          sender_id: currentUser.id,
          recipient_id: recipientId,
          content: 'ðŸ‘‹ *quiet wave*'
        });
      } catch (err) {
        console.error('Wave send error:', err);
      }
    }

    // Type option click handler
    document.querySelectorAll('.type-option').forEach(opt => {
      opt.addEventListener('click', function() {
        document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input').checked = true;
      });
    });

    // Create community
    async function createCommunity() {
      // Get form values
      const nameInput = document.querySelector('#createModal .form-group input[type="text"]');
      const descTextarea = document.querySelector('#createModal .form-group textarea');
      const categorySelect = document.querySelector('#createModal .form-group select');
      const selectedIcon = document.querySelector('#createModal .icon-opt.selected');
      const selectedType = document.querySelector('#createModal input[name="communityType"]:checked');

      const name = nameInput?.value?.trim();
      const description = descTextarea?.value?.trim();
      const category = categorySelect?.value;
      const icon = selectedIcon?.textContent || 'ðŸŒ™';
      const isPrivate = selectedType?.value === 'private';

      // Validate
      if (!name) {
        showToast('âš ï¸ Please enter a community name');
        return;
      }

      if (!category) {
        showToast('âš ï¸ Please select a category');
        return;
      }

      if (!db) {
        showToast('âš ï¸ Database not connected');
        return;
      }

      try {
        // Insert into Supabase
        const { data, error } = await db
          .from('communities')
          .insert([{
            name: name,
            description: description || '',
            category: category,
            icon: icon,
            is_private: isPrivate,
            creator_id: currentUser?.id || null,
            member_count: 1,
            created_at: new Date().toISOString()
          }])
          .select();

        if (error) {
          console.error('Create community error:', error);
          showToast('âš ï¸ Error: ' + (error.message || 'Could not create community'));
          return;
        }

        // Success - close modal and refresh
        closeModal('createModal');
        showToast('âœ¨ Community created!');

        // Set up the new community (add creator as owner, create rooms, welcome post)
        if (data && data[0] && currentUser) {
          const newId = data[0].id;
          const communityName = data[0].name || name;

          // Add creator as owner member
          await db.from('community_members').insert({
            user_id: currentUser.id,
            community_id: newId,
            role: 'owner',
            comfort_mode: 'active',
            notification_level: 'important'
          }).catch(() => {
            // Fallback if new columns don't exist yet
            db.from('community_members').insert({ user_id: currentUser.id, community_id: newId }).catch(() => {});
          });

          // Create default rooms + welcome post
          try {
            const { data: roomsData } = await db.from('community_rooms').insert([
              { community_id: newId, name: 'ðŸ“Œ Start Here', type: 'start_here', description: 'Welcome, rules & community vibe', position_order: 0, is_read_only: true },
              { community_id: newId, name: 'ðŸ’¬ Threads', type: 'threads', description: 'Long-form async discussions', position_order: 1, is_read_only: false },
              { community_id: newId, name: 'ðŸŒ± Prompts', type: 'prompts', description: 'Weekly guided conversation starters', position_order: 2, is_read_only: false },
              { community_id: newId, name: 'ðŸ“š Resources', type: 'resources', description: 'Saved links and helpful finds', position_order: 3, is_read_only: false }
            ]).select();

            // Auto-generate welcome post in Start Here room
            const startHereRoom = roomsData?.find(r => r.type === 'start_here');
            await db.from('community_posts').insert({
              community_id: newId,
              room_id: startHereRoom?.id || null,
              author_id: currentUser.id,
              post_type: 'thought',
              title: `Welcome to ${communityName} ðŸŒ™`,
              content: `This is a quiet space made for thoughtful connection.\n\nâœ¦ Take your time â€” no pressure to respond quickly\nâœ¦ All participation styles welcome: lurking, reacting, occasional replies, or active discussion\nâœ¦ Be kind and assume good intent\nâœ¦ Share what feels comfortable â€” small or large\n\nWe're glad you're here. âœ¨`,
              is_pinned: true
            });
          } catch (roomErr) {
            // community_rooms table may not exist yet â€” that's ok
            console.log('Could not create default rooms:', roomErr.message);
          }
        }

        // Clear form
        if (nameInput) nameInput.value = '';
        if (descTextarea) descTextarea.value = '';
        if (categorySelect) categorySelect.selectedIndex = 0;
        // Reset type to public
        const publicOption = document.querySelector('#createModal .type-option:first-child');
        if (publicOption) {
          document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
          publicOption.classList.add('selected');
          publicOption.querySelector('input').checked = true;
        }

        // Reload communities
        loadCommunities();

      } catch (err) {
        console.error('Create community exception:', err);
        showToast('âš ï¸ Error creating community');
      }
    }

    // Load communities from database
    async function loadCommunities() {
      if (!db) return;

      const grid = document.querySelector('.communities-grid');
      if (!grid) return;

      try {
        // Fetch communities
        const { data: communities, error } = await db
          .from('communities')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Load communities error:', error);
          return;
        }

        if (!communities || communities.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">ðŸŒ¿</span>
              <h3 style="margin-top: 16px;">No communities yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Communities will appear here as the platform grows. Be one of the first to create a space!</p>
            </div>
          `;
          return;
        }

        // Get actual member counts from community_members table
        const memberCounts = {};
        const userMemberships = new Set();

        try {
          // Get counts for all communities
          const { data: countData } = await db
            .from('community_members')
            .select('community_id');

          if (countData) {
            countData.forEach(row => {
              memberCounts[row.community_id] = (memberCounts[row.community_id] || 0) + 1;
            });
          }

          // Check which communities current user has joined
          if (currentUser) {
            const { data: userJoined } = await db
              .from('community_members')
              .select('community_id')
              .eq('user_id', currentUser.id);

            if (userJoined) {
              userJoined.forEach(row => userMemberships.add(row.community_id));
            }
          }
        } catch (countErr) {
          console.log('Could not load member counts:', countErr);
        }

        // Populate community names lookup for join overlay
        communities.forEach(c => { communityNames[c.id] = c.name; });

        // Render communities with actual member counts
        grid.innerHTML = communities.map(c => {
          const actualMemberCount = memberCounts[c.id] || 0;
          const isJoined = userMemberships.has(c.id);
          const memberText = actualMemberCount === 1 ? '1 member' : `${actualMemberCount} members`;

          return `
            <div class="community-card" onclick="viewCommunity('${c.id}')">
              <div class="community-top">
                <div class="community-icon">${c.icon || 'ðŸ '}</div>
                <div class="community-info">
                  <h4>${escapeHtml(c.name)}</h4>
                  <div class="community-stats">
                    <span>${memberText}</span>
                  </div>
                </div>
              </div>
              <p class="community-desc">${escapeHtml(c.description || '')}</p>
              <div class="community-tags">
                <span class="tag">${escapeHtml(c.category || 'General')}</span>
              </div>
              <div class="community-footer">
                <div class="activity">
                  <span class="activity-dot"></span>
                  <span>Active</span>
                </div>
                <button class="join-btn ${isJoined ? 'joined' : ''}" onclick="event.stopPropagation(); ${isJoined ? `leaveCommunity('${c.id}', this)` : `showJoinOverlay('${c.id}', false, this)`}">${isJoined ? 'âœ“ Joined' : 'Join'}</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load communities exception:', err);
      }
    }

    // Join a community â€” now routes through the join overlay
    async function joinCommunity(communityId, btn) {
      showJoinOverlay(communityId, false, btn);
    }

    // Direct insert for internal use (called by confirmJoin)
    async function _insertMembership(communityId, comfortMode, notifLevel) {
      const { error } = await db
        .from('community_members')
        .insert({
          user_id: currentUser.id,
          community_id: communityId,
          comfort_mode: comfortMode,
          notification_level: notifLevel
        });

      if (!error || error.code === '23505') return; // success or already a member

      // Migration not yet applied â€” fall back to basic insert without new columns
      if (error.code === 'PGRST204' || error.message?.includes('comfort_mode') || error.message?.includes('notification_level')) {
        const { error: fallbackErr } = await db
          .from('community_members')
          .insert({ user_id: currentUser.id, community_id: communityId });
        if (fallbackErr && fallbackErr.code !== '23505') throw fallbackErr;
        return;
      }

      throw error;
    }

    // Leave a community
    async function leaveCommunity(communityId, btn) {
      if (!db || !currentUser) return;

      try {
        const { error } = await db
          .from('community_members')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('community_id', communityId);

        if (error) throw error;

        btn.classList.remove('joined');
        btn.textContent = 'Join';
        btn.onclick = function(e) { e.stopPropagation(); joinCommunity(communityId, btn); };
        showToast('ðŸ‘‹ Left community');

        // Reload to update member counts
        setTimeout(() => loadCommunities(), 500);

      } catch (err) {
        console.error('Leave community error:', err);
      }
    }

    // Load unread message count
    async function loadUnreadCount() {
      const badge = document.getElementById('messagesBadge');
      if (!badge) return;

      if (!db || !currentUser) {
        badge.style.display = 'none';
        return;
      }

      try {
        const { count, error } = await db
          .from('messages')
          .select('*', { count: 'exact', head: true })
          .eq('recipient_id', currentUser.id)
          .eq('read', false);

        if (error) {
          console.error('Load unread count error:', error);
          badge.style.display = 'none';
          return;
        }

        if (count && count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        console.error('Load unread count exception:', err);
        badge.style.display = 'none';
      }
    }

    // Ensure communities table exists (creates if needed)
    async function ensureCommunitiesTable() {
      if (!db) return;

      try {
        // Try to query the table - if it fails, we'll create it
        const { error } = await db.from('communities').select('id').limit(1);

        if (error && error.message.includes('does not exist')) {
          console.log('Communities table does not exist. Please create it in Supabase dashboard with:');
          console.log(`
CREATE TABLE communities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT DEFAULT 'General',
  icon TEXT DEFAULT 'ðŸ ',
  creator_id UUID REFERENCES auth.users(id),
  member_count INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE communities ENABLE ROW LEVEL SECURITY;

-- Allow anyone to read communities
CREATE POLICY "Anyone can view communities" ON communities
  FOR SELECT USING (true);

-- Allow authenticated users to create communities
CREATE POLICY "Authenticated users can create communities" ON communities
  FOR INSERT WITH CHECK (true);
          `);
          showToast('âš ï¸ Database table needs setup - check console');
        }
      } catch (err) {
        console.error('Table check error:', err);
      }
    }

    // Load souls (all users from profiles)
    async function loadSouls() {
      if (!db) return;

      const grid = document.getElementById('soulsGrid');
      if (!grid) return;

      try {
        const { data: profiles, error } = await db
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(20);

        if (error) {
          console.error('Load souls error:', error);
          return;
        }

        if (!profiles || profiles.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: 1/-1; padding: 60px 24px; text-align: center;">
              <span style="font-size: 48px;">ðŸ”®</span>
              <h3 style="margin-top: 16px;">No souls yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Be one of the first to complete your profile and connect with others!</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = profiles.map(profile => {
          const avatar = profile.avatar_emoji || profile.avatar || 'ðŸŒ™';
          const avatarBg = profile.avatar_bg || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          const interests = profile.interests ? profile.interests.split(',').map(i => i.trim()).filter(Boolean).slice(0, 3) : [];
          const isMe = currentUser && profile.id === currentUser.id;

          return `
            <div class="soul-card" onclick="viewProfile('${profile.id}')">
              ${renderAvatarHtml(profile.avatar_url, avatar, avatarBg, 'soul-avatar')}
              <div class="soul-name">${escapeHtml(profile.username || 'Anonymous')}${isMe ? ' (You)' : ''}</div>
              <div class="soul-tagline">${escapeHtml(profile.tagline || profile.bio?.substring(0, 50) || 'A quiet soul')}</div>
              ${interests.length > 0 ? `
                <div class="interests">
                  ${interests.map(i => `<span class="interest">${escapeHtml(i)}</span>`).join('')}
                </div>
              ` : ''}
              ${!isMe ? `<button class="wave-btn" data-user-id="${profile.id}" onclick="event.stopPropagation(); sendWave(this)">ðŸ‘‹ Send a quiet wave</button>` : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load souls exception:', err);
      }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initAuth();
      await ensureCommunitiesTable();

      // Always load communities eagerly + unread count for badge
      loadCommunities();
      loadUnreadCount();

      // Read URL params to determine initial view
      const urlParams = new URLSearchParams(window.location.search);
      const initialView = urlParams.get('view') || 'communities';
      const conversationParam = urlParams.get('conversation');
      const communityId = urlParams.get('community');

      // Switch to the requested view
      switchView(initialView);

      // Deep-link: open a specific community
      if (communityId) {
        switchView('communities');
        setTimeout(() => viewCommunity(communityId), 500);
      }

      // Deep-link: open a specific conversation
      if (conversationParam) {
        switchView('messages');
        // Wait for conversations to load, then try to open
        setTimeout(() => {
          const profile = conversationProfiles[conversationParam];
          if (profile) {
            openConversation(conversationParam, profile.name, profile.avatar, profile.avatarBg, profile.avatarUrl);
          }
        }, 1000);
      }

      // Restore conversation from sessionStorage if returning to messages
      if (initialView === 'messages') {
        const savedConvo = sessionStorage.getItem('activeConversation');
        if (savedConvo) {
          try {
            const convo = JSON.parse(savedConvo);
            setTimeout(() => openConversation(convo.userId, convo.userName, convo.userAvatar, convo.userAvatarBg, convo.userAvatarUrl), 1000);
          } catch (e) { /* ignore invalid data */ }
        }
      }
    });

    // Graceful decline responses
    const responses = {
      party: {
        warm: "Thank you so much for thinking of me! I'm going to sit this one out â€” I need some quiet time to recharge. Have an amazing time! ðŸ’›",
        professional: "Thank you for the invitation. Unfortunately, I have a prior commitment. I hope the event goes well!",
        honest: "I'd love to see you, but my social battery is completely drained. I need some alone time. Can we reschedule?"
      },
      hangout: {
        warm: "That's so nice of you! I'm pretty wiped today and need to decompress solo. Let's definitely do it another time! ðŸ’›",
        professional: "Thanks for the offer! I have personal commitments this evening, but let's plan something else.",
        honest: "I appreciate you asking, but I need to recharge after work. Nothing personal â€” just hit my limit today!"
      },
      family: {
        warm: "Thank you for including me! I need some quiet time this weekend. Send my love to everyone! ðŸ’›",
        professional: "Thank you for the invitation. I won't be able to attend this time. I hope everyone has a lovely gathering.",
        honest: "I love you all, but I really need this weekend to recharge. My social battery is empty. Next time!"
      },
      videocall: {
        warm: "Thanks for including me! Video calls drain me, so I'll sit this one out. Fill me in later! ðŸ’›",
        professional: "I have a scheduling conflict and can't join. Please send me any notes afterward.",
        honest: "I'm at my limit with video calls. Need a break from screens. Can someone fill me in after?"
      },
      lastminute: {
        warm: "That sounds fun! I'm already in decompress mode though. Have an amazing time! ðŸ’›",
        professional: "Thank you for thinking of me. I already have plans this evening.",
        honest: "Last-minute plans stress me out â€” I need time to mentally prepare. Rain check?"
      }
    };

    function generateDecline() {
      const situation = document.getElementById('situation').value;
      const tone = document.querySelector('.tone-opt.active').dataset.tone;
      const text = responses[situation][tone];
      
      document.getElementById('responseText').textContent = text;
      document.getElementById('responseBox').classList.add('show');
    }

    function copyResponse() {
      const text = document.getElementById('responseText').textContent;
      navigator.clipboard.writeText(text);
      showToast('ðŸ“‹ Copied to clipboard!');
    }

    // Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ========== SEARCH FUNCTIONALITY (Communities only) ==========
    const communitiesSearchInput = document.getElementById('communitiesSearchInput');
    const communitiesSearchResults = document.getElementById('communitiesSearchResults');
    let searchTimeout = null;

    // Debounced search
    communitiesSearchInput.addEventListener('input', function() {
      const query = this.value.trim();

      // Clear previous timeout
      clearTimeout(searchTimeout);

      // Hide results if query is empty
      if (!query) {
        communitiesSearchResults.classList.remove('active');
        return;
      }

      // Show loading state
      communitiesSearchResults.innerHTML = `
        <div class="search-loading">
          <span class="spinner"></span>Searching...
        </div>
      `;
      communitiesSearchResults.classList.add('active');

      // Debounce search (300ms delay)
      searchTimeout = setTimeout(() => performSearch(query), 300);
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-box')) {
        communitiesSearchResults.classList.remove('active');
      }
    });

    // Focus search on input click
    communitiesSearchInput.addEventListener('focus', function() {
      if (this.value.trim()) {
        communitiesSearchResults.classList.add('active');
      }
    });

    // Perform search (communities only)
    async function performSearch(query) {
      if (!db) {
        showNoResults(query);
        return;
      }

      let communities = [];

      try {
        const { data } = await db
          .from('communities')
          .select('*')
          .or(`name.ilike.%${query}%,description.ilike.%${query}%`)
          .limit(8);

        if (data) {
          communities = data;
        }
      } catch (err) {
        console.log('Communities table may not exist yet');
      }

      // Render results
      renderSearchResults(communities, query);
    }

    // Render search results
    function renderSearchResults(communities, query) {
      if (communities.length === 0) {
        showNoResults(query);
        return;
      }

      let html = `<div class="search-category">ðŸ  Communities</div>`;
      communities.forEach(community => {
        html += `
          <div class="search-result-item" onclick="viewCommunity('${community.id}')">
            <div class="search-result-icon">${community.icon || 'ðŸ '}</div>
            <div class="search-result-info">
              <div class="search-result-name">${escapeHtml(community.name)}</div>
              <div class="search-result-meta">${escapeHtml(community.description?.substring(0, 60) || '')}...</div>
            </div>
            <div class="search-result-badge">${community.member_count || 0} members</div>
          </div>
        `;
      });

      communitiesSearchResults.innerHTML = html;
    }

    // Show no results message
    function showNoResults(query) {
      communitiesSearchResults.innerHTML = `
        <div class="search-results-empty">
          <div class="icon">ðŸ”</div>
          <p>No results found for "${escapeHtml(query)}"</p>
          <p style="font-size: 13px; margin-top: 8px;">Try different keywords or create a new community!</p>
        </div>
      `;
    }

    // Escape HTML for security
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // View community - open community detail modal
    async function viewCommunity(id) {
      communitiesSearchResults.classList.remove('active');
      communitiesSearchInput.value = '';

      if (!db) {
        showToast('Database not connected');
        return;
      }

      try {
        // Fetch community details
        const { data: community, error } = await db
          .from('communities')
          .select('*')
          .eq('id', id)
          .single();

        if (error || !community) {
          showToast('Community not found');
          return;
        }

        // Get member count
        const { count: memberCount } = await db
          .from('community_members')
          .select('*', { count: 'exact', head: true })
          .eq('community_id', id);

        // Check if user is a member
        let isJoined = false;
        if (currentUser) {
          const { data: membership } = await db
            .from('community_members')
            .select('id')
            .eq('community_id', id)
            .eq('user_id', currentUser.id)
            .single();
          isJoined = !!membership;
        }

        // Open community view modal
        openCommunityModal(community, memberCount || 0, isJoined);

      } catch (err) {
        console.error('View community error:', err);
        showToast('Error loading community');
      }
    }

    // Store current community for posting
    let currentCommunity = null;
    let currentCommunityJoined = false;
    let currentPostType = 'thought';
    let currentFilter = 'all';
    let userReactions = {}; // { postId: ['appreciate', ...] }
    let userBookmarks = new Set();
    let expandedComments = new Set();
    let communityNames = {}; // { communityId: name } for join overlay

    // Post type config
    const POST_TYPES = {
      thought: { icon: 'ðŸ’­', label: 'Thought', placeholder: 'Share a reflection, idea, or feeling...' },
      resource: { icon: 'ðŸ“š', label: 'Resource', placeholder: 'Share what you learned or found helpful...' },
      creation: { icon: 'âœ¨', label: 'Creation', placeholder: 'Share your art, writing, or creative work...' },
      lesson: { icon: 'ðŸŽ“', label: 'Lesson', placeholder: 'Teach something you know...' },
      question: { icon: 'â“', label: 'Question', placeholder: 'Ask the community something...' }
    };

    // Reaction config
    const REACTIONS = {
      appreciate: { icon: 'âœ¨', label: 'Appreciate' },
      thoughtful: { icon: 'ðŸ’­', label: 'Thoughtful' },
      helpful: { icon: 'ðŸŒ±', label: 'Helpful' },
      support: { icon: 'ðŸ’œ', label: 'Support' }
    };

    // Open community detail modal with posts
    function openCommunityModal(community, memberCount, isJoined) {
      const memberText = memberCount === 1 ? '1 member' : `${memberCount} members`;
      
      // Store for use in other functions
      currentCommunity = community;
      currentCommunityJoined = isJoined;
      currentPostType = 'thought';
      currentFilter = 'all';

      // Create modal if it doesn't exist
      let modal = document.getElementById('communityViewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'communityViewModal';
        modal.className = 'modal community-view';
        document.body.appendChild(modal);
      } else {
        modal.className = 'modal community-view';
      }

      const postTypeButtons = Object.entries(POST_TYPES).map(([type, config]) => 
        `<button class="post-type-btn ${type === 'thought' ? 'active' : ''}" data-type="${type}" onclick="selectPostType('${type}')">${config.icon} ${config.label}</button>`
      ).join('');

      modal.innerHTML = `
        <div class="modal-box">
          <button class="close-btn" onclick="closeCommunityModal()">âœ•</button>
          
          <div class="community-header">
            <div class="community-header-top">
              <div class="community-header-icon">${community.icon || 'ðŸ '}</div>
              <div class="community-header-info">
                <h2>${escapeHtml(community.name)}</h2>
                <div class="community-header-meta">
                  ${memberText} â€¢ ${escapeHtml(community.category || 'General')}
                  <button 
                    id="communityJoinBtnSmall"
                    onclick="${isJoined ? `leaveCommunityFromModal('${community.id}')` : `joinCommunityFromModal('${community.id}')`}"
                    style="margin-left: 12px; padding: 4px 12px; background: ${isJoined ? 'rgba(124,232,168,0.15)' : 'var(--bg-elevated)'}; border: 1px solid ${isJoined ? 'rgba(124,232,168,0.3)' : 'var(--border-subtle)'}; border-radius: var(--radius-full); color: ${isJoined ? 'var(--accent-green)' : 'var(--text-secondary)'}; font-size: 12px; cursor: pointer;"
                  >${isJoined ? 'âœ“ Joined' : 'Join'}</button>
                </div>
              </div>
            </div>
            ${community.description ? `<p class="community-header-desc">${escapeHtml(community.description)}</p>` : ''}
          </div>
          
          <div class="community-tabs">
            <button class="community-tab active" data-filter="all" onclick="filterPosts('all')">ðŸŒŸ All</button>
            <button class="community-tab" data-filter="thought" onclick="filterPosts('thought')">ðŸ’­ Thoughts</button>
            <button class="community-tab" data-filter="resource" onclick="filterPosts('resource')">ðŸ“š Resources</button>
            <button class="community-tab" data-filter="creation" onclick="filterPosts('creation')">âœ¨ Creations</button>
            <button class="community-tab" data-filter="lesson" onclick="filterPosts('lesson')">ðŸŽ“ Lessons</button>
            <button class="community-tab" data-filter="question" onclick="filterPosts('question')">â“ Questions</button>
          </div>
          
          <div class="community-body">
            ${isJoined ? `
              <div class="post-composer">
                <div class="post-type-selector">
                  ${postTypeButtons}
                </div>
                <input type="text" class="post-composer-title" id="postTitle" placeholder="Title (optional)" style="display: none;">
                <input type="text" class="post-composer-link" id="postLink" placeholder="Link URL (optional)" style="display: none;">
                <textarea id="postContent" placeholder="${POST_TYPES.thought.placeholder}"></textarea>
                <div class="post-composer-footer">
                  ${community.allow_anonymous_posts ? `
                    <label class="anon-toggle-row">
                      <input type="checkbox" id="postAnonymous">
                      <span>ðŸ‘¤ Post anonymously</span>
                    </label>
                  ` : `<span class="post-composer-hint">Take your time. No rush here. ðŸŒ™</span>`}
                  <button class="post-btn" onclick="createPost()">Share</button>
                </div>
              </div>
            ` : `
              <div class="lurk-mode-hint">
                ðŸ‘ï¸ Browsing mode â€” Join to share and interact
              </div>
            `}
            
            <div class="posts-feed" id="postsFeed">
              <div class="posts-empty">
                <div class="icon">ðŸ’­</div>
                <p>Loading posts...</p>
              </div>
            </div>
          </div>
        </div>
      `;

      modal.classList.add('active');
      
      // Load user's reactions and bookmarks, then posts
      loadUserInteractions(community.id).then(() => {
        loadCommunityPosts(community.id);
      });
    }

    // Select post type
    function selectPostType(type) {
      currentPostType = type;
      
      // Update buttons
      document.querySelectorAll('.post-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      
      // Update placeholder
      const textarea = document.getElementById('postContent');
      if (textarea) {
        textarea.placeholder = POST_TYPES[type].placeholder;
      }
      
      // Show/hide title and link fields based on type
      const titleInput = document.getElementById('postTitle');
      const linkInput = document.getElementById('postLink');
      
      if (titleInput) {
        titleInput.style.display = ['resource', 'lesson', 'creation'].includes(type) ? 'block' : 'none';
        titleInput.placeholder = type === 'lesson' ? 'What are you teaching?' : 
                                  type === 'creation' ? 'Title of your creation' : 
                                  'Title (optional)';
      }
      
      if (linkInput) {
        linkInput.style.display = type === 'resource' ? 'block' : 'none';
      }
    }

    // Filter posts by type
    function filterPosts(filter) {
      currentFilter = filter;
      
      // Update tab buttons
      document.querySelectorAll('.community-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      
      // Reload posts with filter
      if (currentCommunity) {
        loadCommunityPosts(currentCommunity.id);
      }
    }

    // Load user's reactions and bookmarks
    async function loadUserInteractions(communityId) {
      userReactions = {};
      userBookmarks = new Set();
      
      if (!db || !currentUser) return;
      
      try {
        // Get user's reactions for posts in this community
        const { data: reactions } = await db
          .from('post_reactions')
          .select('post_id, reaction')
          .eq('user_id', currentUser.id);
        
        if (reactions) {
          reactions.forEach(r => {
            if (!userReactions[r.post_id]) userReactions[r.post_id] = [];
            userReactions[r.post_id].push(r.reaction);
          });
        }
        
        // Get user's bookmarks
        const { data: bookmarks } = await db
          .from('post_bookmarks')
          .select('post_id')
          .eq('user_id', currentUser.id);
        
        if (bookmarks) {
          bookmarks.forEach(b => userBookmarks.add(b.post_id));
        }
      } catch (err) {
        console.log('Could not load user interactions:', err);
      }
    }

    // Load posts for a community
    async function loadCommunityPosts(communityId) {
      if (!db) return;
      
      const feed = document.getElementById('postsFeed');
      if (!feed) return;

      try {
        // Build query with optional filter
        let query = db
          .from('community_posts')
          .select('*')
          .eq('community_id', communityId)
          .order('is_pinned', { ascending: false })
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (currentFilter !== 'all') {
          query = query.eq('post_type', currentFilter);
        }
        
        const { data: posts, error } = await query;

        if (error) {
          console.error('Load posts error:', error);
          feed.innerHTML = `
            <div class="posts-empty">
              <div class="icon">âš ï¸</div>
              <p>Could not load posts</p>
            </div>
          `;
          return;
        }

        if (!posts || posts.length === 0) {
          const filterLabel = currentFilter === 'all' ? '' : POST_TYPES[currentFilter]?.label.toLowerCase() + ' ';
          feed.innerHTML = `
            <div class="posts-empty">
              <div class="icon">${currentFilter === 'all' ? 'ðŸŒ±' : POST_TYPES[currentFilter]?.icon || 'ðŸŒ±'}</div>
              <p>No ${filterLabel}posts yet</p>
              <p style="font-size: 13px; margin-top: 8px;">Be the first to share something!</p>
            </div>
          `;
          return;
        }

        // Get author profiles
        const authorIds = [...new Set(posts.map(p => p.author_id))];
        const { data: profiles } = await db
          .from('profiles')
          .select('id, username, avatar, avatar_emoji, avatar_bg, avatar_url')
          .in('id', authorIds);

        const profileMap = {};
        if (profiles) {
          profiles.forEach(p => { profileMap[p.id] = p; });
        }

        // Get reaction counts and comment counts for all posts
        const postIds = posts.map(p => p.id);
        
        const { data: allReactions } = await db
          .from('post_reactions')
          .select('post_id, reaction')
          .in('post_id', postIds);
        
        const { data: allComments } = await db
          .from('community_comments')
          .select('post_id')
          .in('post_id', postIds);
        
        // Aggregate reaction counts
        const reactionCounts = {};
        if (allReactions) {
          allReactions.forEach(r => {
            if (!reactionCounts[r.post_id]) reactionCounts[r.post_id] = {};
            reactionCounts[r.post_id][r.reaction] = (reactionCounts[r.post_id][r.reaction] || 0) + 1;
          });
        }
        
        // Aggregate comment counts
        const commentCounts = {};
        if (allComments) {
          allComments.forEach(c => {
            commentCounts[c.post_id] = (commentCounts[c.post_id] || 0) + 1;
          });
        }

        // Render posts
        feed.innerHTML = posts.map(post => {
          const isAnon = post.is_anonymous;
          const author = isAnon ? {} : (profileMap[post.author_id] || {});
          const avatar = isAnon ? 'ðŸ‘¤' : (author.avatar_emoji || author.avatar || 'ðŸŒ™');
          const avatarBg = isAnon ? 'var(--bg-elevated)' : (author.avatar_bg || 'var(--bg-elevated)');
          const avatarUrl = isAnon ? null : (author.avatar_url || null);
          const name = isAnon ? 'Anonymous' : (author.username || 'Anonymous');
          const time = formatMessageTime(post.created_at);
          const postType = post.post_type || 'thought';
          const typeConfig = POST_TYPES[postType] || POST_TYPES.thought;
          const postReactions = reactionCounts[post.id] || {};
          const postCommentCount = commentCounts[post.id] || 0;
          const isBookmarked = userBookmarks.has(post.id);
          const myReactions = userReactions[post.id] || [];

          return `
            <div class="post-card ${post.is_pinned ? 'pinned' : ''}" data-post-id="${post.id}">
              ${post.is_pinned ? '<span class="post-pin-badge">ðŸ“Œ Pinned</span>' : ''}
              <span class="post-type-badge ${postType}">${typeConfig.icon} ${typeConfig.label}</span>
              
              <div class="post-header">
                ${renderAvatarHtml(avatarUrl, avatar, avatarBg, 'post-avatar')}
                <div class="post-author-info">
                  <div class="post-author-name">${escapeHtml(name)}</div>
                  <div class="post-time">${time}</div>
                </div>
              </div>
              
              ${post.title ? `<h3 class="post-title">${escapeHtml(post.title)}</h3>` : ''}
              <div class="post-content">${escapeHtml(post.content)}</div>
              
              ${post.link_url ? `
                <a href="${escapeHtml(post.link_url)}" target="_blank" rel="noopener" class="post-link">
                  <span class="post-link-icon">ðŸ”—</span>
                  <span class="post-link-text">${escapeHtml(post.link_title || post.link_url)}</span>
                  <span class="post-link-domain">${getDomain(post.link_url)}</span>
                </a>
              ` : ''}
              
              ${post.image_url ? `<img src="${post.image_url}" class="post-image" alt="">` : ''}
              
              <div class="post-actions">
                ${Object.entries(REACTIONS).map(([key, config]) => {
                  const count = postReactions[key] || 0;
                  const isActive = myReactions.includes(key);
                  return `
                    <button class="reaction-btn ${isActive ? 'active' : ''}" 
                            onclick="toggleReaction('${post.id}', '${key}')"
                            title="${config.label}">
                      ${config.icon}${count > 0 ? ` <span class="count">${count}</span>` : ''}
                    </button>
                  `;
                }).join('')}
                
                <button class="comment-toggle" onclick="toggleComments('${post.id}')">
                  ðŸ’¬ ${postCommentCount > 0 ? postCommentCount : 'Reply'}
                </button>
                
                <span class="action-spacer"></span>
                
                <button class="bookmark-btn ${isBookmarked ? 'active' : ''}"
                        onclick="toggleBookmark('${post.id}')"
                        title="Save for later">
                  ${isBookmarked ? 'ðŸ”–' : 'ðŸ“‘'}
                </button>
                <button class="post-report-btn" onclick="reportPost('${post.id}')" title="Report this post">â‹¯</button>
              </div>
              
              <div class="comments-section" id="comments-${post.id}" style="display: none;"></div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load posts exception:', err);
        feed.innerHTML = `
          <div class="posts-empty">
            <div class="icon">âš ï¸</div>
            <p>Error loading posts</p>
          </div>
        `;
      }
    }

    // Get domain from URL
    function getDomain(url) {
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch {
        return '';
      }
    }

    // Toggle reaction on a post
    async function toggleReaction(postId, reaction) {
      if (!db || !currentUser) {
        showToast('Sign in to react');
        return;
      }
      
      const myReactions = userReactions[postId] || [];
      const hasReaction = myReactions.includes(reaction);
      
      try {
        if (hasReaction) {
          // Remove reaction
          await db
            .from('post_reactions')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', currentUser.id)
            .eq('reaction', reaction);
          
          userReactions[postId] = myReactions.filter(r => r !== reaction);
        } else {
          // Add reaction
          await db
            .from('post_reactions')
            .insert({
              post_id: postId,
              user_id: currentUser.id,
              reaction: reaction
            });
          
          if (!userReactions[postId]) userReactions[postId] = [];
          userReactions[postId].push(reaction);
        }
        
        // Refresh posts to update counts
        loadCommunityPosts(currentCommunity.id);
        
      } catch (err) {
        console.error('Toggle reaction error:', err);
      }
    }

    // Toggle bookmark on a post
    async function toggleBookmark(postId) {
      if (!db || !currentUser) {
        showToast('Sign in to save posts');
        return;
      }
      
      const isBookmarked = userBookmarks.has(postId);
      
      try {
        if (isBookmarked) {
          await db
            .from('post_bookmarks')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', currentUser.id);
          
          userBookmarks.delete(postId);
          showToast('Removed from saved');
        } else {
          await db
            .from('post_bookmarks')
            .insert({
              post_id: postId,
              user_id: currentUser.id
            });
          
          userBookmarks.add(postId);
          showToast('ðŸ”– Saved for later');
        }
        
        // Update the button
        const btn = document.querySelector(`.post-card[data-post-id="${postId}"] .bookmark-btn`);
        if (btn) {
          btn.classList.toggle('active', userBookmarks.has(postId));
          btn.textContent = userBookmarks.has(postId) ? 'ðŸ”–' : 'ðŸ“‘';
        }
        
      } catch (err) {
        console.error('Toggle bookmark error:', err);
      }
    }

    // Toggle comments section
    async function toggleComments(postId) {
      const section = document.getElementById(`comments-${postId}`);
      if (!section) return;
      
      const isVisible = section.style.display !== 'none';
      
      if (isVisible) {
        section.style.display = 'none';
        expandedComments.delete(postId);
      } else {
        section.style.display = 'block';
        expandedComments.add(postId);
        await loadComments(postId);
      }
    }

    // Load comments for a post
    async function loadComments(postId) {
      const section = document.getElementById(`comments-${postId}`);
      if (!section) return;
      
      section.innerHTML = '<div class="comments-empty">Loading comments...</div>';
      
      try {
        const { data: comments, error } = await db
          .from('community_comments')
          .select('*')
          .eq('post_id', postId)
          .is('parent_id', null) // Top-level only for now
          .order('created_at', { ascending: true })
          .limit(50);
        
        if (error) throw error;
        
        // Get author profiles
        const authorIds = [...new Set((comments || []).map(c => c.author_id))];
        let profileMap = {};
        
        if (authorIds.length > 0) {
          const { data: profiles } = await db
            .from('profiles')
            .select('id, username, avatar, avatar_emoji, avatar_bg, avatar_url')
            .in('id', authorIds);
          
          if (profiles) {
            profiles.forEach(p => { profileMap[p.id] = p; });
          }
        }
        
        section.innerHTML = `
          ${currentCommunityJoined ? `
            <div class="comment-composer">
              <input type="text" id="comment-input-${postId}" placeholder="Add a thoughtful reply..." 
                     onkeydown="if(event.key==='Enter') submitComment('${postId}')">
              <button class="comment-send-btn" onclick="submitComment('${postId}')">â†’</button>
            </div>
          ` : ''}
          <div class="comments-list" id="comments-list-${postId}">
            ${(!comments || comments.length === 0) ? `
              <div class="comments-empty">No comments yet. Be the first to share your thoughts!</div>
            ` : comments.map(comment => {
              const author = profileMap[comment.author_id] || {};
              const avatar = author.avatar_emoji || author.avatar || 'ðŸŒ™';
              const avatarBg = author.avatar_bg || 'var(--bg-elevated)';
              const avatarUrl = author.avatar_url || null;
              const name = author.username || 'Anonymous';
              const time = formatMessageTime(comment.created_at);
              
              return `
                <div class="comment">
                  ${renderAvatarHtml(avatarUrl, avatar, avatarBg, 'comment-avatar')}
                  <div class="comment-body">
                    <div class="comment-header">
                      <span class="comment-author">${escapeHtml(name)}</span>
                      <span class="comment-time">${time}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
      } catch (err) {
        console.error('Load comments error:', err);
        section.innerHTML = '<div class="comments-empty">Could not load comments</div>';
      }
    }

    // Submit a comment
    async function submitComment(postId) {
      if (!db || !currentUser) {
        showToast('Sign in to comment');
        return;
      }
      
      const input = document.getElementById(`comment-input-${postId}`);
      const content = input?.value?.trim();
      
      if (!content) return;
      
      try {
        const { error } = await db
          .from('community_comments')
          .insert({
            post_id: postId,
            author_id: currentUser.id,
            content: content
          });
        
        if (error) throw error;
        
        input.value = '';
        showToast('ðŸ’¬ Reply added');
        
        // Reload comments
        loadComments(postId);
        
        // Update comment count in the button
        loadCommunityPosts(currentCommunity.id);
        
      } catch (err) {
        console.error('Submit comment error:', err);
        showToast('Error adding reply');
      }
    }

    // Create a new post
    async function createPost() {
      if (!db || !currentUser || !currentCommunity) {
        showToast('âš ï¸ Please sign in to post');
        return;
      }

      if (!currentCommunityJoined) {
        showToast('âš ï¸ Join the community to post');
        return;
      }

      const textarea = document.getElementById('postContent');
      const titleInput = document.getElementById('postTitle');
      const linkInput = document.getElementById('postLink');
      
      const content = textarea?.value?.trim();
      const title = titleInput?.value?.trim() || null;
      const linkUrl = linkInput?.value?.trim() || null;

      if (!content) {
        showToast('âš ï¸ Write something to share');
        return;
      }

      if (content.length > 3000) {
        showToast('âš ï¸ Post is too long (max 3000 characters)');
        return;
      }

      // Disable button while posting
      const btn = document.querySelector('.post-btn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sharing...';
      }

      try {
        const isAnonymous = document.getElementById('postAnonymous')?.checked || false;
        const postData = {
          community_id: currentCommunity.id,
          author_id: currentUser.id,
          content: content,
          post_type: currentPostType,
          title: title,
          link_url: linkUrl,
          is_anonymous: isAnonymous
        };

        const { data, error } = await db
          .from('community_posts')
          .insert(postData)
          .select();

        if (error) {
          console.error('Create post error:', error);
          showToast('âš ï¸ Error creating post');
          return;
        }

        // Clear inputs
        if (textarea) textarea.value = '';
        if (titleInput) titleInput.value = '';
        if (linkInput) linkInput.value = '';
        
        showToast('âœ¨ Post shared!');
        
        // Reset filter to show all and reload
        currentFilter = 'all';
        document.querySelectorAll('.community-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.filter === 'all');
        });
        loadCommunityPosts(currentCommunity.id);

      } catch (err) {
        console.error('Create post exception:', err);
        showToast('âš ï¸ Error creating post');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Share';
        }
      }
    }

    function closeCommunityModal() {
      const modal = document.getElementById('communityViewModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Join from modal â€” routes through join overlay
    async function joinCommunityFromModal(communityId) {
      if (!db || !currentUser) {
        showToast('âš ï¸ Please sign in to join');
        return;
      }
      showJoinOverlay(communityId, true, null);
    }

    // _joinCommunityFromModalDirect is called by confirmJoin when fromModal=true
    async function _joinCommunityFromModalDirect(communityId) {
      try {
        currentCommunityJoined = true;
        showToast('ðŸ  Welcome to the community!');
        loadCommunities(); // Refresh the grid

        // Refresh the modal to show post composer
        if (currentCommunity && currentCommunity.id === communityId) {
          const { count: memberCount } = await db
            .from('community_members')
            .select('*', { count: 'exact', head: true })
            .eq('community_id', communityId);
          openCommunityModal(currentCommunity, memberCount || 0, true);
        }

      } catch (err) {
        console.error('Join error:', err);
        showToast('âš ï¸ Error joining community');
      }
    }

    // Leave from modal
    async function leaveCommunityFromModal(communityId) {
      if (!db || !currentUser) return;

      try {
        const { error } = await db
          .from('community_members')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('community_id', communityId);

        if (error) throw error;

        currentCommunityJoined = false;
        showToast('ðŸ‘‹ Left community');
        loadCommunities(); // Refresh the grid
        
        // Refresh the modal to hide post composer
        if (currentCommunity && currentCommunity.id === communityId) {
          const { count: memberCount } = await db
            .from('community_members')
            .select('*', { count: 'exact', head: true })
            .eq('community_id', communityId);
          openCommunityModal(currentCommunity, memberCount || 0, false);
        }

      } catch (err) {
        console.error('Leave error:', err);
        showToast('âš ï¸ Error leaving community');
      }
    }

    // View profile - open profile modal with message option
    async function viewProfile(id) {
      communitiesSearchResults.classList.remove('active');
      communitiesSearchInput.value = '';

      if (!db) return;

      try {
        const { data: profile, error } = await db
          .from('profiles')
          .select('*')
          .eq('id', id)
          .single();

        if (error || !profile) {
          showToast('Profile not found');
          return;
        }

        openProfileModal(profile);
      } catch (err) {
        console.error('View profile error:', err);
        showToast('Error loading profile');
      }
    }

    // Store pending profile data for message button (avoids XSS in onclick strings)
    let pendingMessageProfile = null;

    function messageFromProfile() {
      if (!pendingMessageProfile) return;
      const p = pendingMessageProfile;
      document.getElementById('profileViewModal').classList.remove('active');
      openConversation(p.id, p.username || 'Anonymous', p.avatar, p.avatarBg, p.avatarUrl);
    }

    function openProfileModal(profile) {
      let modal = document.getElementById('profileViewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'profileViewModal';
        modal.className = 'modal';
        modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });
        document.body.appendChild(modal);
      }

      const avatar = profile.avatar || profile.avatar_emoji || 'ðŸŒ™';
      const avatarBg = profile.avatar_bg || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      const avatarUrl = profile.avatar_url || null;
      const interests = profile.interests ? profile.interests.split(',').map(i => i.trim()).filter(Boolean) : [];

      // Store profile data safely instead of embedding in onclick
      pendingMessageProfile = {
        id: profile.id,
        username: profile.username || 'Anonymous',
        avatar: avatar,
        avatarBg: avatarBg,
        avatarUrl: avatarUrl
      };

      modal.innerHTML = `
        <div class="modal-box" style="max-width: 480px;">
          <button class="close-btn" onclick="document.getElementById('profileViewModal').classList.remove('active')">âœ•</button>
          <div class="modal-header">
            <div class="profile-view-card">
              ${renderAvatarHtml(avatarUrl, avatar, avatarBg, 'profile-view-avatar')}
              <div class="profile-view-name">${escapeHtml(profile.username || 'Anonymous')}</div>
              ${profile.tagline ? `<p style="font-size: 14px; color: var(--text-muted); font-style: italic; margin-bottom: 8px;">${escapeHtml(profile.tagline)}</p>` : ''}
            </div>
          </div>
          <div class="modal-body">
            ${profile.bio ? `<p class="profile-view-bio">${escapeHtml(profile.bio)}</p>` : ''}
            ${interests.length > 0 ? `
              <div class="profile-view-interests">
                ${interests.map(i => `<span class="interest">${escapeHtml(i)}</span>`).join('')}
              </div>
            ` : ''}
            <div class="profile-view-actions">
              <button class="submit-btn" onclick="messageFromProfile()">
                ðŸ’¬ Send Message
              </button>
            </div>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }

    // ========== AVATAR HELPER ==========
    function renderAvatarHtml(avatarUrl, avatarEmoji, avatarBg, cssClass) {
      const bg = avatarBg || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      const emoji = avatarEmoji || 'ðŸŒ™';
      if (avatarUrl) {
        return '<div class="' + cssClass + '" style="background:' + bg + '"><img src="' + avatarUrl + '" alt="" onerror="this.remove();this.parentElement.textContent=\'' + emoji.replace(/'/g, "\\'") + '\'"></div>';
      }
      return '<div class="' + cssClass + '" style="background: ' + bg + '">' + emoji + '</div>';
    }

    // ========== MESSAGING SYSTEM ==========
    let conversationsCache = [];
    let currentConvoUserId = null;
    let messagePollingInterval = null;
    let lastRenderedMsgCount = 0;
    let lastRenderedMsgId = null;
    let conversationProfiles = {};

    // Load conversations list
    async function loadConversations() {
      if (!db || !currentUser) return;

      const container = document.querySelector('.conversations');
      if (!container) return;

      try {
        // Get all messages involving current user, ordered by most recent
        const { data: messages, error } = await db
          .from('messages')
          .select('*')
          .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Load messages error:', error);
          return;
        }

        if (!messages || messages.length === 0) {
          container.innerHTML = `
            <div class="messages-empty">
              <div class="icon">ðŸ’¬</div>
              <h3>No messages yet</h3>
              <p style="color: var(--text-muted); margin-top: 8px;">Search for users and start a conversation!</p>
            </div>
          `;
          return;
        }

        // Group by conversation partner
        const convos = {};
        messages.forEach(msg => {
          const partnerId = msg.sender_id === currentUser.id ? msg.recipient_id : msg.sender_id;
          if (!convos[partnerId]) {
            convos[partnerId] = {
              partnerId,
              lastMessage: msg,
              unreadCount: 0
            };
          }
          if (msg.recipient_id === currentUser.id && !msg.read) {
            convos[partnerId].unreadCount++;
          }
        });

        conversationsCache = Object.values(convos);

        // Load partner profiles
        const partnerIds = Object.keys(convos);
        const { data: profiles } = await db
          .from('profiles')
          .select('id, username, avatar, avatar_emoji, avatar_bg, avatar_url')
          .in('id', partnerIds);

        const profileMap = {};
        if (profiles) {
          profiles.forEach(p => { profileMap[p.id] = p; });
        }

        // Render conversations
        container.innerHTML = conversationsCache.map(convo => {
          const profile = profileMap[convo.partnerId] || {};
          const avatar = profile.avatar_emoji || profile.avatar || 'ðŸŒ™';
          const avatarBg = profile.avatar_bg || 'var(--bg-elevated)';
          const avatarUrl = profile.avatar_url || null;
          const name = profile.username || 'Anonymous';
          const msgContent = convo.lastMessage.content || '';
          const preview = msgContent.length > 60
            ? msgContent.substring(0, 60) + '...'
            : msgContent;
          const time = formatMessageTime(convo.lastMessage.created_at);
          const isSent = convo.lastMessage.sender_id === currentUser.id;

          conversationProfiles[convo.partnerId] = { name, avatar, avatarBg, avatarUrl };

          return `
            <div class="conversation ${convo.unreadCount > 0 ? 'unread' : ''}"
                 onclick="openConversationById('${convo.partnerId}')">
              ${renderAvatarHtml(avatarUrl, avatar, avatarBg, 'convo-avatar')}
              <div class="convo-content">
                <div class="convo-header">
                  <span class="convo-name">${escapeHtml(name)}</span>
                  <span class="convo-time">${time}</span>
                </div>
                <div class="convo-preview">${isSent ? 'You: ' : ''}${escapeHtml(preview)}</div>
              </div>
              ${convo.unreadCount > 0 ? '<div class="unread-dot"></div>' : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load conversations exception:', err);
      }
    }

    // Open a conversation with a specific user
    async function openConversation(userId, userName, userAvatar, userAvatarBg, userAvatarUrl) {
      if (!db || !currentUser) {
        showToast('Please sign in to send messages');
        return;
      }

      currentConvoUserId = userId;

      // Switch to messages view
      switchView('messages');

      // Save active conversation to sessionStorage for persistence
      sessionStorage.setItem('activeConversation', JSON.stringify({
        userId, userName, userAvatar, userAvatarBg, userAvatarUrl
      }));

      // Replace messages section with conversation view
      const section = document.querySelector('.messages-section');
      section.innerHTML = `
        <div class="convo-view-header">
          <button class="back-btn" onclick="closeConversation()">â†</button>
          ${renderAvatarHtml(userAvatarUrl, userAvatar || 'ðŸŒ™', userAvatarBg || 'var(--bg-elevated)', 'convo-view-avatar')}
          <div class="convo-user-info">
            <div class="convo-user-name">${escapeHtml(userName)}</div>
            <div class="convo-user-status">Take your time responding</div>
          </div>
        </div>
        <div class="messages-list" id="messagesList">
          <div style="text-align: center; color: var(--text-muted); padding: 20px;">Loading...</div>
        </div>
        <div class="message-input-area">
          <input type="text" id="messageInput" placeholder="Write a message..." autocomplete="off"
                 onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
          <button class="send-btn" onclick="sendMessage()" title="Send">â†’</button>
        </div>
      `;

      // Reset message tracking for new conversation
      lastRenderedMsgCount = 0;
      lastRenderedMsgId = null;

      // Load messages for this conversation
      await loadMessages(userId);

      // Mark messages as read
      markAsRead(userId);

      // Start polling for new messages
      startMessagePolling(userId, userName, userAvatar, userAvatarBg);

      // Focus the input
      setTimeout(() => document.getElementById('messageInput')?.focus(), 100);
    }

    // Load messages for a conversation
    async function loadMessages(partnerId) {
      if (!db || !currentUser) return;

      const container = document.getElementById('messagesList');
      if (!container) return;

      try {
        const { data: messages, error } = await db
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${currentUser.id},recipient_id.eq.${partnerId}),and(sender_id.eq.${partnerId},recipient_id.eq.${currentUser.id})`)
          .order('created_at', { ascending: true })
          .limit(100);

        if (error) {
          console.error('Load messages error:', error);
          container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px;">Error loading messages</div>';
          return;
        }

        if (!messages || messages.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; color: var(--text-muted); padding: 60px 20px;">
              <div style="font-size: 40px; margin-bottom: 12px;">ðŸ’¬</div>
              <p>Start the conversation! No pressure to be witty.</p>
            </div>
          `;
          lastRenderedMsgCount = 0;
          lastRenderedMsgId = null;
          return;
        }

        // Skip re-render if nothing changed (prevents flicker during polling)
        const newestId = messages[messages.length - 1].id;
        if (messages.length === lastRenderedMsgCount && newestId === lastRenderedMsgId) {
          return;
        }
        lastRenderedMsgCount = messages.length;
        lastRenderedMsgId = newestId;

        container.innerHTML = messages.map(msg => {
          const isSent = msg.sender_id === currentUser.id;
          const time = formatMessageTime(msg.created_at);
          return `
            <div class="message-bubble ${isSent ? 'sent' : 'received'}">
              <div>${escapeHtml(msg.content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

      } catch (err) {
        console.error('Load messages exception:', err);
      }
    }

    // Send a message
    async function sendMessage() {
      if (!db || !currentUser || !currentConvoUserId) return;

      const input = document.getElementById('messageInput');
      if (!input) return;

      const content = input.value.trim();
      if (!content) return;

      input.value = '';

      try {
        const { data, error } = await db
          .from('messages')
          .insert({
            sender_id: currentUser.id,
            recipient_id: currentConvoUserId,
            content: content
          })
          .select();

        if (error) {
          console.error('Send message error:', error);
          showToast('Error sending message');
          input.value = content; // Restore on failure
          return;
        }

        // Add message to the list immediately
        const container = document.getElementById('messagesList');
        if (container) {
          // Remove empty state if present
          const emptyState = container.querySelector('div[style*="text-align: center"]');
          if (emptyState && container.children.length === 1) container.innerHTML = '';

          const time = formatMessageTime(new Date().toISOString());
          container.insertAdjacentHTML('beforeend', `
            <div class="message-bubble sent">
              <div>${escapeHtml(content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `);
          container.scrollTop = container.scrollHeight;
        }

      } catch (err) {
        console.error('Send message exception:', err);
        showToast('Error sending message');
      }
    }

    // Mark messages from a partner as read
    async function markAsRead(partnerId) {
      if (!db || !currentUser) return;

      try {
        await db
          .from('messages')
          .update({ read: true })
          .eq('sender_id', partnerId)
          .eq('recipient_id', currentUser.id)
          .eq('read', false);

        // Update unread badge
        loadUnreadCount();
      } catch (err) {
        console.error('Mark as read error:', err);
      }
    }

    // Poll for new messages in active conversation
    function startMessagePolling(userId, userName, userAvatar, userAvatarBg) {
      stopMessagePolling();
      messagePollingInterval = setInterval(async () => {
        if (currentConvoUserId !== userId) return;
        await loadMessages(userId);
        markAsRead(userId);
      }, 8000); // Poll every 8 seconds
    }

    function stopMessagePolling() {
      if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
        messagePollingInterval = null;
      }
    }

    // Open conversation by partner ID (safe from XSS)
    function openConversationById(partnerId) {
      const profile = conversationProfiles[partnerId];
      if (!profile) return;
      openConversation(partnerId, profile.name, profile.avatar, profile.avatarBg, profile.avatarUrl);
    }

    // Close conversation and return to list
    function closeConversation() {
      stopMessagePolling();
      currentConvoUserId = null;
      sessionStorage.removeItem('activeConversation');

      // Restore messages section HTML
      const section = document.querySelector('.messages-section');
      section.innerHTML = `
        <div class="async-banner">
          <div class="icon">ðŸ’¬</div>
          <div>
            <h4>Async-First Messaging</h4>
            <p>Take your time. No pressure to respond quickly â€” we all understand.</p>
          </div>
        </div>
        <div class="async-badges">
          <div class="async-badge"><span>ðŸ‘ï¸â€ðŸ—¨ï¸</span> No read receipts</div>
          <div class="async-badge"><span>âŒ¨ï¸</span> No typing indicators</div>
          <div class="async-badge"><span>ðŸŸ¢</span> No online status</div>
        </div>
        <div class="conversations">
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading conversations...</div>
        </div>
      `;

      loadConversations();
    }

    // Format message timestamp
    function formatMessageTime(isoStr) {
      const date = new Date(isoStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return diffMins + 'm ago';
      if (diffHours < 24) return diffHours + 'h ago';
      if (diffDays < 7) return diffDays + 'd ago';
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    // Keyboard navigation
    communitiesSearchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        communitiesSearchResults.classList.remove('active');
        this.blur();
      }
    });

    // Conversations now load from DOMContentLoaded after initAuth completes

    // ========== JOIN OVERLAY ==========
    let pendingJoinCommunityId = null;
    let pendingJoinFromModal = false;
    let pendingJoinBtn = null;
    let joinCountdownTimer = null;

    function showJoinOverlay(communityId, fromModal, btn) {
      if (!currentUser) {
        showToast('âš ï¸ Please sign in to join');
        return;
      }

      pendingJoinCommunityId = communityId;
      pendingJoinFromModal = fromModal;
      pendingJoinBtn = btn || null;

      const communityName = communityNames[communityId] || (currentCommunity && currentCommunity.id === communityId ? currentCommunity.name : 'this community');

      const overlay = document.createElement('div');
      overlay.className = 'join-overlay';
      overlay.id = 'joinOverlay';
      overlay.innerHTML = `
        <div class="join-overlay-card">
          <div class="join-overlay-title">ðŸŒ™ Joining ${escapeHtml(communityName)}</div>
          <div class="join-overlay-subtitle">How would you like to participate? (less than 5 seconds)</div>

          <div class="comfort-options">
            <button class="comfort-option" data-mode="lurk" onclick="selectComfortMode(this)">
              <span class="co-icon">ðŸ‘ï¸</span>
              <span>
                <div class="co-label">Just Lurk</div>
                <div class="co-desc">Read and observe â€” no pressure to engage</div>
              </span>
            </button>
            <button class="comfort-option selected" data-mode="occasional" onclick="selectComfortMode(this)">
              <span class="co-icon">ðŸ’¬</span>
              <span>
                <div class="co-label">Occasional Replies</div>
                <div class="co-desc">Share when something feels right</div>
              </span>
            </button>
            <button class="comfort-option" data-mode="active" onclick="selectComfortMode(this)">
              <span class="co-icon">ðŸ”Š</span>
              <span>
                <div class="co-label">Active Today</div>
                <div class="co-desc">Ready to participate more openly</div>
              </span>
            </button>
          </div>

          <div class="notif-section">
            <div class="notif-label">Notifications</div>
            <div class="notif-options">
              <button class="notif-option" data-level="off" onclick="selectNotifLevel(this)">Off</button>
              <button class="notif-option selected" data-level="important" onclick="selectNotifLevel(this)">Important only</button>
              <button class="notif-option" data-level="digest" onclick="selectNotifLevel(this)">Daily digest</button>
            </div>
          </div>

          <div class="join-overlay-actions">
            <button class="join-confirm-btn" onclick="confirmJoin(false)">Join Community</button>
            <button class="join-skip-link" id="joinSkipBtn" onclick="confirmJoin(true)">Skip â†’</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      // 5-second countdown on skip button
      if (joinCountdownTimer) clearInterval(joinCountdownTimer);
      let countdown = 5;
      const skipBtn = overlay.querySelector('#joinSkipBtn');
      joinCountdownTimer = setInterval(() => {
        countdown--;
        if (skipBtn) skipBtn.textContent = countdown > 0 ? `Skip (${countdown}s) â†’` : 'Skip â†’';
        if (countdown <= 0) { clearInterval(joinCountdownTimer); joinCountdownTimer = null; }
      }, 1000);
    }

    function selectComfortMode(btn) {
      document.querySelectorAll('#joinOverlay .comfort-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    function selectNotifLevel(btn) {
      document.querySelectorAll('#joinOverlay .notif-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    async function confirmJoin(useDefaults) {
      if (!db || !currentUser || !pendingJoinCommunityId) return;

      const comfortMode = useDefaults ? 'occasional'
        : (document.querySelector('#joinOverlay .comfort-option.selected')?.dataset.mode || 'occasional');
      const notifLevel = useDefaults ? 'important'
        : (document.querySelector('#joinOverlay .notif-option.selected')?.dataset.level || 'important');

      // Remove overlay
      if (joinCountdownTimer) { clearInterval(joinCountdownTimer); joinCountdownTimer = null; }
      const overlay = document.getElementById('joinOverlay');
      if (overlay) overlay.remove();

      const communityId = pendingJoinCommunityId;
      const fromModal = pendingJoinFromModal;
      const btn = pendingJoinBtn;

      try {
        await _insertMembership(communityId, comfortMode, notifLevel);

        if (fromModal) {
          await _joinCommunityFromModalDirect(communityId);
        } else {
          if (btn) {
            btn.classList.add('joined');
            btn.textContent = 'âœ“ Joined';
            btn.onclick = function(e) { e.stopPropagation(); leaveCommunity(communityId, btn); };
          }
          showToast('ðŸ  Welcome to the community!');
          setTimeout(() => loadCommunities(), 500);
        }
      } catch (err) {
        console.error('Join error:', err);
        showToast('âš ï¸ Error joining community');
      }
    }

    // ========== REPORT POST ==========
    function reportPost(postId) {
      if (!currentUser) {
        showToast('Sign in to report posts');
        return;
      }

      const reasons = [
        'Harmful or unsafe content',
        'Spam or repetitive posts',
        'Harassment or intimidation',
        'Off-topic or irrelevant',
        'Other concern'
      ];

      let dialog = document.getElementById('reportDialog');
      if (dialog) dialog.remove();

      dialog = document.createElement('div');
      dialog.id = 'reportDialog';
      dialog.className = 'report-dialog-overlay';
      dialog.innerHTML = `
        <div class="report-dialog">
          <h3>ðŸš© Report this post</h3>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 14px;">Your report is private. We take all reports seriously.</p>
          <div class="report-reason-options">
            ${reasons.map(r => `<button class="report-reason-btn" data-reason="${escapeHtml(r)}" onclick="submitReport('${postId}', this.dataset.reason)">${escapeHtml(r)}</button>`).join('')}
          </div>
          <button class="report-cancel-btn" onclick="document.getElementById('reportDialog').remove()">Cancel</button>
        </div>
      `;
      dialog.addEventListener('click', function(e) { if (e.target === this) this.remove(); });
      document.body.appendChild(dialog);
    }

    async function submitReport(postId, reason) {
      document.getElementById('reportDialog')?.remove();
      if (!db || !currentUser || !currentCommunity) return;

      try {
        await db.from('community_reports').insert({
          reporter_id: currentUser.id,
          post_id: postId,
          community_id: currentCommunity.id,
          reason: reason,
          status: 'open'
        });
        showToast('ðŸš© Report submitted â€” thank you.');
      } catch (err) {
        // Table may not exist yet if migration not applied
        console.log('Report error (table may not exist):', err.message);
        showToast('ðŸš© Report received.');
      }
    }
  </script>

</body>
</html>

